<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Cloudy with a chance of Big Data Blog Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Cloudy with a chance of Big Data Blog Feed Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4N6KSJ2G0P"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4N6KSJ2G0P",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloudy with a chance of Big Data" href="/opensearch.xml"><title data-react-helmet="true">17 posts tagged with &quot;google-cloud-platform&quot; | Cloudy with a chance of Big Data</title><meta data-react-helmet="true" property="og:title" content="17 posts tagged with &quot;google-cloud-platform&quot; | Cloudy with a chance of Big Data"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://cloudywithachanceofbigdata.com/tags/google-cloud-platform"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cloudywithachanceofbigdata.com/tags/google-cloud-platform"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.com/tags/google-cloud-platform" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.com/tags/google-cloud-platform" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.d8b73325.css">
<link rel="preload" href="/assets/js/runtime~main.bc775c5f.js" as="script">
<link rel="preload" href="/assets/js/main.3e8b65bb.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title">Cloudy with a chance of Big Data</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/tags">Topics</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/simplifying-large-cloudformation-templates-using-jsonnet">Simplifying Large CloudFormation Templates using Jsonnet</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/aws-deployments-with-cloudformation-and-gitlab-ci">Simplified AWS Deployments with CloudFormation and GitLab CI</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/from-wordpress-to-jamstack">From Wordpress to Jamstack</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/using-jsonnet-to-configure-multiple-environments">Using Jsonnet to Configure Multiple Environments</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/use-bigquery-to-trigger-cloud-run">Use BigQuery to trigger Cloud Run</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/azure-static-web-app-review">Azure Static Web App Review</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/introducing-the-metadata-hub-mdh">Introducing the Metadata Hub (MDH)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/masking-private-keys-in-ci-cd-pipelines-in-gitlab">Masking Private Keys in CI/CD Pipelines in GitLab</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/simple-tasker-configuration-driven-orchestration">Simple Tasker: Configuration driven orchestration</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/okta-admin-command-line-interface">Okta Admin Command Line Interface</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>17 posts tagged with &quot;google-cloud-platform&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/use-bigquery-to-trigger-cloud-run">Use BigQuery to trigger Cloud Run</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-19T00:00:00.000Z" itemprop="datePublished">June 19, 2021</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="http://2.gravatar.com/avatar/58faa98ad68138dd1997f828f00a882e?s=80" alt="Tom Klimovski"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Tom Klimovski</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Cloud Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>So you&#x27;re using BigQuery (BQ). It&#x27;s all set up and humming perfectly. Maybe now, you want to run an ELT job whenever a new table partition is created, or maybe you want to retrain your ML model whenever new rows are inserted into the BQ table.</p><p>In my previous article on <a href="https://cloudywithachanceofbigdata.com/eventarc-the-state-of-eventing-in-google-cloud/" target="_blank" rel="noopener noreferrer">EventArc</a>, we went through how Logging can help us create eventing-type functionality in your application. Let&#x27;s take it a step further and walk through how we can couple BigQuery and Cloud Run.</p><p>In this article you will learn how to</p><ul><li>Tie together BigQuery and Cloud Run</li><li>Use BigQuery&#x27;s audit log to trigger Cloud Run</li><li>With those triggers, run your required code</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="lets-go">Let&#x27;s go!<a aria-hidden="true" class="hash-link" href="#lets-go" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s create a temporary dataset within BigQuery named <code>tmp_bq_to_cr</code>.</p><p>In that same dataset, let&#x27;s create a table in which we will insert some rows to test our BQ audit log. Let&#x27;s grab some rows from a BQ public dataset to create this table:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> tmp_bq_to_cr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud_run_trigger </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> country_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> new_persons_vaccinated</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> population</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain">bigquery</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">covid19_open_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">covid19_open_data</span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> country_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;Australia&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">date</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021-05-31&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Following this, let&#x27;s run an insert query that will help us build our mock database trigger:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> tmp_bq_to_cr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud_run_trigger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;2021-06-18&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Australia&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now, in another browser tab let&#x27;s navigate to <a href="https://console.cloud.google.com/logs/query;query=bigquery.v2?_ga=2.187390252.-505923201.1592376029" target="_blank" rel="noopener noreferrer">BQ Audit Events</a> and look for our <code>INSERT INTO</code> event:</p><p><a target="_blank" href="/assets/files/bq-insert-event-69f31456522fd0a5d613b44c3a7171a9.png"><img alt="BQ-insert-event" src="/assets/images/bq-insert-event-69f31456522fd0a5d613b44c3a7171a9.png"></a></p><p>There will be several audit logs for any given BQ action. Only after a query is parsed does BQ know which table we want to interact with, so the initial log will, for e.g., not have the table name.</p><p>We don&#x27;t want any old audit log, so we need to ensure we look for a unique set of attributes that clearly identify our action, such as in the diagram above.</p><p>In the case of inserting rows, the attributes are a combination of</p><ul><li>The method is <code>google.cloud.bigquery.v2.JobService.InsertJob</code></li><li>The name of the table being inserted to is the <code>protoPayload.resourceName</code></li><li>The dataset id is available as <code>resource.labels.dataset_id</code></li><li>The number of inserted rows is <code>protoPayload.metadata.tableDataChanged.insertedRowsCount</code></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="time-for-some-code">Time for some code<a aria-hidden="true" class="hash-link" href="#time-for-some-code" title="Direct link to heading">â€‹</a></h2><p>Now that we&#x27;ve identified the payload that we&#x27;re looking for, we can write the action for Cloud Run. We&#x27;ve picked Python and Flask to help us in this instance. (<a href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/blogs/cloud_run/main.py" target="_blank" rel="noopener noreferrer">full code is on GitHub</a>).</p><p>First, let&#x27;s filter out the noise and find the event we want to process</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Gets the Payload data from the Audit Log</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;resource&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;labels&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;dataset_id&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;resource&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;labels&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;project_id&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tbl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;protoPayload&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;resourceName&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rows </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;protoPayload&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;metadata&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;tableDataChange&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;insertedRowsCount&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ds </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;cloud_run_tmp&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           tbl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">endswith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;tables/cloud_run_trigger&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> rows </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> create_agg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table created&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># if these fields are not in the JSON, ignore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ok&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now that we&#x27;ve found the event we want, let&#x27;s execute the action we need. In this example, we&#x27;ll aggregate and write out to a new table <code>created_by_trigger</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">create_agg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bigquery</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    CREATE OR REPLACE TABLE tmp_bq_to_cr.created_by_trigger AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">      count_name, SUM(new_persons_vaccinated) AS n</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    FROM tmp_bq_to_cr.cloud_run_trigger</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> query</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The Dockerfile for the container is simply a basic Python container into which we install Flask and the BigQuery client library:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly docker"><pre tabindex="0" class="prism-code language-docker codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">FROM python:3.9-slim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install Flask==1.1.2 gunicorn==20.0.4 google-cloud-bigquery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV APP_HOME /app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR $APP_HOME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY *.py ./</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD exec gunicorn --bind :$PORT main:app</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="now-we-cloud-run">Now we Cloud Run<a aria-hidden="true" class="hash-link" href="#now-we-cloud-run" title="Direct link to heading">â€‹</a></h2><p>Build the container and deploy it using a couple of gcloud commands:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">SERVICE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bq-cloud-run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">PROJECT</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">gcloud config get-value project</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CONTAINER</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;gcr.io/</span><span class="token string variable" style="color:#36acaa">${PROJECT}</span><span class="token string" style="color:#e3116c">/</span><span class="token string variable" style="color:#36acaa">${SERVICE}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud builds submit --tag </span><span class="token variable" style="color:#36acaa">${CONTAINER}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud run deploy </span><span class="token variable" style="color:#36acaa">${SERVICE}</span><span class="token plain"> --image </span><span class="token variable" style="color:#36acaa">$CONTAINER</span><span class="token plain"> --platform managed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="i-always-forget-about-the-permissions">I always forget about the permissions<a aria-hidden="true" class="hash-link" href="#i-always-forget-about-the-permissions" title="Direct link to heading">â€‹</a></h2><p>In order for the trigger to work, the Cloud Run service account will need the following permissions:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud projects add-iam-policy-binding </span><span class="token variable" style="color:#36acaa">$PROJECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --member</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;serviceAccount:service-</span><span class="token string variable" style="color:#36acaa">${PROJECT_NO}</span><span class="token string" style="color:#e3116c">@gcp-sa-pubsub.iam.gserviceaccount.com&quot;</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --role</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;roles/iam.serviceAccountTokenCreator&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud projects add-iam-policy-binding </span><span class="token variable" style="color:#36acaa">$PROJECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --member</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">serviceAccount:</span><span class="token variable" style="color:#36acaa">${SVC_ACCOUNT}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --role</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;roles/eventarc.admin&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="finally-the-event-trigger">Finally, the event trigger<a aria-hidden="true" class="hash-link" href="#finally-the-event-trigger" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud eventarc triggers create </span><span class="token variable" style="color:#36acaa">${SERVICE}</span><span class="token plain">-trigger </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --location </span><span class="token variable" style="color:#36acaa">${REGION}</span><span class="token plain"> --service-account </span><span class="token variable" style="color:#36acaa">${SVC_ACCOUNT}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --destination-run-service </span><span class="token variable" style="color:#36acaa">${SERVICE}</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --event-filters </span><span class="token assign-left variable" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">google.cloud.audit.log.v1.written </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --event-filters </span><span class="token assign-left variable" style="color:#36acaa">methodName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">google.cloud.bigquery.v2.JobService.InsertJob </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --event-filters </span><span class="token assign-left variable" style="color:#36acaa">serviceName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bigquery.googleapis.com</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Important to note here is that we&#x27;re triggering on <em>any</em> Insert log created by BQ That&#x27;s why in this action we had to filter these events based on the payload.</p><header><h1>Take it for a spin</h1></header><p>Now, try out the BigQuery -&gt; Cloud Run trigger and action. Go to the BigQuery console and insert a row or two:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> tmp_bq_to_cr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud_run_trigger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;2021-06-18&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Australia&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25000</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Watch as a new table called <code>created_by_trigger</code> gets created! You have successfully triggered a Cloud Run action on a database event in BigQuery.</p><p>Enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/big-query">big-query</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bigquery">bigquery</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Use BigQuery to trigger Cloud Run" href="/use-bigquery-to-trigger-cloud-run"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/introducing-the-metadata-hub-mdh">Introducing the Metadata Hub (MDH)</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-15T00:00:00.000Z" itemprop="datePublished">June 15, 2021</time> Â· <!-- -->10 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="http://2.gravatar.com/avatar/58faa98ad68138dd1997f828f00a882e?s=80" alt="Tom Klimovski"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Tom Klimovski</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Cloud Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Metadata Hub (MDH) is intended to be the source of truth for metadata around the Companyâ€™s platform. It has the ability to load metadata configuration from yaml, and serve that information up via API. It will also be the store of information for pipeline information while ingesting files into the platform.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="key-philosophies">Key philosophies:<a aria-hidden="true" class="hash-link" href="#key-philosophies" title="Direct link to heading">â€‹</a></h2><blockquote><p><strong>Config-Driven</strong>. Anyone who has been authorized to do so, should be able to add another â€˜table-info.yamlâ€™ in to MDH without the need to update any code in the system</p></blockquote><p>Hereâ€™s how table information makes its way into MDH:  </p><figure><a href="/assets/images/mdhoverview-f1928d2566e120de80d74538c4e8a0bc.png"><img src="/assets/images/mdhoverview-f1928d2566e120de80d74538c4e8a0bc.png" alt="Metadata Hub"></a><figcaption class="figure-caption">Metadata Hub</figcaption></figure><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="paths">Paths<a aria-hidden="true" class="hash-link" href="#paths" title="Direct link to heading">â€‹</a></h3><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>/tables</td><td>get:</td><td>summary: All tables in MDH</td><td>description: get the title of all tables that exist in MDH</td></tr><tr><td></td><td>post:</td><td>summary: Creates a new table in MDH</td><td>description: Creates a new table in MDH</td></tr><tr><td>/tables/{id}</td><td>get</td><td>summary: Obtain information about specific table</td><td></td></tr><tr><td>/tables/{id}/columns</td><td>get</td><td>summary: All columns for a particular table</td><td>description: Obtain information on columns for a particular table</td></tr><tr><td>/run</td><td>get</td><td>summary: All information about a particular end-to-end batch run of file ingestion</td><td></td></tr><tr><td></td><td>post</td><td>summary: Update metadata on a batch load</td><td>description: Update metadata on a batch load</td></tr><tr><td>/calendar</td><td>get</td><td>summary: Use this to save on calculation of business days.</td><td>description: This base response gives you today&#x27;s date in a string</td></tr><tr><td>/calendar/previousBusinessDay</td><td>get</td><td>summary: Will return a string of the previous business day</td><td>description: Will return a string of the previous business day, based on the date on when it&#x27;s called</td></tr><tr><td>/calendar/nextBusinessDay</td><td>get</td><td>summary: Will return a string of the next business day</td><td>description: Will return a string of the next business day, based on the date on when it&#x27;s called</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><header><h1>Yaml to Datastore - Entity/Kind design</h1></header><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="datastore-primer">Datastore Primer<a aria-hidden="true" class="hash-link" href="#datastore-primer" title="Direct link to heading">â€‹</a></h3><p>Before we jump right into Entity Groups in Datastore, it is important to first go over the basics and establish a common vocabulary. Datastore holds entities, which are objects, that can contain various key/value pairs, called properties. Each entity must contain a unique identifier, known as a key. When creating an entity, a user can choose to specify a custom key or let Datastore create a key. If a user decides to specify a custom key, it will contain two fields: a kind, which represents a category such as â€˜Toyâ€™ or â€˜Marital Statusâ€™, and a name, which is the identifying value. If a user decides to only specify a kind when creating a key, and does not specify a unique identifier, Datastore automatically generates an ID behind the scenes. Below is an example of a Python3 script which illustrates this identifier concept.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> datastore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#Custom key- specify my kind=item and a unique_id of broker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">custom_key_entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Entity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">custom_key_entry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#Only specify kind=item, let datastore generate unique_id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">datastore_gen_key_entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Entity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">datastore_gen_key_entry</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In your GCP Console under Datastore, you will then see your two entities of kind â€œtableâ€. One will contain your custom key and one will contain the automatically generated key.</p><p>Ancestors and Entity Groups</p><p>For highly related or hierarchical data, Datastore allows entities to be stored in a parent/child relationship. This is known as an entity group or ancestor/descendent relationship.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="entity-group">Entity Group<a aria-hidden="true" class="hash-link" href="#entity-group" title="Direct link to heading">â€‹</a></h3><p><a target="_blank" href="/assets/files/erd-cce67b2304769e80a2dffce456462194.png"><img alt="erd" src="/assets/images/erd-cce67b2304769e80a2dffce456462194.png"></a></p><p><em>This is an example of an entity group with kinds of types: table, column, and classification. The â€˜Grandparentâ€™ in this relationship is the â€˜tableâ€™. In order to configure this, one must first create the table entity. Then, a user can create a column, and specify that the parent is a table key. In order to create the grandchild, a user then creates a classification and sets its parent to be a column key. To further add customizable attributes, a user can specify additional key-value pairs such as pii and data_type. These key-value pairs are stored as properties. We model this diagram in Datastore in our working example below.</em></p><p>One can create entity groups by setting the â€˜parentâ€™ parameter while creating an entity key for a child. This command adds the parent key to be part of the child entity key. The childâ€™s key is represented as a tuple (â€˜parent_keyâ€™, â€˜child_keyâ€™), such that the parentsâ€™ key is the prefix of the key, which is followed by its own unique identifier. For example, follow the diagram above:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">table_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">column_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;broker_legal_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parent</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">table_key</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Printing the variable <code>table_key</code> will display: <code>(&quot;table&quot;, &quot;broker&quot;,&quot;column&quot;, &quot;broker_legal_name&quot;)</code></p><p>Datastore also supports chaining of parents, which can lead to very large keys for descendants with a long lineage of ancestors. Additionally, parents can have multiple children (representing a one-to-many relationship). However, there is no native support for entities to have multiple parents (representing a many-to-many relationship). Once you have configured this ancestral hierarchy, it is easy to retrieve all descendants for a given parent. You can do this by querying on the parent key by using the â€˜ancestorâ€™ parameter. For example, given the entity table_key created above, I can query for all of the tables</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">columns</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my_query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ancestor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> column_key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>A Full Working Example for MDH</h1></header><p>As per our Key Philosophies - <strong><em>Config-Driven</em></strong> - anyone should be able to add a new <code>table</code> to be processed and landed in a target-table somewhere within MDH with our yaml syntax. Below is a full working python3 example of the table/column/classification hierarchical model described above.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> datastore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">datastore_client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Entities with kinds- table, column, classification</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_entities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;snapshot&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;notes&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;describes mortgage brokers&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_legal_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;data_type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;string&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;nullable&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_short_code&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;data_type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;string&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;nullable&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;classif_id_REQ_01&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;restriction_level&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pii&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;if&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;greater than 90 days&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_legal_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;classif_id_REQ_03&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;restriction_level&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;restricted&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pii&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;if&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;less than 90 days&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_legal_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;classif_id_REQ_214&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;restriction_level&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pii&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_short_code&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># traverse my_entities, set parents and add those to datastore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> entity </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> my_entities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entity</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;kind&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    parent_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> kind </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        parent_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> entity</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> kind </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        parent_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> entity</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          </span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> entity</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> entity</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kind</span><span class="token operator" style="color:#393A34">+</span><span class="token string" style="color:#e3116c">&quot;_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        parent</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">parent_key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    datastore_entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Entity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    datastore_entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Saving: {}&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">datastore_entry</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The code above assumes that youâ€™ve set yourself up with a working Service Account or authorised yourself in, and that your GCP project has been set.</p><p>Now letâ€™s do some digging around our newly minted Datastore model. Letâ€™s grab the column â€˜broker_legal_nameâ€™</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">query1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">query1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;=&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_legal_name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now that we have the column entity, letâ€™s locate itâ€™s parent id.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">column </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;This column belongs to: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">column</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id_or_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Further to this, we can also get all data classification elements attributed to a single column using the ancestor clause query.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">query2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ancestor</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">column</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> classification </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classification</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classification</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;restriction_level&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For more complex queries, Datastore has the concept of indexes being set, usually via itâ€™s index.yaml configuration. The following is an example of an <code>index.yaml</code> file:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">indexes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ancestor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">properties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> age</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">direction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">properties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">direction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> asc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> whiskers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">direction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ancestor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">properties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> business</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">direction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> asc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> owner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">direction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> asc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Indexes are important when attempting to add filters on more than one particular attribute within a Datastore entity. For example, the following code will fail:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Adding a &#x27;&gt;&#x27; filter will cause this to fail. Sidenote; it will work</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># without an index if you add another &#x27;=&#x27; filter.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">query2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ancestor</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">column</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">query2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pii&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> classification </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classification</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classification</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;classification_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To rectify this issue, you need to create an index.yaml that looks like the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">indexes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> classification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ancestor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">properties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pii</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You would usually upload the yaml file using the gcloud commands:</p><p><code>gcloud datastore indexes create path/to/index.yaml.</code></p><p>However, letâ€™s do this programmatically.</p><p>The official pypi package for google-cloud-datastore can be found here: <a href="https://pypi.org/project/google-cloud-datastore/" target="_blank" rel="noopener noreferrer">https://pypi.org/project/google-cloud-datastore/</a>. At the time of writing, Firestore in Datastore-mode will be the way forward, as per the release note from January 31, 2019.</p><blockquote><p>Cloud Firestore is now Generally Available. Cloud Firestore is the new version of Cloud Datastore and includes a backwards-compatible Datastore mode.</p></blockquote><blockquote><p>If you intend to use the Cloud Datastore API in a new project, use Cloud Firestore in Datastore mode. Existing Cloud Datastore databases will be automatically upgraded to Cloud Firestore in Datastore mode.</p></blockquote><blockquote><p>Except where noted, the Cloud Datastore documentation now describes behavior for Cloud Firestore in Datastore mode.</p></blockquote><p>Weâ€™ve purposefully created MDH in Datastore to show you how it was done originally, and weâ€™ll be migrating the Datastore code to Firestore in an upcoming post.</p><p>Creating and deleting indexes within Datastore will need to be done through the REST API via googleapiclient.discovery, as this function doesnâ€™t exist via the google-cloud-datastore API. Working with the discovery api client can be a bit daunting for a first-time user, so hereâ€™s the code to add an index on Datastore:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oauth2 </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> service_account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> googleapiclient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">discovery </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> datastore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SCOPES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;https://www.googleapis.com/auth/cloud-platform&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_ACCOUNT_FILE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;GOOGLE_APPLICATION_CREDENTIALS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PROJECT_ID </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;PROJECT_ID&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">credentials </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> service_account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_service_account_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SERVICE_ACCOUNT_FILE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scopes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">SCOPES</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">datastore_api </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;datastore&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;v1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> credentials</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">credentials</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;ancestor&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ALL_ANCESTORS&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;kind&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;classification&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;properties&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;name&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;pii&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;direction&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;DESCENDING&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">projects</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">indexes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">projectId</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">PROJECT_ID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>How did we craft this API request? We can use the Google API Discovery Service to build client libraries, IDE plugins, and other tools that interact with Google APIs. The Discovery API provides a list of Google APIs and a machine-readable &quot;Discovery Document&quot; for each API. Features of the Discovery API:</p><ul><li>A directory of supported APIs schemas based on JSON Schema.</li><li>A machine-readable &quot;Discovery Document&quot; for each of the supported APIs. Each document contains:</li><li>A list of API methods and available parameters for each method.</li><li>A list of available OAuth 2.0 scopes.</li><li>Inline documentation of methods, parameters, and available parameter values.</li></ul><p>Navigating to the API reference page for Datastore and going to the â€˜Datastore Adminâ€™ API page, we can see references to the Indexes and RESTful endpoints we can hit for those Indexes. Therefore, looking at the link for the Discovery document for Datastore:</p><blockquote><p><a href="https://datastore.googleapis.com/$discovery/rest?version=v1" target="_blank" rel="noopener noreferrer">https://datastore.googleapis.com/$discovery/rest?version=v1</a></p></blockquote><p>From this, we can build out our instantiation for the google api discovery object build(&#x27;datastore&#x27;, &#x27;v1&#x27;, credentials=credentials)</p><p>With respect to building out the body aspect of the request, Iâ€™ve found crafting that part within the â€˜Try this APIâ€™ section of <code>https://cloud.google.com/datastore/docs/reference/admin/rest/v1/projects.indexes/create</code> pretty valuable.</p><p>With this code, your index should show up in your Datastore console! You can also retrieve them within gcloud with gcloud datastore indexes list if youâ€™d like to verify the indexes outside our python code. So there you have it: a working example of entity groups, ancestors, indexes and Metadata within Datastore. Have fun coding!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/metadata">metadata</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Introducing the Metadata Hub (MDH)" href="/introducing-the-metadata-hub-mdh"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/eventarc-the-state-of-eventing-in-google-cloud">EventArc: The state of eventing in Google Cloud</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-02-28T00:00:00.000Z" itemprop="datePublished">February 28, 2021</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="http://2.gravatar.com/avatar/58faa98ad68138dd1997f828f00a882e?s=80" alt="Tom Klimovski"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Tom Klimovski</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Cloud Engineer</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/service-mesh-1.png"><div class="markdown" itemprop="articleBody"><p>When defining event-driven architectures, it&#x27;s always good to keep up with how the landscape is changing. How do you connect microservices in your architecture? Is Pub/Sub the end-game for all events? To dive a bit deeper, let&#x27;s talk through the benefits of having a singleÂ <em>orchestrator</em>, or perhaps a choreographer is better?</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="orchestration-versus-choreography-refresher">Orchestration versus choreography refresher<a aria-hidden="true" class="hash-link" href="#orchestration-versus-choreography-refresher" title="Direct link to heading">â€‹</a></h2><p>My colleague <a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer">@jeffreyaven</a> did a recent post explaining this concept in simple terms, which is worth reviewing, see:</p><p><a href="https://cloudywithachanceofbigdata.com/microservices-concepts-orchestration-versus-choreography/" target="_blank" rel="noopener noreferrer"><strong>Microservices Concepts: Orchestration versus Choreography</strong></a></p><p>Should there really be a central orchestrator controlling all interactions between services.....or, should each service work independently and only interact through events?</p><ul><li><strong>Orchestration</strong>Â is usually viewed as a domain-wide central service that defines the flow and control of communication between services. In this paradigm, in becomes easier to change and ultimately monitor policies across your org.</li><li><strong>Choreography</strong>Â has each service registering and emitting events as they need to. It doesn&#x27;t direct or define the flow of communication, but using this method usually has a central broker passing around messages and allows services to be truly independent.</li></ul><p>EnterÂ <a href="https://cloud.google.com/workflows" target="_blank" rel="noopener noreferrer">Workflows</a>, which is suited for centrally orchestrated services. Not only Google Cloud service such as Cloud Functions and Cloud Run, but also external services.</p><p>How about choreography?Â <a href="https://cloud.google.com/pubsub" target="_blank" rel="noopener noreferrer">Pub/Sub</a>Â andÂ <a href="https://cloud.google.com/blog/products/serverless/build-event-driven-applications-in-cloud-run" target="_blank" rel="noopener noreferrer">Eventarc</a>Â are both suited for this. We all know and love Pub/Sub,Â <em>but how do I use EventArc?</em></p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="what-is-eventarc">What is Eventarc?<a aria-hidden="true" class="hash-link" href="#what-is-eventarc" title="Direct link to heading">â€‹</a></h2><p>Announced in October-2020, it was introduced as eventing functionality that enables you, the developer, to send eventsÂ <em>to</em>Â Cloud Run from more than 60 Google Cloud sources.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="but-how-does-it-work">But how does it work?<a aria-hidden="true" class="hash-link" href="#but-how-does-it-work" title="Direct link to heading">â€‹</a></h3><p>Eventing is done by reading those sweet sweet Audit Logs, from various sources, and sending them to Cloud Run services as events inÂ <a href="https://cloudevents.io/" target="_blank" rel="noopener noreferrer">Cloud Events</a>Â format. Quick primer on Cloud Events: its a specification for describing event data in a common way. The specification is now under theÂ <a href="https://cncf.io/" target="_blank" rel="noopener noreferrer">Cloud Native Computing Foundation</a>. Hooray! It can also read events from Pub/Sub topics for custom applications. Here&#x27;s a diagram I graciously ripped fromÂ <a href="https://cloud.google.com/blog/topics/developers-practitioners/eventarc-unified-eventing-experience-google-cloud" target="_blank" rel="noopener noreferrer">Google Cloud Blog</a>:</p><p><a target="_blank" href="/assets/files/CloudEvents_fig1-4783f065699c51da51533f449993da71.png"><img alt="Eventarc" src="/assets/images/CloudEvents_fig1-4783f065699c51da51533f449993da71.png"></a></p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="why-do-i-need-eventarc-i-have-the-pubsub">Why do I need Eventarc? I have the Pub/Sub<a aria-hidden="true" class="hash-link" href="#why-do-i-need-eventarc-i-have-the-pubsub" title="Direct link to heading">â€‹</a></h3><p>Good question. Eventarc provides and easier path to receive events not only from Pub/Sub topics but from a number of Google Cloud sources with its Audit Log and Pub/Sub integration. Actually,Â <em>any</em>Â service that has Audit Log integration can be an event source for Eventarc. Beyond easy integration, it provides consistency and structure to how events are generated, routed and consumed. Things like:</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="triggers"><strong>Triggers</strong><a aria-hidden="true" class="hash-link" href="#triggers" title="Direct link to heading">â€‹</a></h4><p>They specify routing rules from events sources, to event sinks. Listen for new object creation in GCS and route that event to a service in Cloud Run by creating an Audit-Log-Trigger. Create triggers that also listen to Pub/Sub. Then listÂ <strong>all</strong>Â triggers in one, central place in Eventarc:</p><p><code>gcloud beta eventarc triggers list</code></p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="consistency-with-eventing-format-and-libraries"><strong>Consistency with eventing format and libraries</strong><a aria-hidden="true" class="hash-link" href="#consistency-with-eventing-format-and-libraries" title="Direct link to heading">â€‹</a></h4><p>Using the CloudEvent-compliant specification will allow for event data in a common way, increasing the movement towards the goal of consistency, accessibility and portability. Makes it easier for different languages to read the event and Google Events Libraries to parse fields.</p><p>This means that the long-term vision of Eventarc to be theÂ <strong>hub</strong>Â of events, enabling a unified eventing story for Google Cloud and beyond.</p><p><a target="_blank" href="/assets/files/CloudEvents_fig2-5aa5db31489216065557e5f35995b461.png"><img alt="Eventarc producers and consumers" src="/assets/images/CloudEvents_fig2-5aa5db31489216065557e5f35995b461.png"></a></p><p>In the future, you can excpect to forego Audit Log and read these events directly and send these out to even more sinks within GCP and any HTTP target.</p><hr><p>This article written on inspiration fromÂ <a href="https://cloud.google.com/blog/topics/developers-practitioners/eventarc-unified-eventing-experience-google-cloud" target="_blank" rel="noopener noreferrer">https://cloud.google.com/blog/topics/developers-practitioners/eventarc-unified-eventing-experience-google-cloud</a>. Thanks Mete Atamel!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/eventarc">eventarc</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/microservices">microservices</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about EventArc: The state of eventing in Google Cloud" href="/eventarc-the-state-of-eventing-in-google-cloud"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/multi-cloud-diagramming-with-plantuml">Multi Cloud Diagramming with PlantUML</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-10-26T00:00:00.000Z" itemprop="datePublished">October 26, 2020</time> Â· <!-- -->One min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/multicloud.png"><div class="markdown" itemprop="articleBody"><p>Following on from the recent post <a href="https://cloudywithachanceofbigdata.com/gcp-templates-for-c4-diagrams-using-plantuml/" target="_blank" rel="noopener noreferrer">GCP Templates for C4 Diagrams using PlantUML</a>, cloud architects are often challenged with producing diagrams for architectures spanning multiple cloud providers, particularly as you elevate to enterprise level diagrams.</p><p>In this post, with the magic of <code>!includeurl</code> we have brought PlantUML template libraries together for AWS, Azure and GCP icon sets, allowing us to produce multi cloud C4 diagrams using PlantUML like this one:</p><p><a target="_blank" href="/assets/files/Example-Multi-Cloud-PlantUML-C4-Diagram-8695466addda79c4432fca63824ab2eb.png"><img alt="Multi Cloud Architecture Diagram using PlantUML" src="/assets/images/Example-Multi-Cloud-PlantUML-C4-Diagram-8695466addda79c4432fca63824ab2eb.png"></a></p><p>Creating a multi cloud diagram is simple, start by adding the following <code>include</code> statements after the <code>@startuml</code> label in a new PlantUML C4 diagram:</p><iframe width="100%" frameborder="0" id="gist-5319b6b041f8b8f54c922a9a5b9b6e7c"></iframe><p>Then add references to the required services from different providersâ€¦</p><iframe width="100%" frameborder="0" id="gist-6ed55cd1b4e3b2e7027f8236af4aa112"></iframe><p>Then include the predefined resources from your different cloud providers in your diagram as shown here (describing a client server application over a cloud to cloud VPN between Azure and GCP)...</p><iframe width="100%" frameborder="0" id="gist-600aecff7094d7843771770b7048cb2c"></iframe><p>Happy multi-cloud diagramming!</p><blockquote><p>Full source code is available at:</p><p><a href="https://github.com/gamma-data/plantuml-multi-cloud-diagrams" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/plantuml-multi-cloud-diagrams</a></p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/amazonwebservices">amazonwebservices</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/aws">aws</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure">azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/c-4-model">c4model</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/diagramming">diagramming</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/microsoft-azure">microsoft-azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/multi-cloud">multi-cloud</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/plantuml">plantuml</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/software-architecture">software-architecture</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Multi Cloud Diagramming with PlantUML" href="/multi-cloud-diagramming-with-plantuml"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/cloud-bigtable-primer-part-ii-row-key-selection-and-schema-design">Cloud Bigtable Primer Part II â€“ Row Key Selection and Schema Design</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-09-13T00:00:00.000Z" itemprop="datePublished">September 13, 2020</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cbt-featured-image.png"><div class="markdown" itemprop="articleBody"><p>This is a follow up to the original Cloud Bigtable primer where we discussed the basics of Cloud Bigtable:</p><p><a href="https://cloudywithachanceofbigdata.com/cloud-bigtable-primer-part-i/" target="_blank" rel="noopener noreferrer"><strong>Cloud Bigtable Primer - Part I</strong></a></p><p>In this article we will cover schema design and row key selection in Bigtable â€“ arguably the most critical design decision to make when employing Bigtable in a cloud data architecture.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="quick-review">Quick Review<a aria-hidden="true" class="hash-link" href="#quick-review" title="Direct link to heading">â€‹</a></h2><p>Recall from the previous post where the Bigtable data model was introduced that tables in Bigtable are comprised of rows and columns - much like a table in any other RDBMS. Every row is uniquely identified by a rowkey â€“ again akin to a primary key in a table in an RDBMS. But this is where the similarities end.</p><p>Unlike a table in an RDBMS, columns only ever exist when they are inserted, and <code>NULLs</code> are not stored. See the illustration below:</p><p><a target="_blank" href="/assets/files/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png"><img src="/assets/images/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="row-key-selection">Row Key Selection<a aria-hidden="true" class="hash-link" href="#row-key-selection" title="Direct link to heading">â€‹</a></h2><p>Data in Bigtable is distributed by row keys. Row keys are physically stored in tablets in lexographic order. Recall that row keys are your ONLY indexes to data in Bigtable.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="selection-considerations">Selection Considerations<a aria-hidden="true" class="hash-link" href="#selection-considerations" title="Direct link to heading">â€‹</a></h3><p>As row keys are your only indexes to retrieve or update rows in Bigtable, row key design must take the access patterns for the data to be stored and served via Bigtable into consideration, specifically the following must be considered when designing a Bigtable application:</p><ul><li>Search patterns (returning data for a specific entity)</li><li>Scan patterns (returning batches of data)</li></ul><p>Queries that use the row key, a row prefix, or a row range are the most efficient. Queries that do not include a row key will typically scan GB or TB of data and would not be suitable for operational use cases.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="row-key-performance">Row Key Performance<a aria-hidden="true" class="hash-link" href="#row-key-performance" title="Direct link to heading">â€‹</a></h3><p>Row key performance will be biased towards your specific access patterns and application functional requirements. For example if you are performing sequential reads or scan operations then sequential keys will perform the best, however their write performance will not be optimal. Conversely, random keys (such as a <code>uuid</code>) will perform best for writes but poor for scan or sequential read operations.</p><p>Adding salts to keys (or additional data), similar to the use of salts in cryptography as well as promoting other field keys to be part of a composite row key can help achieve a â€œGoldilocksâ€ scenario for both reads and writes, see the diagram below:</p><p><a target="_blank" href="/assets/files/keys-418e33748532e78f24865d6aad4c8ac4.png"><img src="/assets/images/keys-418e33748532e78f24865d6aad4c8ac4.png"></a></p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="using-reverse-timestamps">Using Reverse Timestamps<a aria-hidden="true" class="hash-link" href="#using-reverse-timestamps" title="Direct link to heading">â€‹</a></h3><p>Use reverse timestamps when your most common query is for the latest values. Typically you would append the reverse timestamp to the key, this will ensure that the same related records are grouped together, for instance if you are storing events for a customer using the customer id along with an appended reverse timestamp (for example <code>&lt;customer_id&gt;#&lt;reverse_ts&gt;</code>) would allow you to quickly serve the latest events for a customer in descending order as within each group (<code>customer_id</code>), rows will be sorted so most recent insert will be located at the top.<br>
<!-- -->A reverse timestamp can be generalised as:</p><p><code>Long.MAX_VALUE - System.currentTimeMillis()</code></p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="schema-design-tips">Schema Design Tips<a aria-hidden="true" class="hash-link" href="#schema-design-tips" title="Direct link to heading">â€‹</a></h3><p>Some general tips for good schema design using Bigtable are summarised below:</p><ul><li>Group related data for more efficient reads using column families</li><li>Distribute data evenly for more efficient writes</li><li>Place identical values in the adjoining rows for more efficient compression using row keys</li></ul><p>Following these tips will give you the best possible performance using Bigtable.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="use-the-key-visualizer-to-profile-performance">Use the Key Visualizer to profile performance<a aria-hidden="true" class="hash-link" href="#use-the-key-visualizer-to-profile-performance" title="Direct link to heading">â€‹</a></h3><p>Google provides a neat tool to visualize your row key distribution in Cloud Bigtable. You need to have at least 30 GB of data in your table to enable this feature.</p><p>The Key Visualizer is shown here:</p><p><a target="_blank" href="/assets/files/image-d2e2037eaf05cfcfebc613b7821d624d.png"><img alt="Bigtable Key Visualizer" src="/assets/images/image-d2e2037eaf05cfcfebc613b7821d624d.png"></a></p><p>The Key Visualizer will help you find and prevent hotspots, find rows with too much data and show if your key schema is balanced.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="summary">Summary<a aria-hidden="true" class="hash-link" href="#summary" title="Direct link to heading">â€‹</a></h3><p>Bigtable is one of the original and best (massively) distributed NoSQL platforms available. Schema and moreover row key design play a massive part in ensuring low latency and query performance. Go forth and conquer with Cloud Bigtable!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bigtable">bigtable</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloud-bigtable">cloud-bigtable</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/nosql">nosql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Cloud Bigtable Primer Part II â€“ Row Key Selection and Schema Design" href="/cloud-bigtable-primer-part-ii-row-key-selection-and-schema-design"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/gcp-templates-for-c4-diagrams-using-plantuml">GCP Templates for C4 Diagrams using PlantUML</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-08-14T00:00:00.000Z" itemprop="datePublished">August 14, 2020</time> Â· <!-- -->2 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/gcp-c4.png"><div class="markdown" itemprop="articleBody"><p>I am a believer in the mantra of <em><strong>â€œEverything-as-Codeâ€</strong></em>, this includes diagrams and other architectural artefacts. Enter PlantUMLâ€¦</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="plantuml">PlantUML<a aria-hidden="true" class="hash-link" href="#plantuml" title="Direct link to heading">â€‹</a></h2><p><a href="https://plantuml.com/" target="_blank" rel="noopener noreferrer">PlantUML</a> is an open-source tool which allows users to create UML diagrams from an intuitive DSL (Domain Specific Language). PlantUML is built on top of Graphviz and enables software architects and designers to use code to create Sequence Diagrams, Use Case Diagrams, Class Diagrams, State and Activity Diagrams and much more.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="c4-diagrams">C4 Diagrams<a aria-hidden="true" class="hash-link" href="#c4-diagrams" title="Direct link to heading">â€‹</a></h2><p>PlantUML can be extended to support the <a href="https://c4model.com/" target="_blank" rel="noopener noreferrer">C4 model</a> for visualising software architecture. Which describes software in different layers including Context, Container, Component and Code diagrams.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="gcp-architecture-diagramming-using-c4">GCP Architecture Diagramming using C4<a aria-hidden="true" class="hash-link" href="#gcp-architecture-diagramming-using-c4" title="Direct link to heading">â€‹</a></h2><p>PlantUML and C4 can be used to produce cloud architectures, there are official libraries available through PlantUML for Azure and AWS service icons, however these do not exist for GCP yet. There are several open source libraries available, however I have made an attempt to simplify the implementation.</p><p>The code below can be used to generate a C4 diagram describing a GCP architecture including official GCP service icons:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!define GCPPuml https://raw.githubusercontent.com/gamma-data/GCP-C4-PlantUML/master/templates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/C4\_Context.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/C4\_Component.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/C4\_Container.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/GCPC4Integration.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/GCPCommon.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Networking/CloudDNS.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Networking/CloudLoadBalancing.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Compute/ComputeEngine.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Storage/CloudStorage.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Databases/CloudSQL.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">title Sample C4 Diagram with GCP Icons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Person(publisher, &quot;Publisher&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System\_Ext(device, &quot;User&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Boundary(gcp,&quot;gcp-project&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CloudDNS(dns, &quot;Managed Zone&quot;, &quot;Cloud DNS&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CloudLoadBalancing(lb, &quot;L7 Load Balancer&quot;, &quot;Cloud Load Balancing&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CloudStorage(bucket, &quot;Static Content Bucket&quot;, &quot;Cloud Storage&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Boundary(region, &quot;gcp-region&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boundary(zonea, &quot;zone a&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ComputeEngine(gcea, &quot;Content Server&quot;, &quot;Compute Engine&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      CloudSQL(csqla, &quot;Dynamic Content&quot;, &quot;Cloud SQL&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boundary(zoneb, &quot;zone b&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ComputeEngine(gceb, &quot;Content Server&quot;, &quot;Compute Engine&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      CloudSQL(csqlb, &quot;Dynamic Content\\n(Read Replica)&quot;, &quot;Cloud SQL&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(device, dns, &quot;resolves name&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(device, lb, &quot;makes request&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(lb, gcea, &quot;routes request&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(lb, gceb, &quot;routes request&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(gcea, bucket, &quot;get static content&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(gceb, bucket, &quot;get static content&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(gcea, csqla, &quot;get dynamic content&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(gceb, csqla, &quot;get dynamic content&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(csqla, csqlb, &quot;replication&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(publisher,bucket,&quot;publish static content&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The preceding code generates the diagram below:</p><p><a target="_blank" href="/assets/files/Sample-C4-Diagram-with-GCP-Icons-291a0d7d898c0130b13e980e6752ec79.png"><img src="/assets/images/Sample-C4-Diagram-with-GCP-Icons-291a0d7d898c0130b13e980e6752ec79.png"></a></p><p>Additional services can be added and used in your diagrams by adding them to your includes, such as:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/DataAnalytics/BigQuery.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/DataAnalytics/CloudDataflow.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/AIandMachineLearning/AIHub.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/AIandMachineLearning/CloudAutoML.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/DeveloperTools/CloudBuild.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/HybridandMultiCloud/Stackdriver.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/InternetofThings/CloudIoTCore.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Migration/TransferAppliance.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Security/CloudIAM.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27; and moreâ€¦</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p>The complete template library is available at:</p><p><a href="https://github.com/gamma-data/GCP-C4-PlantUML" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/GCP-C4-PlantUML</a></p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/c-4-model">c4model</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/diagramming">diagramming</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/plantuml">plantuml</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/software-architecture">software-architecture</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GCP Templates for C4 Diagrams using PlantUML" href="/gcp-templates-for-c4-diagrams-using-plantuml"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/cloud-bigtable-primer-part-i">Cloud Bigtable Primer - Part I</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-08-04T00:00:00.000Z" itemprop="datePublished">August 4, 2020</time> Â· <!-- -->7 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cbt-featured-image.png"><div class="markdown" itemprop="articleBody"><p>Bigtable is one of the foundational services in the Google Cloud Platform and to this day one of the greatest contributions to the big data ecosystem at large. It is also one of the least known services available, with all the headlines and attention going to more widely used services such as BigQuery.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="background">Background<a aria-hidden="true" class="hash-link" href="#background" title="Direct link to heading">â€‹</a></h2><p>In 2006 (pre Google Cloud Platform), Google released a white paper called <em><strong>â€œBigtable: A Distributed Storage System for Structured Dataâ€</strong></em>, this paper set out the reference architecture for what was to become Cloud Bigtable. This followed several other whitepapers including the GoogleFS and MapReduce whitepapers released in 2003 and 2004 which provided abstract reference architectures for the Google File System (now known as <strong><em>Colossus</em></strong>) and the MapReduce algorithm. These whitepapers inspired a generation of open source distributed processing systems including Hadoop. Google has long had a pattern of publicising a generalized overview of their approach to solving different storage and processing challenges at scale through white papers.</p><p><a target="_blank" href="/assets/files/bigtable-osdi06-16d141802d2310614e01534fb1c82a11.pdf"><img alt="Bigtable Whitepaper 2006" src="/assets/images/bigtable-whitepaper-09803ad0c30b5dc4fa560e006ce33021.png"></a></p><p>The Bigtable white paper inspired a wave of open source distributed key/value oriented NoSQL data stores including Apache HBase and Apache Cassandra.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="what-is-bigtable">What is Bigtable?<a aria-hidden="true" class="hash-link" href="#what-is-bigtable" title="Direct link to heading">â€‹</a></h2><p>Bigtable is a distributed, petabyte scale NoSQL database. More specifically, Bigtable isâ€¦</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="a-map">a map<a aria-hidden="true" class="hash-link" href="#a-map" title="Direct link to heading">â€‹</a></h3><p>At its core Bigtable is a distributed map or an associative array indexed by a row key, with values in columns which are created only when they are referenced. Each value is an uninterpreted byte array.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="sorted">sorted<a aria-hidden="true" class="hash-link" href="#sorted" title="Direct link to heading">â€‹</a></h3><p>Row keys are stored in lexographic order akin to a clustered index in a relational database.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="sparse">sparse<a aria-hidden="true" class="hash-link" href="#sparse" title="Direct link to heading">â€‹</a></h3><p>A given row can have any number of columns, not all columns must have values and NULLs are not stored. There may also be gaps between keys.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="multi-dimensional">multi-dimensional<a aria-hidden="true" class="hash-link" href="#multi-dimensional" title="Direct link to heading">â€‹</a></h3><p>All values are versioned with a timestamp (or configurable integer). Data is not updated in place, it is instead superseded with another version.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="when-and-when-not-to-use-bigtable">When (and when not) to use Bigtable<a aria-hidden="true" class="hash-link" href="#when-and-when-not-to-use-bigtable" title="Direct link to heading">â€‹</a></h2><ul><li>You need to do many thousands of operations per second on TB+ scale data</li><li>Your access patterns are well known and simple</li><li>You need to support random write or random read operations (or sequential reads) - each using a row key as the primary identifier</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="dont-use-bigtable-if">Donâ€™t use Bigtable ifâ€¦<a aria-hidden="true" class="hash-link" href="#dont-use-bigtable-if" title="Direct link to heading">â€‹</a></h3><ul><li>You need explicit JOIN capability, that is joining one or more tables</li><li>You need to do ad-hoc analytics</li><li>Your access patterns are unknown or not well defined</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="bigtable-vs-relational-database-systems">Bigtable vs Relational Database Systems<a aria-hidden="true" class="hash-link" href="#bigtable-vs-relational-database-systems" title="Direct link to heading">â€‹</a></h3><p>The following table compares and contrasts Bigtable against relational databases (both transaction oriented and analytic oriented databases):</p><table><thead><tr><th>Â </th><th>Bigtable</th><th>RDBMS (OLTP)</th><th>RDBMS (DSS/MPP)</th></tr></thead><tbody><tr><td>Data Layout</td><td>Column Family Oriented</td><td>Row Oriented</td><td>Column Oriented</td></tr><tr><td>Transaction Support</td><td>Single Row Only</td><td>Yes</td><td>Depends (but usually no)</td></tr><tr><td>Query DSL</td><td>get/put/scan/delete</td><td>SQL</td><td>SQL</td></tr><tr><td>Indexes</td><td>Row Key Only</td><td>Yes</td><td>Yes (typically PI based)</td></tr><tr><td>Max Data Size</td><td>PB+</td><td>&#x27;00s GB  to TB</td><td>TB+</td></tr><tr><td>Read/Write Throughput</td><td>&quot;&#x27;000</td><td>000s queries/s&quot;</td><td>&#x27;000s queries/s</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="bigtable-data-model">Bigtable Data Model<a aria-hidden="true" class="hash-link" href="#bigtable-data-model" title="Direct link to heading">â€‹</a></h2><p><strong><em>Tables</em></strong> in Bigtable are comprised of rows and columns (sounds familiar so far..). Every row is uniquely identified by a <strong><em>rowkey</em></strong> (like a primary key..again sounds familiar so far).</p><p><strong><em>Columns</em></strong> belong to <strong><em>Column Families</em></strong> and only exist when inserted, NULLs are not stored - this is where it starts to differ from a traditional RDBMS. The following image demonstrates the data model for a fictitious table in Bigtable.</p><p><a target="_blank" href="/assets/files/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png"><img alt="Bigtable Data Model" src="/assets/images/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png"></a></p><p>In the previous example, we created two Column Families (<strong><em>cf1</em></strong> and <strong><em>cf2</em></strong>). These are created during table definition or update operations (akin to DDL operations in the relational world). In this case, we have chosen to store primary attributes, like name, etc in cf1 and features (or derived attributes) in cf2 like indicators.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="cell-versioning">Cell versioning<a aria-hidden="true" class="hash-link" href="#cell-versioning" title="Direct link to heading">â€‹</a></h3><p>Each cell has a timestamp/version associated with it, multiple versions of a row can exist. Versions are naturally stored in descending order.</p><p>Properties such as the max age for a cell or the maximum number of versions to be stored for any given cell are set on the Column Family. Versions are compacted through a process called <strong><em>Garbage Collection</em></strong> - not to be confused with Java Garbage Collection (albeit same idea).</p><table><thead><tr><th>Row Key</th><th>Column</th><th>Value</th><th>Timestamp</th></tr></thead><tbody><tr><td>123</td><td>cf1:status</td><td>ACTIVE</td><td>2020-06-30T08.58.27.560</td></tr><tr><td>123</td><td>cf1:status</td><td>PENDING</td><td>2020-06-28T06.20.18.330</td></tr><tr><td>123</td><td>cf1:status</td><td>INACTIVE</td><td>2020-06-27T07.59.20.460</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="bigtable-instances-clusters-nodes-and-tables">Bigtable Instances, Clusters, Nodes and Tables<a aria-hidden="true" class="hash-link" href="#bigtable-instances-clusters-nodes-and-tables" title="Direct link to heading">â€‹</a></h2><p>Bigtable is a &quot;no-ops&quot; service, meaning you do not need to configure machine types or details about the underlying infrastructure, save a few sizing or performance options - such as the number of nodes in a cluster or whether to use solid state hard drives (SSD) or the magnetic alternative (HDD). The following diagram shows the relationships and cardinality for Cloud Bigtable.</p><p><a target="_blank" href="/assets/files/bigtable-instances-and-nodes-b2d9e98ce7a8bf66600d284bafb5d3a9.png"><img alt="Bigtable Instances, Clusters and Nodes" src="/assets/images/bigtable-instances-and-nodes-b2d9e98ce7a8bf66600d284bafb5d3a9.png"></a></p><p><strong><em>Clusters</em></strong> and <strong><em>nodes</em></strong> are the physical compute layer for Bigtable, these are zonal assets, zonal and regional availability can be achieved through replication which we will discuss later in this article.</p><p><strong><em>Instances</em></strong> are a virtual abstraction for clusters, Tables belong to instances (not clusters). This is due to Bigtables underlying architecture which is based upon a separation of storage and compute as shown below.</p><p><a target="_blank" href="/assets/files/bigtable-storage-and-compute-b0c9a76792b16e425ee5d623d4339368.png"><img alt="Bigtable Separation of Storage and Compute" src="/assets/images/bigtable-storage-and-compute-b0c9a76792b16e425ee5d623d4339368.png"></a></p><p>Bigtables separation of storage and compute allow it to scale horizontally, as nodes are stateless they can be increased to increase query performance. The underlying storage system in inherently scalable.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="physical-storage--column-families">Physical Storage &amp; Column Families<a aria-hidden="true" class="hash-link" href="#physical-storage--column-families" title="Direct link to heading">â€‹</a></h3><p>Data (Columns) for Bigtable is stored in <strong><em>Tablets</em></strong> (as shown in the previous diagram), which store &quot;regions&quot; of row keys for a particular Column Family. Columns consist of a column family prefix and qualifier, for instance:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">cf1:col1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>A table can have one or more Column Families. Column families must be declared at schema definition time (could be a create or alter operation). A cell is an intersection of a row key and a version of a column within a column family.</p><p>Storage settings (such as the compaction/garbage collection properties mentioned before) can be specified for each Column Family - which can differ from other column families in the same table.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="bigtable-availability-and-replication">Bigtable Availability and Replication<a aria-hidden="true" class="hash-link" href="#bigtable-availability-and-replication" title="Direct link to heading">â€‹</a></h3><p><strong><em>Replication</em></strong> is used to increase availability and durability for Cloud Bigtable â€“ this can also be used to segregate read and write operations for the same table.</p><p>Data and changes to tables are replicated across multiple regions or multiple zones within the same region, this replication can be blocking (single row transactions) or non blocking (eventually consistent). However all clusters within a Bigtable instance are considered primary (writable).</p><p>Requests are routed using <strong><em>Application Profiles</em></strong>, a <strong><em>single-cluster routing</em></strong> policy can be used for manual failover, whereas a <strong><em>multi-cluster routing</em></strong> is used for automatic failover.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="backup-and-export-options-for-bigtable">Backup and Export Options for Bigtable<a aria-hidden="true" class="hash-link" href="#backup-and-export-options-for-bigtable" title="Direct link to heading">â€‹</a></h3><p>Managed backups can be taken at a table level, new tables can be created from backups. The backups cannot be exported, however table level export and import operations are available via pre-baked Dataflow templates for data stored in GCS in the following formats:</p><ul><li>SequenceFiles</li><li>Avro Files</li><li>Parquet Files</li><li>CSV Files</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="accessing-bigtable">Accessing Bigtable<a aria-hidden="true" class="hash-link" href="#accessing-bigtable" title="Direct link to heading">â€‹</a></h2><p>Bigtable data and admin functions are available via:</p><ul><li><code>cbt</code> (optional component of the Google SDK)</li><li><code>hbase shell</code> (REPL shell)</li><li>Happybase API (Python API for Hbase)</li><li>SDK libraries for:<ul><li>Golang</li><li>Python</li><li>Java</li><li>Node.js</li><li>Ruby</li><li>C#, C++, PHP, and more</li></ul></li></ul><p>As Bigtable is not a cheap service, there is a local emulator available which is great for application development. This is part of the Cloud SDK, and can be started using the following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud beta emulators bigtable start</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the next article in this series we will demonstrate admin and data functions as well as the local emulator.</p><blockquote><p>Next Up : Part II - Row Key Selection and Schema Design in Bigtable</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bigtable">bigtable</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloud-bigtable">cloud-bigtable</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/nosql">nosql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Cloud Bigtable Primer - Part I" href="/cloud-bigtable-primer-part-i"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/automated-gcs-object-scanning-using-dlp-with-notifications-using-slack">Automated GCS Object Scanning Using DLP with Notifications Using Slack</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-06-01T00:00:00.000Z" itemprop="datePublished">June 1, 2020</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/Slack-GCS-DLP-Image-e1591007165488.png"><div class="markdown" itemprop="articleBody"><p>This is a follow up to a previous blog, <a href="https://cloudywithachanceofbigdata.com/google-cloud-storage-object-notifications-using-slack/" target="_blank" rel="noopener noreferrer"><strong>Google Cloud Storage Object Notifications using Slack</strong></a> in which we used Slack to notify us of new objects being uploaded to GCS.</p><p>In this article we will take things a step further, where uploading an object to a GCS bucket will trigger a DLP inspection of the object and if any preconfigured info types (such as credit card numbers or API credentials) are present in the object, a Slack notification will be generated.</p><p>As DLP scans are â€œjobsâ€, meaning they run asynchronously, we will need to trigger scans and inspect results using two separate Cloud Functions (one for triggering a scan <!-- -->[<code>gcs-dlp-scan-trigger</code>]<!-- --> and one for inspecting the results of the scan <!-- -->[<code>gcs-dlp-evaluate-results</code>]<!-- -->) and a Cloud PubSub topic <!-- -->[<code>dlp-scan-topic</code>]<!-- --> which is used to hold the reference to the DLP job.</p><p>The process is described using the sequence diagram below:</p><p><a target="_blank" href="/assets/files/dlp-notifications-using-slack-d58f8548ccf305103d24c181be50ecda.png"><img src="/assets/images/dlp-notifications-using-slack-d58f8548ccf305103d24c181be50ecda.png"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="the-code">The Code<a aria-hidden="true" class="hash-link" href="#the-code" title="Direct link to heading">â€‹</a></h2><p>The <code>gcs-dlp-scan-trigger</code> Cloud Function fires when a new object is created in a specified GCS bucket. This function configures the DLP scan to be executed, including the DLP info types (for instance <code>CREDIT_CARD_NUMBER</code>, <code>EMAIL_ADDRESS</code>, <code>ETHNIC_GROUP</code>, <code>PHONE_NUMBER</code>, etc) a and likelihood of that info type existing (for instance <code>LIKELY</code>). DLP scans determine the probability of an info type occurring in the data, they do not scan every object in its entirety as this would be too expensive.</p><p>The primary function executed in the <code>gcs-dlp-scan-trigger</code> Cloud Function is named <code>inspect_gcs_file</code>. This function configures and submits the DLP job, supplying a PubSub topic to which the DLP Job Name will be written, the code for the <code>inspect_gcs_file</code> is shown here:</p><iframe width="100%" frameborder="0" id="gist-913a4457f43bc7b80e4405dd01f7b64d"></iframe><p>At this stage the DLP job is created an running asynchronously, the next Cloud Function, <code>gcs-dlp-evaluate-results</code>, fires when a message is sent to the PubSub topic defined in the DLP job. The <code>gcs-dlp-evaluate-results</code> reads the DLP Job Name from the PubSub topic, connects to the DLP service and queries the job status, when the job is complete, this function checks the results of the scan, if the <code>min_likliehood</code> threshold is met for any of the specified info types, a Slack message is generated. The code for the main method in the <code>gcs-dlp-evaluate-results</code> function is shown here:</p><iframe width="100%" frameborder="0" id="gist-ab377f6c3e448ae7c623d057239e05ed"></iframe><p>Finally, a Slack webhook is used to send the message to a specified Slack channel in a workspace, this is done using the <code>send_slack_notification</code> function shown here:</p><iframe width="100%" frameborder="0" id="gist-15d9e7c0922c26b680bed81abfcbadff"></iframe><p>An example Slack message is shown here:</p><p><a target="_blank" href="/assets/files/gcs-dlp-results-slack-notification-b8be26df34031f7e12c152c85781f4b4.png"><img alt="Slack Notification for Sensitive Data Detected in a Newly Created GCS Object" src="/assets/images/gcs-dlp-results-slack-notification-b8be26df34031f7e12c152c85781f4b4.png"></a></p><blockquote><p>Full source code can be found at: <a href="https://github.com/gamma-data/automated-gcs-object-scanning-using-dlp-with-notifications-using-slack" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/automated-gcs-object-scanning-using-dlp-with-notifications-using-slack</a></p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloud-dlp">cloud-dlp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloud-functions">cloud-functions</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloud-storage">cloud-storage</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/dlp">dlp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcs">gcs</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/python">python</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/slack">slack</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Automated GCS Object Scanning Using DLP with Notifications Using Slack" href="/automated-gcs-object-scanning-using-dlp-with-notifications-using-slack"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/forseti-terraform-validator-enforcing-resource-policy-compliance-in-your-ci-pipeline">Forseti Terraform Validator: Enforcing resource policy compliance in your CI pipeline</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-04-18T00:00:00.000Z" itemprop="datePublished">April 18, 2020</time> Â· <!-- -->9 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/daniel-hussey/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="http://2.gravatar.com/avatar/b0daeaf079c3665ee65a250adba487ee?s=80" alt="Daniel Hussey"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/daniel-hussey/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Daniel Hussey</span></a></div><small class="avatar__subtitle" itemprop="description">Cloud Security Engineer</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/Forseti-Terraform-e1587291818418.png"><div class="markdown" itemprop="articleBody"><p>Terraform is a powerful tool for managing your Infrastructure as Code. Declare your resources once, define their variables per environment and sleep easy knowing your CI pipeline will take care of the rest.</p><p>Butâ€¦ one night you wake up in a sweat. The details are fuzzy but you were browsing your favourite cloud providerâ€™s console - probably GCP ;) - and thought you saw a bucket had been created outside of your allowed locations! Maybe it even had risky access controls.</p><p>You go brush it off and try to fall back to sleep, but you canâ€™t quite push the thought from your mind that somewhere in all that Terraform code, someone <em>could</em> be declaring resources in unapproved locations, and your CICD pipeline would do nothing to stop it. Oh the regulatory implications.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="enter-terraform-validator-by-forseti">Enter Terraform Validator by Forseti<a aria-hidden="true" class="hash-link" href="#enter-terraform-validator-by-forseti" title="Direct link to heading">â€‹</a></h2><p>Terraform Validator by Forseti allows you to declare your Policy as Code, check compliance of your Terraform plans against said Policy, and automatically fail violating plans in a CI step. All without setting up servers or agents.</p><p>Youâ€™re going to learn how to enforce policy on GCP resources like BigQuery, IAM, networks, MySQL, Google Kubernetes Engine (GKE) and more. If youâ€™re particularly crafty, you may be able to go beyond GCP.</p><p>Forsetiâ€™s suite of solutions are GCP focused and allow a wide range of live config validation, monitoring and more using the Policy Library weâ€™re going to set up. These additional capabilities require additional infrastructure. But weâ€™re going one step at a time, starting with enforcing policy during deployment.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="getting-started">Getting Started<a aria-hidden="true" class="hash-link" href="#getting-started" title="Direct link to heading">â€‹</a></h2><p>Letâ€™s assume you already have an established CICD pipeline that uses Terraform, or that you are content to validate your Terraform plans locally for now. In that case, we need just two things:</p><ol><li>A Policy Library</li><li>Terraform Validator</li></ol><p>Itâ€™s that simple! No new servers, agents, firewall rules, extra service accounts or other nonsense. Just add Policy Library, the Validator tool and you can enforce policy on your Terraform deployments.</p><p>Weâ€™re going to tinker with some existing GCP-focused sample policies (aka Constraints) that Forseti makes available. These samples cover a wide range of resources and use cases, so it is easy to adjust whatâ€™s provided to define your own Constraints.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="policy-library">Policy Library<a aria-hidden="true" class="hash-link" href="#policy-library" title="Direct link to heading">â€‹</a></h2><p>First let&#x27;s open up some of Forseti&#x27;s pre-defined constraints. Weâ€™ll copy them into our own Git repository and adjust to create policies that match our needs. Repeatable and configurable - thatâ€™s Policy as Code at work.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="concepts">Concepts<a aria-hidden="true" class="hash-link" href="#concepts" title="Direct link to heading">â€‹</a></h3><p>In the world of Forseti and in particular Terraform Validator, Policies are defined and understood via easy to read YAML files known as Constraints</p><p>There is just enough information in a Constraint file for to make clear its purpose and effect, and by tinkering lightly with a pre-written Constraint you can achieve a lot without looking too deeply into the inner workings . But thereâ€™s more happening than meets the eye.</p><p>Constraints are built on Templates - which are like forms with some extra bits waiting to be completed to make a Constraint. Except thereâ€™s a lot more hidden away thatâ€™s pretty cool if you want to understand it.</p><p>Think of a Template as a â€˜Classâ€™ in the OOP sense, and of a Constraint as an instantiated Template with all the key attributes defined.</p><p>E.g. A generic Template for policy on bucket locations and a Constraint to specify which locations are relevant in a given instance. Again, buckets and locations are just the basic example - the potential applications are far greater.</p><p>Now the real magic is that just like a â€˜Classâ€™, a Template contains logic that makes everything abstracted away in the Constraint possible. Templates contain inline Rego (ray-go), borrowed lovingly by Forseti from the Open Policy Agent (OPA) team.</p><p>Learn more about Rego and OPA <a href="https://www.openpolicyagent.org/docs/latest/policy-language/" target="_blank" rel="noopener noreferrer">here</a> to understand the relationship to our Terraform Validator.</p><p>But letâ€™s begin.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="set-up-your-policies">Set up your Policies<a aria-hidden="true" class="hash-link" href="#set-up-your-policies" title="Direct link to heading">â€‹</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="create-your-policy-library-repository">Create your Policy Library repository<a aria-hidden="true" class="hash-link" href="#create-your-policy-library-repository" title="Direct link to heading">â€‹</a></h4><p>Create your Policy Library repository by cloning <a href="https://github.com/forseti-security/policy-library" target="_blank" rel="noopener noreferrer">https://github.com/forseti-security/policy-library</a> into your own VCS.</p><p>This repo contains templates and sample constraints which will form the basis of your policies. So get it into your Git environment and clone it to local for the next step.</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="customise-sample-constraints-to-fit-your-needs">Customise sample constraints to fit your needs<a aria-hidden="true" class="hash-link" href="#customise-sample-constraints-to-fit-your-needs" title="Direct link to heading">â€‹</a></h4><p>As discussed in Concepts, Constraints are defined Templates, which make use of Rego policy language. Nice. So letâ€™s take a sample Constraint, put it in our Policy Library and set the values to what we need. Itâ€™s that easy - no need to write new templates or learn Rego if your use case is covered.</p><p>In a new branchâ€¦</p><ol><li>Copy the sample Constraint <code>storage_location.yaml</code> to your Constraints folder.  </li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> policy-library/samples/storage_location.yaml policy-library/policies/constraints/storage_location.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="2"><li>Replace the sample location (<code>asia-southeast1</code>) in <code>storage_location.yaml</code> with <code>australia-southeast1</code>.  </li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">severity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> high  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">target</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;organization/*&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;allowlist&quot;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> australia</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">southeast1  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">exemptions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="3"><li>Push back to your repo - not Forsetiâ€™s!  </li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> push https://github.com/</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">your-repository</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">/policy-library.git</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="policy-review">Policy review<a aria-hidden="true" class="hash-link" href="#policy-review" title="Direct link to heading">â€‹</a></h4><p>There you go - youâ€™ve customised a sample Constraint. Now you have your own instance of version controlled Policy-as-Code and are ready to apply the power of OPAâ€™s Rego policy language that lies within the parent Template. Impressively easy right?</p><p>Thatâ€™s a pretty simple example. You can browse the rest of Forsetiâ€™s Policy Library to view other sample Constraints, Templates and the Rego logic that makes all of this work. These can be adjusted to cover all kinds of use cases across GCP resources.</p><p>I suggest working with and editing the <a href="https://github.com/forseti-security/policy-library/tree/master/samples" target="_blank" rel="noopener noreferrer">sample Constraints</a> before making any changes to Templates.</p><p>If you were to write Rego and Templates from scratch, you might even be able to enforce Policy as Code against non-GCP Terraform code.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="terraform-validator">Terraform Validator<a aria-hidden="true" class="hash-link" href="#terraform-validator" title="Direct link to heading">â€‹</a></h2><p>Now, letâ€™s set up the Terraform Validator tool and have it compare a sample piece of Terraform code against the Constraint we configured above. Keep in mind youâ€™ll want to translate whatâ€™s done here into steps in your CICD pipeline.</p><p>Once the tool is in place, we really just run <code>terraform plan</code> and feed the output into Terraform Validator. The Validator compares it to our Constraints, runs all the abstracted logic we donâ€™t need to worry about and returns 0 or 2 when done for pass / fail respectively. Easy.</p><p>So using Terraform if I try to make a bucket in <code>australia-southeast1</code> it should pass, if I try to make one in the US it should fail. Letâ€™s set up the tool, write some basic Terraform and see how we go.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="setup-terraform-validator">Setup Terraform Validator<a aria-hidden="true" class="hash-link" href="#setup-terraform-validator" title="Direct link to heading">â€‹</a></h3><p>Check for the latest version of <code>terraform-validator</code> from the official terraform-validator GCS bucket.</p><p>Very important when using tf version 0.12 or greater. This is the easy way - you can pull from the <a href="https://github.com/GoogleCloudPlatform/terraform-validator" target="_blank" rel="noopener noreferrer">Terraform Validator Github</a> and make it yourself too.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ gsutil </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -r gs://terraform-validator/releases</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Copy the latest version to the working dir</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ gsutil </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> gs://terraform-validator/releases/2020-03-05/terraform-validator-linux-amd64 </span><span class="token builtin class-name">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Make it executable</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">755</span><span class="token plain"> terraform-validator-linux-amd64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Ready to go!</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="review-your-terraform-code">Review your Terraform code<a aria-hidden="true" class="hash-link" href="#review-your-terraform-code" title="Direct link to heading">â€‹</a></h3><p>Weâ€™re going to make a ridiculously simple piece of Terraform that tries to create one bucket in our project to keep things simple.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_storage_bucket&quot; &quot;tf-validator-demo-bucket&quot; {Â Â </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nameÂ  Â  Â  Â  Â  = &quot;tf-validator-demo-bucket&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â Â locationÂ  Â  Â  = &quot;US&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â Â force_destroy = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â Â lifecycle_rule {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â Â Â Â condition {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â Â Â Â Â Â age = &quot;3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â Â Â Â }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â Â Â Â action {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â Â Â Â Â Â type = &quot;Delete&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â Â Â Â }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Â Â }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is a pretty standard bit of Terraform for a GCS bucket, but made very simple with all the values defined directly in <code>main.tf</code>. Note the location of the bucket - it violates our Constraint that was set to the <code>australia-southeast1</code> region.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="make-the-terraform-plan">Make the Terraform plan<a aria-hidden="true" class="hash-link" href="#make-the-terraform-plan" title="Direct link to heading">â€‹</a></h3><p>Warm up Terraform.<br>
<!-- -->Double check your Terraform code if there are any hiccups.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform init</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Make the Terraform plan and store output to file.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan --out</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">terraform.tfplan</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Convert the plan to JSON</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform show -json ./terraform.tfplan </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> ./terraform.tfplan.json</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="validate-the-non-compliant-terraform-plan-against-your-constraints-for-example">Validate the non-compliant Terraform plan against your Constraints, for example<a aria-hidden="true" class="hash-link" href="#validate-the-non-compliant-terraform-plan-against-your-constraints-for-example" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./terraform-validator-linux-amd64 validate ./tfplan.tfplan.json --policy-path</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/repos/policy-library/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>TA-DA!</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Found Violations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Constraint allow_some_storage_location on resource //storage.googleapis.com/tf-validator-demo-bucket: //storage.googleapis.com/tf-validator-demo-bucket is in a disallowed location.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="validate-the-compliant-terraform-plan-against-your-constraints">Validate the compliant Terraform plan against your Constraints<a aria-hidden="true" class="hash-link" href="#validate-the-compliant-terraform-plan-against-your-constraints" title="Direct link to heading">â€‹</a></h3><p>Letâ€™s see what happens if we repeat the above, changing the location of our GCS bucket to <code>australia-southeast1</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./terraform-validator-linux-amd64 validate ./tfplan.tfplan.json --policy-path</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/repos/policy-library/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Results in..</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">No violations found.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Success!!!</p><p>Now all thatâ€™s left to do for your Policy as Code CICD pipeline is to configure the rest of your Constraints and run this check before you go ahead and <code>terraform apply</code>. Be sure to make the <code>apply</code> step dependent on the outcome of the Validator.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="wrap-up">Wrap Up<a aria-hidden="true" class="hash-link" href="#wrap-up" title="Direct link to heading">â€‹</a></h2><p>Weâ€™ve looked at how to apply Policy as Code to validate our Infrastructure as Code. Sounds pretty modern and DevOpsy doesnâ€™t it.</p><p>To recap, we learned about Constraints, which are fully defined instances of Policy as Code. Theyâ€™re based on YAML Templates that refer to the OPA policy language Rego, but we didnâ€™t have to learn it :)</p><p>We created our own version controlled Policy Library.</p><p>Using the above learning and some handy pre-existing samples, we wrote policies (Constraints) for GCP infrastructure, specifying a whitelist for locations in which GCS buckets could be deployed.</p><p>As mentioned there are <a href="https://github.com/forseti-security/policy-library/tree/master/samples" target="_blank" rel="noopener noreferrer">dozens upon dozens of samples</a> across BigQuery, IAM, networks, MySQL, Google Kubernetes Engine (GKE) and more to work with.</p><p>Of course, we stored these configured Constraints in our version-controlled Policy Library.</p><ul><li>We looked at a simple set of Terraform code to define a GCS bucket, and stored the Terraform plan to a file before applying it.</li><li>We ran Forsetiâ€™s Terraform Validator against the Terraform plan file, and had the Validator compare the plan to our Policy Library.</li><li>We saw that the results matched our expectations! Compliance with the location specified in our Constraint passed the Validatorâ€™s checks, and non-compliance triggered a violation.</li></ul><p>Awesome. And the best part is that all this required no special permissions, no infrastructure for servers or agents and no networking.</p><p>All of that comes with the full Forseti suite of Inventory taking Config Validation of already deployed resources. We might get to that next time.</p><p>References:</p><p><a href="https://github.com/GoogleCloudPlatform/terraform-validator" target="_blank" rel="noopener noreferrer">https://github.com/GoogleCloudPlatform/terraform-validator</a> <a href="https://github.com/forseti-security/policy-library" target="_blank" rel="noopener noreferrer">https://github.com/forseti-security/policy-library</a> <a href="https://www.openpolicyagent.org/docs/latest/policy-language/" target="_blank" rel="noopener noreferrer">https://www.openpolicyagent.org/docs/latest/policy-language/</a> <a href="https://cloud.google.com/blog/products/identity-security/using-forseti-config-validator-with-terraform-validator" target="_blank" rel="noopener noreferrer">https://cloud.google.com/blog/products/identity-security/using-forseti-config-validator-with-terraform-validator</a> <a href="https://forsetisecurity.org/docs/latest/concepts/" target="_blank" rel="noopener noreferrer">https://forsetisecurity.org/docs/latest/concepts/</a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/devops">devops</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/forseti">forseti</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/policyascode">policyascode</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Forseti Terraform Validator: Enforcing resource policy compliance in your CI pipeline" href="/forseti-terraform-validator-enforcing-resource-policy-compliance-in-your-ci-pipeline"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/creating-a-site-to-site-vpn-connection-between-gcp-and-azure-with-google-private-access">Creating a Site to Site VPN Connection Between GCP and Azure with Google Private Access</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-03-27T00:00:00.000Z" itemprop="datePublished">March 27, 2020</time> Â· <!-- -->12 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/azure_to_gcp_feature_image-1.png"><div class="markdown" itemprop="articleBody"><p>This article demonstrates creating a site to site IPSEC VPN connection between a GCP VPC network and an Azure Virtual Network, enabling private RFC1918 network connectivity between virtual networks in both clouds. This is done using a single PowerShell script leveraging Azure PowerShell and gcloud commands in the Google SDK.</p><p>Additionally, we will use Azure Private DNS to enable private access between Azure hosts and GCP APIs (such as Cloud Storage or Big Query).</p><p>An overview of the solution is provided here:</p><p><a target="_blank" href="/assets/files/gcp-to-azure-vpn-design-f59e466042c5e6fdf12abc497dde73bd.png"><img alt="Azure to GCP VPN Design" src="/assets/images/gcp-to-azure-vpn-design-f59e466042c5e6fdf12abc497dde73bd.png"></a></p><p>One note before starting - site to site VPN connections between GCP and Azure currently do not support dynamic routing using BGP, however creating some simple routes on either end of the connection will be enough to get going.</p><p>Letâ€™s go through this step by step:</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-1--authenticate-to-azure">Step 1 : Authenticate to Azure<a aria-hidden="true" class="hash-link" href="#step-1--authenticate-to-azure" title="Direct link to heading">â€‹</a></h2><p>Azureâ€™s account equivalent is a subscription, the following command from Azure Powershell is used to authenticate a user to one or more subscriptions.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Connect-AzAccount</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This command will open a browser window prompting you for Microsoft credentials, once authenticated you will be returned to the command line.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-2--create-a-resource-group-azure">Step 2 : Create a Resource Group (Azure)<a aria-hidden="true" class="hash-link" href="#step-2--create-a-resource-group-azure" title="Direct link to heading">â€‹</a></h2><p>A resource group is roughly equivalent to a project in GCP. You will need to supply a Location (equivalent to a GCP region):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">New-AzResourceGroup `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-3--create-a-virtual-network-with-subnets-and-routes-azure">Step 3 : Create a Virtual Network with Subnets and Routes (Azure)<a aria-hidden="true" class="hash-link" href="#step-3--create-a-virtual-network-with-subnets-and-routes-azure" title="Direct link to heading">â€‹</a></h2><p>An Azure Virtual Network is the equivalent of a VPC network in GCP (or AWS), you must define subnets before creating a Virtual Network. In this example we will create two subnets, one Gateway subnet (which needs to be named accordingly) where the VPN gateway will reside, and one subnet named â€˜defaultâ€™ where we will host VMs which will connect to GCP services over the private VPN connection.</p><p>Before defining the default subnet we must create and attach a Route Table (equivalent of a Route in GCP), this particular route will be used to route â€˜privateâ€™ requests to services in GCP (such as Big Query).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># define route table and route to GCP private access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azroutecfg = New-AzRouteConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;google-private&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;199.36.153.4/30&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -NextHopType &quot;VirtualNetworkGateway&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azrttbl = New-AzRouteTable `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;google-private&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Route $azroutecfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># define gateway subnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$gatewaySubnet = New-AzVirtualNetworkSubnetConfig  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;GatewaySubnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.2.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># define default subnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$defaultSubnet  = New-AzVirtualNetworkSubnetConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;default&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.1.0/24&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RouteTable $azrttbl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create virtual network and subnets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$vnet = New-AzVirtualNetwork  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;azure-to-gcp-vnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.0.0/16&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Subnet $gatewaySubnet,$defaultSubnet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-4--create-network-security-groups-azure">Step 4 : Create Network Security Groups (Azure)<a aria-hidden="true" class="hash-link" href="#step-4--create-network-security-groups-azure" title="Direct link to heading">â€‹</a></h2><p>Network Security Groups in Azure are stateful firewalls much like Firewall Rules in VPC networks in GCP. Like GCP, the lower priority overrides higher priority rules.</p><p>In the example we will create several rules to allow inbound ICMP, TCP and UDP traffic from our Google VPC and RDP traffic from the Internet (which we will use to logon to a VM in Azure to test private connectivity between the two clouds):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create network security group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule1 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name rdp-rule `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow RDP&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Tcp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 100 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix Internet `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange 3389</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule2 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name icmp-rule `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow ICMP&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Icmp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 101 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule3 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name gcp-rule `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow GCP&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Tcp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 102 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix &quot;10.2.0.0/16&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$nsg = New-AzNetworkSecurityGroup `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;nsg-vm&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SecurityRules $rule1,$rule2,$rule3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-5--create-public-ip-addresses-azure">Step 5 : Create Public IP Addresses (Azure)<a aria-hidden="true" class="hash-link" href="#step-5--create-public-ip-addresses-azure" title="Direct link to heading">â€‹</a></h2><p>We need to create two Public IP Address (equivalent of an External IP in GCP) which will be used for our VPN gateway and for the VM we will create:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create public IP address for VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$vmpip = New-AzPublicIpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vm-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AllocationMethod Dynamic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create public IP address for NW gateway </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ngwpip = New-AzPublicIpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AllocationMethod Dynamic</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-6--create-virtual-network-gateway-azure">Step 6 : Create Virtual Network Gateway (Azure)<a aria-hidden="true" class="hash-link" href="#step-6--create-virtual-network-gateway-azure" title="Direct link to heading">â€‹</a></h2><p>The Virtual Network Gateway in Azure is the VPN Gateway equivalent in Azure which will be used to create a VPN tunnel between Azure and a GCP VPN Gateway. This gateway will be placed in the Gateway subnet created previously and one of the Public IP addresses created in the previous step will be assigned to this gateway.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create virtual network gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ngwipconfig = New-AzVirtualNetworkGatewayIpConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ipconfig&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SubnetId $gatewaySubnet.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublicIpAddressId $ngwpip.Id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use the AsJob switch as this is a long running process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$job = New-AzVirtualNetworkGateway -Name &quot;vnet-gateway&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IpConfigurations $ngwipconfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewayType &quot;Vpn&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VpnType &quot;RouteBased&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewaySku &quot;VpnGw1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VpnGatewayGeneration &quot;Generation1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AsJob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$vnetgw = Get-AzVirtualNetworkGateway `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vnet-gateway&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-7--create-a-vpc-network-and-subnetworks-gcp">Step 7 : Create a VPC Network and Subnetwork(s) (GCP)<a aria-hidden="true" class="hash-link" href="#step-7--create-a-vpc-network-and-subnetworks-gcp" title="Direct link to heading">â€‹</a></h2><p>A VPC network and subnet need to be created in GCP, the subnet defines the VPC address space. This address space must not overlap with the Azure Virtual Network CIDR. For all GCP steps it is assumed that the project is set for client config (e.g. gcloud config set project <strong>your_project</strong>) so it does not need to be specified for each operation. Private Google access should be enabled on all subnets created.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># creating VPC network and subnets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks create &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --subnet-mode=custom `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --bgp-routing-mode=regional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks subnets create &quot;aus-subnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network  &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --range &quot;10.2.1.0/24&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-private-ip-google-access</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-8--create-an-external-ip-gcp">Step 8 : Create an External IP (GCP)<a aria-hidden="true" class="hash-link" href="#step-8--create-an-external-ip-gcp" title="Direct link to heading">â€‹</a></h2><p>An external IP address will need to be created in GCP which will be used for the external facing interface of the VPN Gateway.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># create external IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute addresses create </span><span class="token string" style="color:#e3116c">&quot;ext-gw-ip&quot;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">  --region </span><span class="token variable string" style="color:#e3116c">&quot;australia-southeast1&quot;</span><span class="token variable" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="display:inline-block;color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">$gcp_ipaddr_obj </span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa"> gcloud compute addresses describe </span><span class="token variable string" style="color:#e3116c">&quot;ext-gw-ip&quot;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region </span><span class="token string" style="color:#e3116c">&quot;australia-southeast1&quot;</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --format json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ConvertFrom-Json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$gcp_ipaddr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$gcp_ipaddr_obj</span><span class="token plain">.address</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-9--create-firewall-rules-gcp">Step 9 : Create Firewall Rules (GCP)<a aria-hidden="true" class="hash-link" href="#step-9--create-firewall-rules-gcp" title="Direct link to heading">â€‹</a></h2><p>VPC firewall rules will need to be created in GCP to allow VPN traffic as well as SSH traffic from the internet (which allows you to SSH into VM instances using Cloud Shell).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create VPN firewall rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules create &quot;vpn-rule1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --allow tcp,udp,icmp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --source-ranges &quot;10.1.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules create &quot;ssh-rule1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --allow tcp:22</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-10--create-vpn-gateway-and-forwarding-rules-gcp">Step 10 : Create VPN Gateway and Forwarding Rules (GCP)<a aria-hidden="true" class="hash-link" href="#step-10--create-vpn-gateway-and-forwarding-rules-gcp" title="Direct link to heading">â€‹</a></h2><p>Create a VPN Gateway and Forwarding Rules in GCP which will be used to create a tunnel between GCP and Azure.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create cloud VPN </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute target-vpn-gateways create &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create forwarding rule ESP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-esp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol ESP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># creating forwarding rule UDP500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-udp500&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol UDP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ports 500 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># creating forwarding rule UDP4500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-udp4500&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol UDP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ports 4500 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-10--create-vpn-tunnel-gcp-side">Step 10 : Create VPN Tunnel (GCP Side)<a aria-hidden="true" class="hash-link" href="#step-10--create-vpn-tunnel-gcp-side" title="Direct link to heading">â€‹</a></h2><p>Now we will create the GCP side of our VPN tunnel using the Public IP Address of the Azure Virtual Network Gateway created in a previous step. As this example uses a route based VPN the traffic selector values need to be set at 0.0.0.0/0. A PSK (Pre Shared Key) needs to be supplied which will be the same key used when we configure a VPN Connection on the Azure side of the tunnel.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># get peer public IP address of Azure gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azpubip = Get-AzPublicIpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create VPN tunnel </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute vpn-tunnels create &quot;vpn-tunnel-to-azure&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-address $azpubip.IpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --local-traffic-selector &quot;0.0.0.0/0&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --remote-traffic-selector &quot;0.0.0.0/0&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ike-version 2 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --shared-secret &lt;&lt; Pre-Shared Key &gt;&gt; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region  &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-11--create-static-routes-gcp-side">Step 11 : Create Static Routes (GCP Side)<a aria-hidden="true" class="hash-link" href="#step-11--create-static-routes-gcp-side" title="Direct link to heading">â€‹</a></h2><p>As we are using static routing (as opposed to dynamic routing) we will need to define all of the specific routes on the GCP side. We will need to setup routes for both outgoing traffic to the Azure network as well as incoming traffic for the restricted Google API range (199.36.153.4/30).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create static route (VPN)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute routes create &quot;route-to-azure&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --destination-range &quot;10.1.0.0/16&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-vpn-tunnel &quot;vpn-tunnel-to-azure&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-vpn-tunnel-region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create static route (Restricted APIs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute routes create apis `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network  &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --destination-range &quot;199.36.153.4/30&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-gateway default-internet-gateway `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-12--create-a-local-gateway-azure">Step 12 : Create a Local Gateway (Azure)<a aria-hidden="true" class="hash-link" href="#step-12--create-a-local-gateway-azure" title="Direct link to heading">â€‹</a></h2><p>A Local Gateway in Azure is an object that represents the remote gateway (GCP VPN gateway).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create local gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azlocalgw = New-AzLocalNetworkGateway `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;local-gateway&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewayIpAddress $gcp_ipaddr `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.2.0.0/16&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-13--create-a-vpn-connection-azure">Step 13 : Create a VPN Connection (Azure)<a aria-hidden="true" class="hash-link" href="#step-13--create-a-vpn-connection-azure" title="Direct link to heading">â€‹</a></h2><p>Now we can setup the Azure side of the VPN Connection which is accomplished by associating the Azure Virtual Network Gateway with the Local Network Gateway. A PSK (Pre Shared Key) needs to be supplied which is the same key used for the GCP VPN Tunnel in step 10.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azvpnconn = New-AzVirtualNetworkGatewayConnection `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vpn-connection&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VirtualNetworkGateway1 $vnetgw `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -LocalNetworkGateway2 $azlocalgw `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ConnectionType IPsec `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SharedKey  &lt;&lt; Pre-Shared Key &gt;&gt;  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ConnectionProtocol &quot;IKEv2&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>VPN Tunnel Established!</p><p>At this stage we have created an end to end connection between the virtual networks in both clouds. You should see this reflected in the respective consoles in each provider.</p><figure><a href="/assets/images/gcp-vpn-to-azure-d627caa8febd797b530e1471bd5c9aff.png"><img src="/assets/images/gcp-vpn-to-azure-d627caa8febd797b530e1471bd5c9aff.png" alt="GCP VPN Tunnel to a Azure Virtual Network"></a><figcaption class="figure-caption">GCP VPN Tunnel to a Azure Virtual Network</figcaption></figure><figure><a href="/assets/images/azure-vpn-to-gcp-4716124e93f2cbc8a7e5ef5cd98d23df.png"><img src="/assets/images/azure-vpn-to-gcp-4716124e93f2cbc8a7e5ef5cd98d23df.png" alt="Azure VPN Connection to a GCP VPC Network"></a><figcaption class="figure-caption">Azure VPN Connection to a GCP VPC Network</figcaption></figure><p>Congratulations! You have just setup a multi cloud environment using private networking. Now letâ€™s setup Google Private Access for Azure hosts and create VMs on each side to test our setup.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-14--create-a-private-dns-zone-for-googleapiscom-azure">Step 14 : Create a Private DNS Zone for googleapis.com (Azure)<a aria-hidden="true" class="hash-link" href="#step-14--create-a-private-dns-zone-for-googleapiscom-azure" title="Direct link to heading">â€‹</a></h2><p>We will now need to create a Private DNS zone in Azure for the googleapis.com domain which will host records to redirect Google API requests to the Restricted API range.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create private DNS zone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsZone `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;googleapis.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add A Records   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records = @()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsRecordSet `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;restricted&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RecordType A `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -TTL 300 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PrivateDnsRecords $Records</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add CNAME Records   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records = @()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Cname &quot;restricted.googleapis.com.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsRecordSet `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;*&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RecordType CNAME `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -TTL 300 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PrivateDnsRecords $Records</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Create VNet Link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsVirtualNetworkLink `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;dns-zone-link&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VirtualNetworkId $vnet.Id</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-15--create-a-virtual-machine-azure">Step 15 : Create a Virtual Machine (Azure)<a aria-hidden="true" class="hash-link" href="#step-15--create-a-virtual-machine-azure" title="Direct link to heading">â€‹</a></h2><p>We will create a VM in Azure which we can use to test the VPN tunnel as well as to test Private Google Access over our VPN tunnel.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$az_vmlocaladminpwd = ConvertTo-SecureString &lt;&lt; Password Param &gt;&gt; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AsPlainText -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Credential = New-Object System.Management.Automation.PSCredential  (&quot;LocalAdminUser&quot;, $az_vmlocaladminpwd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$nic = New-AzNetworkInterface `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vm-nic&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SubnetId $defaultSubnet.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -NetworkSecurityGroupId $nsg.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublicIpAddressId $vmpip.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -EnableAcceleratedNetworking `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = New-AzVMConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VMName &quot;windows-desktop&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VMSize &quot;Standard_D4_v3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Set-AzVMOperatingSystem `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Windows `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ComputerName  &quot;windows-desktop&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Credential $Credential `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ProvisionVMAgent `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -EnableAutoUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Add-AzVMNetworkInterface `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Id $nic.Id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Set-AzVMSourceImage `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublisherName &#x27;MicrosoftWindowsDesktop&#x27; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Offer &#x27;Windows-10&#x27; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Skus &#x27;rs5-pro&#x27; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Version latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzVM `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Verbose</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-16--create-a-vm-instance-gcp">Step 16 : Create a VM Instance (GCP)<a aria-hidden="true" class="hash-link" href="#step-16--create-a-vm-instance-gcp" title="Direct link to heading">â€‹</a></h2><p>We will create a Linux VM in GCP to test connectivity to hosts in Azure using the VPN tunnel we have established.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create VM instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute instances create &quot;gcp-instance&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --zone &quot;australia-southeast1-b&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --machine-type &quot;f1-micro&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --subnet &quot;aus-subnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network-tier PREMIUM `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --maintenance-policy MIGRATE `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --image=debian-9-stretch-v20200309 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --image-project=debian-cloud `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-size 10GB `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-type pd-standard `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-device-name instance-1 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --reservation-affinity any</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="test-connectivity">Test Connectivity<a aria-hidden="true" class="hash-link" href="#test-connectivity" title="Direct link to heading">â€‹</a></h2><p>Now we are ready to test connectivity from both sides of the tunnel.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="azure-to-gcp">Azure to GCP<a aria-hidden="true" class="hash-link" href="#azure-to-gcp" title="Direct link to heading">â€‹</a></h3><p>Establish a remote desktop (RDP) connection to the Azure VM created in Step 15. Ping the GCP VM instance using its private IP address.</p><p><a target="_blank" href="/assets/files/azure-ping-to-gcp-14a9b0e446b7c868ffa27ba3435460be.png"><img alt="Test Private IP Connectivity from Azure to GCP" src="/assets/images/azure-ping-to-gcp-14a9b0e446b7c868ffa27ba3435460be.png"></a></p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="gcp-to-azure">GCP to Azure<a aria-hidden="true" class="hash-link" href="#gcp-to-azure" title="Direct link to heading">â€‹</a></h3><p>Now SSH into the GCP Linux VM instance and ping the Azure host using its private IP address.</p><p><a target="_blank" href="/assets/files/gcp-ping-to-azure-94b9a33840b54870af540853cda825e9.png"><img alt="Test Private IP Connectivity from GCP to Azure" src="/assets/images/gcp-ping-to-azure-94b9a33840b54870af540853cda825e9.png"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="test-private-google-access-from-azure">Test Private Google Access from Azure<a aria-hidden="true" class="hash-link" href="#test-private-google-access-from-azure" title="Direct link to heading">â€‹</a></h2><p>Now that we have established bi-directional connectivity between the two clouds, we can test private access to Google APIs from our Azure host. Follow the steps below to test private access:</p><ol><li>RDP into the Azure VM</li><li>Install the Google Cloud SDK ( <a href="https://cloud.google.com/sdk/" target="_blank" rel="noopener noreferrer">https://cloud.google.com/sdk/</a>)</li><li>Perform an <code>nslookup</code> to ensure that calls to googleapis.com resolve to the restricted API range (e.g. <code>nslookup storage.googleapis.com</code>). You should see a response showing the A records from the googleapis.com Private DNS Zone created in step 14.</li><li>Now test connectivity to Google APIs, for example to test access to Google Cloud Storage using <code>gsutil</code>, or test access to Big Query using the <code>bq</code> command</li></ol><p>Congratulations! You are now a multi cloud ninja!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure">azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/hybrid-cloud">hybrid-cloud</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/microsoft">microsoft</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/microsoft-azure">microsoft-azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/multi-cloud">multi-cloud</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/private-networking">private-networking</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/vpn">vpn</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Creating a Site to Site VPN Connection Between GCP and Azure with Google Private Access" href="/creating-a-site-to-site-vpn-connection-between-gcp-and-azure-with-google-private-access"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/spark-in-the-google-cloud-platform-part-2">Spark in the Google Cloud Platform Part 2</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-02-29T00:00:00.000Z" itemprop="datePublished">February 29, 2020</time> Â· <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/spark-gcp-featured-image.png"><div class="markdown" itemprop="articleBody"><p>In the previous post in this series <a href="https://cloudywithachanceofbigdata.com/spark-in-the-google-cloud-platform-part-1/" target="_blank" rel="noopener noreferrer"><strong>Spark in the Google Cloud Platform Part 1</strong></a>, we started to explore the various ways in which we could deploy Apache Spark applications in GCP. The first option we looked at was deploying Spark using Cloud DataProc, a managed Hadoop cluster with various ecosystem components included.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Spark Training Courses</h5></div><div class="admonition-content"><p><a href="https://academy.alphazetta.ai/data-transformation-and-analysis-using-apache-spark/" target="_blank" rel="noopener noreferrer">Data Transformation and Analysis Using Apache Spark</a><br>
<a href="https://academy.alphazetta.ai/stream-and-event-processing-using-apache-spark/" target="_blank" rel="noopener noreferrer">Stream and Event Processing using Apache Spark</a><br>
<a href="https://academy.alphazetta.ai/advanced-analytics-using-apache-spark/" target="_blank" rel="noopener noreferrer">Advanced Analytics Using Apache Spark</a></p></div></div><p>In this post, we will look at another option for deploying Spark in GCP â€“ <em>a Spark Standalone cluster running on GKE</em>.</p><p>Spark Standalone refers to the in-built cluster manager provided with each Spark release. Standalone can be a bit of a misnomer as it sounds like a single instance â€“ which it is not, standalone simply refers to the fact that it is not dependent upon any other projects or components â€“ such as Apache YARN, Mesos, etc.</p><p>A Spark Standalone cluster consists of a Master node or instance and one of more Worker nodes. The Master node serves as both a master and a cluster manager in the Spark runtime architecture.</p><p>The Master process is responsible for marshalling resource requests on behalf of applications and monitoring cluster resources.</p><p>The Worker nodes host one or many Executor instances which are responsible for carrying out tasks.</p><p>Deploying a Spark Standalone cluster on GKE is reasonably straightforward. In the example provided in this post we will set up a private network (VPC), create a GKE cluster, and deploy a Spark Master pod and two Spark Worker pods (in a real scenario you would typically have many Worker pods).</p><p>Once the network and GKE cluster have been deployed, the first step is to create Docker images for both the Master and Workers.</p><p>The <code>Dockerfile</code> below can be used to create an image capable or running either the Worker or Master daemons:</p><iframe width="100%" frameborder="0" id="gist-a2828409021205b3f6587c824c59928d"></iframe><p>Note the shell scripts included in the <code>Dockerfile</code>: <code>spark-master</code> and <code>spark-worker</code>. These will be used later on by K8S deployments to start the relative Master and Worker daemon processes in each of the pods.</p><p>Next, we will use Cloud Build to build an image using the <code>Dockerfile</code> are store this in GCR (Google Container Registry), from the Cloud Build directory in our project we will run:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud builds submit --tag gcr.io/spark-demo-266309/spark-standalone</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Next, we will create Kubernetes deployments for our Master and Worker pods.</p><p>Firstly, we need to get cluster credentials for our GKE cluster named â€˜spark-clusterâ€™:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud container clusters get-credentials spark-cluster --zone australia-southeast1-a --project spark-demo-266309</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now from within the <code>k8s-deployments\deploy</code> folder of our project we will use the <code>kubectl</code> command to deploy the Master pod, service and the Worker pods</p><p>Starting with the Master deployment, this will deploy our Spark Standalone image into a container running the Master daemon process:</p><iframe width="100%" frameborder="0" id="gist-31bca11627167e0cd963103e4c7f11d2"></iframe><p>To deploy the Master, run the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f spark-master-deployment.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The Master will expose a web UI on port 8080 and an RPC service on port 7077, we will need to deploy a K8S service for this, the YAML required to do this is shown here:</p><iframe width="100%" frameborder="0" id="gist-a72d3c38d7a3f94e88c7affd28a3034b"></iframe><p>To deploy the Master service, run the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f spark-master-service.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now that we have a Master pod and service up and running, we need to deploy our Workers which are preconfigured to communicate with the Master service.</p><p>The YAML required to deploy the two Worker pods is shown here:</p><iframe width="100%" frameborder="0" id="gist-97ceb93ed35959c41d80fb8c025a7ba1"></iframe><p>To deploy the Worker pods, run the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f spark-worker-deployment.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You can now inspect the Spark processes running on your GKE cluster.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get deployments</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Shows...</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spark-master   1/1     1            1           7m45s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spark-worker   2/2     2            2           9s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Shows...</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spark-master-f69d7d9bc-7jgmj    1/1     Running   0          8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spark-worker-55965f669c-rm59p   1/1     Running   0          24s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spark-worker-55965f669c-wsb2f   1/1     Running   0          24s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Next, as we need to expose the Web UI for the Master process we will create a <em>LoadBalancer</em> resource. The YAML used to do this is provided here:</p><iframe width="100%" frameborder="0" id="gist-56ee86f50f329f99679ff243bb00fb07"></iframe><p>To deploy the LB, you would run the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f spark-ui-lb.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>NOTE</strong> This is just an example, for simplicity we are creating an external <em>LoadBalancer</em> with a public IP, this configuration is likely not be appropriate in most real scenarios, alternatives would include an internal <em>LoadBalancer</em>, retraction of Authorized Networks, a jump host, SSH tunnelling or IAP.</p><p>Now youâ€™re up and running!</p><p>You can access the Master web UI from the Google Console link shown here:</p><p><a target="_blank" href="/assets/files/master-ui-link-c9d78a7032459c01291494b1c26e34ff.png"><img alt="Accessing the Spark Master UI from the Google Cloud Console" src="/assets/images/master-ui-link-c9d78a7032459c01291494b1c26e34ff.png"></a></p><p>The Spark Master UI should look like this:</p><p><a target="_blank" href="/assets/files/spark-master-ui-fa6eecc91847995dea15601166516004.png"><img alt="Spark Master UI" src="/assets/images/spark-master-ui-fa6eecc91847995dea15601166516004.png"></a></p><p>Next we will exec into a Worker pod, get a shell:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -it spark-worker-55965f669c-rm59p -- sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now from within the shell environment of a Worker â€“ which includes all of the Spark client libraries, we will submit a simple Spark application:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">spark-submit --class org.apache.spark.examples.SparkPi \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> --master spark://10.11.250.98:7077 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/spark/examples/jars/spark-examples*.jar 10000</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You can see the results in the shell, as shown here:</p><p><a target="_blank" href="/assets/files/spark-application-example-0f11e071394077ac8c678ed7d3e93791.png"><img alt="Spark Pi Estimator Example" src="/assets/images/spark-application-example-0f11e071394077ac8c678ed7d3e93791.png"></a></p><p>Additionally, as all of the container logs go to Stackdriver, you can view the application logs there as well:</p><p><a target="_blank" href="/assets/files/container-logs-in-stackdriver-350797a4dd5cceab0b4aa12445adeed4.png"><img alt="Container Logs in StackDriver" src="/assets/images/container-logs-in-stackdriver-350797a4dd5cceab0b4aa12445adeed4.png"></a></p><p>This is a simple way to get a Spark cluster running, it is not without its downsides and shortcomings however, which include the limited security mechanisms available (SASL, network security, shared secrets).</p><p>In the final post in this series we will look at Spark on Kubernetes, using Kubernetes as the Spark cluster manager and interacting with Spark using the Kubernetes API and control plane, see you then.</p><blockquote><p>Full source code for this article is available at: <a href="https://github.com/gamma-data/spark-on-gcp" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/spark-on-gcp</a></p></blockquote><p>The infrastructure coding for this example uses Powershell and Terraform, and is deployed as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">PS &gt; .\run.ps1 private-network apply &lt;gcp-project&gt; &lt;region&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS &gt; .\run.ps1 gke apply &lt;gcp-project&gt; &lt;region&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/apache-spark">apache-spark</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloud-dataproc">cloud-dataproc</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/dataproc">dataproc</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gke">gke</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/kubernetes">kubernetes</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/spark">spark</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Spark in the Google Cloud Platform Part 2" href="/spark-in-the-google-cloud-platform-part-2"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/spark-in-the-google-cloud-platform-part-1">Spark in the Google Cloud Platform Part 1</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-02-14T00:00:00.000Z" itemprop="datePublished">February 14, 2020</time> Â· <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/spark-gcp-featured-image.png"><div class="markdown" itemprop="articleBody"><p>I have been an avid Spark enthusiast since 2014 (the early days..). Spark has featured heavily in every project I have been involved with from data warehousing, ETL, feature extraction, advanced analytics to event processing and IoT applications. I like to think of it as a Swiss army knife for distributed processing.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Spark Training Courses</h5></div><div class="admonition-content"><p><a href="https://academy.alphazetta.ai/data-transformation-and-analysis-using-apache-spark/" target="_blank" rel="noopener noreferrer">Data Transformation and Analysis Using Apache Spark</a><br>
<a href="https://academy.alphazetta.ai/stream-and-event-processing-using-apache-spark/" target="_blank" rel="noopener noreferrer">Stream and Event Processing using Apache Spark</a><br>
<a href="https://academy.alphazetta.ai/advanced-analytics-using-apache-spark/" target="_blank" rel="noopener noreferrer">Advanced Analytics Using Apache Spark</a></p></div></div><p>Curiously enough, the first project I had been involved with for some years that did not feature the Apache Spark project was a green field GCP project which got me thinkingâ€¦ where does Spark fit into the GCP landscape?</p><p>Unlike the other major providers who use Spark as the backbone of their managed distributed ETL services with examples such as AWS Glue or the Spark integration runtime option in Azure Data Factory, Googleâ€™s managed ETL solution is Cloud DataFlow. Cloud DataFlow which is a managed Apache Beam service does not use a Spark runtime (there is a Spark Runner however this is not an option when using CDF). So where does this leave Spark?</p><p>My summation is that although Spark is not a first-class citizen in GCP (as far as managed ETL), it is not a second-class citizen either. This article will discuss the various ways Spark clusters and applications can be deployed within the GCP ecosystem.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="quick-primer-on-spark">Quick Primer on Spark<a aria-hidden="true" class="hash-link" href="#quick-primer-on-spark" title="Direct link to heading">â€‹</a></h2><p>Every Spark application contains several components regardless of deployment mode, the components in the Spark runtime architecture are:</p><ul><li>the Driver</li><li>the Master</li><li>the Cluster Manager</li><li>the Executor(s), which run on worker nodes or Workers</li></ul><p>Each component has a specific role in executing a Spark program and all of the Spark components run in Java virtual machines (JVMs).</p><p><a target="_blank" href="/assets/files/spark-runtime-0b55b3d8793bab097b517603866abe16.png"><img alt="Spark Runtime Architecture" src="/assets/images/spark-runtime-0b55b3d8793bab097b517603866abe16.png"></a></p><p>Cluster Managers schedule and manage distributed resources (compute and memory) across the nodes of the cluster. Cluster Managers available for Spark include:</p><ul><li>Standalone</li><li>YARN (Hadoop)</li><li>Mesos</li><li>Kubernetes</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="spark-on-dataproc">Spark on DataProc<a aria-hidden="true" class="hash-link" href="#spark-on-dataproc" title="Direct link to heading">â€‹</a></h2><p>This is perhaps the simplest and most integrated approach to using Spark in the GCP ecosystem.</p><p>DataProc is GCPâ€™s managed Hadoop Service (akin to AWS EMR or HDInsight on Azure). DataProc uses Hadoop/YARN as the Cluster Manager. DataProc clusters can be deployed on a private network (VPC using RFC1918 address space), supports encryption at Rest using Google Managed or Customer Managed Keys in KMS, supports autoscaling and the use of Preemptible Workers, and can be deployed in a HA config.</p><p>Furthermore, DataProc clusters can enforce strong authentication using Kerberos which can be integrated into other directory services such as Active Directory through the use of cross realm trusts.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="deployment">Deployment<a aria-hidden="true" class="hash-link" href="#deployment" title="Direct link to heading">â€‹</a></h3><p>DataProc clusters can be deployed using the <code>gcloud dataproc clusters create</code> command or using IaC solutions such as Terraform. For this article I have included an example in the source code using the <code>gcloud</code> command to deploy a DataProc cluster on a private network which was created using Terraform.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="integration">Integration<a aria-hidden="true" class="hash-link" href="#integration" title="Direct link to heading">â€‹</a></h3><p>The beauty of DataProc is its native integration into IAM and the GCP service plane. Having been a long-time user of AWS EMR, I have found that the usability and integration are in many ways superior in GCP DataProc. Letâ€™s look at some examples...</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="iam-and-iap-tcp-forwarding">IAM and IAP (TCP Forwarding)<a aria-hidden="true" class="hash-link" href="#iam-and-iap-tcp-forwarding" title="Direct link to heading">â€‹</a></h4><p>DataProc is integrated into Cloud IAM using various coarse grained permissions use as <code>dataproc.clusters.use</code> and simplified IAM Roles such as <code>dataproc.editor</code> or <code>dataproc.admin</code>. Members with bindings to the these roles can perform tasks such as submitting jobs and creating workflow templates (which we will discuss shortly), as well as accessing instances such as the master node instance or instances in the cluster using IAP (TCP Forwarding) without requiring a public IP address or a bastion host.</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="dataproc-jobs-and-workflows">DataProc Jobs and Workflows<a aria-hidden="true" class="hash-link" href="#dataproc-jobs-and-workflows" title="Direct link to heading">â€‹</a></h4><p>Spark jobs can be submitted using the console or via <code>gcloud dataproc jobs submit</code> as shown here:</p><p><a target="_blank" href="/assets/files/dataproc-spark-job-953a699ceef00b9e3b0f05068a844a56.png"><img alt="Submitting a Spark Job using gcloud dataproc jobs submit" src="/assets/images/dataproc-spark-job-953a699ceef00b9e3b0f05068a844a56.png"></a></p><p>Cluster logs are natively available in StackDriver and standard out from the Spark Driver is visible from the console as well as via <code>gcloud</code> commands.</p><p>Complex Workflows can be created by adding Jobs as Steps in Workflow Templates using the following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud dataproc workflow-templates add-job spark</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="optional-components-and-the-component-gateway">Optional Components and the Component Gateway<a aria-hidden="true" class="hash-link" href="#optional-components-and-the-component-gateway" title="Direct link to heading">â€‹</a></h4><p>DataProc provides you with a Hadoop cluster including YARN and HDFS, a Spark runtine â€“ which includes Spark SQL and SparkR. DataProc also supports several optional components including Anaconda, Jupyter, Zeppelin, Druid, Presto, and more.</p><p>Web interfaces to some of these components as well as the management interfaces such as the Resource Manager UI or the Spark History Server UI can be accessed through the Component Gateway.</p><p>This is a Cloud IAM integrated gateway (much like IAP) which can allow access through an authenticated and authorized console session to web UIs in the cluster â€“ without the need for SSH tunnels, additional firewall rules, bastion hosts, or public IPs. Very cool.</p><p>Links to the component UIs as well as built in UIs like the YARN Resource Manager UI are available directly from through the console.</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="jupyter">Jupyter<a aria-hidden="true" class="hash-link" href="#jupyter" title="Direct link to heading">â€‹</a></h4><p>Jupyter is a popular notebook application in the data science and analytics communities used for reproducible research. DataProcâ€™s Jupyter component provides a ready-made Spark application vector using PySpark. If you have also installed the Anaconda component you will have access to the full complement of scientific and mathematic Python packages such as Pandas and NumPy which can be used in Jupyter notebooks as well. Using the Component Gateway, Jupyer notebooks can be accessed directly from the Google console as shown here:</p><p><a target="_blank" href="/assets/files/dataproc-jupyter-notebook-14d165b5563c903961beb68bef757a82.png"><img alt="Jupyter Notebooks using DataProc" src="/assets/images/dataproc-jupyter-notebook-14d165b5563c903961beb68bef757a82.png"></a></p><p>From this example you can see that I accessed source data from a GCS bucket and used HDFS as local scratch space.</p><p>Furthermore, notebooks are automagically saved in your integrated Cloud Storage DataProc staging bucket and can be shared amongst analysts or accessed at a later time. These notebooks also persist beyond the lifespan of the cluster.</p><p>Next up we will look at deploying a Spark Standalone cluster on a GKE cluster, see you then!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/apache-spark">apache-spark</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/spark">spark</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Spark in the Google Cloud Platform Part 1" href="/spark-in-the-google-cloud-platform-part-1"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/query-cloud-sql-through-big-query">Query Cloud SQL through Big Query</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-02-08T00:00:00.000Z" itemprop="datePublished">February 8, 2020</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cloud-sql-federated-queries.png"><div class="markdown" itemprop="articleBody"><p>This article demonstrates Cloud SQL federated queries for Big Query, a neat and simple to use feature.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="connecting-to-cloud-sql">Connecting to Cloud SQL<a aria-hidden="true" class="hash-link" href="#connecting-to-cloud-sql" title="Direct link to heading">â€‹</a></h2><p>One of the challenges presented when using Cloud SQL on a private network (VPC) is providing access to users. There are several ways to accomplish this which include:</p><ul><li>open the database port on the VPC Firewall (5432 for example for Postgres) and let users access the database using a command line or locally installed GUI tool <em>(may not be allowed in your environment)</em></li><li>provide a web based interface deployed on your VPC such as PGAdmin deployed on a GCE instance or GKE pod <em>(adds security and management overhead)</em></li><li>use the Cloud SQL proxy <em>(requires additional software to be installed and configured)</em></li></ul><p>In additional, all of the above solutions require direct IP connectivity to the instance which may not always be available. Furthermore each of these operations requires the user to present some form of authentication â€“ in many cases the database user and password which then must be managed at an individual level.</p><p>Enter Cloud SQL federated queries for Big Queryâ€¦</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="big-query-federated-queries-for-cloud-sql">Big Query Federated Queries for Cloud SQL<a aria-hidden="true" class="hash-link" href="#big-query-federated-queries-for-cloud-sql" title="Direct link to heading">â€‹</a></h2><p>Big Query allows you to query tables and views in Cloud SQL (currently MySQL and Postgres) using the Federated Queries feature. The queries could be authorized views in Big Query datasets for example.</p><p>This has the following advantages:</p><ul><li>Allows users to authenticate and use the GCP console to query Cloud SQL</li><li>Does not require direct IP connectivity to the user or additional routes or firewall rules</li><li>Leverages Cloud IAM as the authorization mechanism â€“ rather that unmanaged db user accounts and object level permissions</li><li>External queries can be executed against a read replica of the Cloud SQL instance to offload query IO from the master instance</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="setting-it-up">Setting it up<a aria-hidden="true" class="hash-link" href="#setting-it-up" title="Direct link to heading">â€‹</a></h2><p>Setting up big query federated queries for Cloud SQL is exceptionally straightforward, a summary of the steps are provided below:</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-1-enable-a-public-ip-on-the-cloud-sql-instance">Step 1. Enable a Public IP on the Cloud SQL instance<a aria-hidden="true" class="hash-link" href="#step-1-enable-a-public-ip-on-the-cloud-sql-instance" title="Direct link to heading">â€‹</a></h3><p>This sounds bad, but it isnâ€™t really that bad. You need to enable a public interface for Big Query to be able to establish a connection to Cloud SQL, however this is not accessed through the actual public internet â€“ rather it is accessed through the Google network using the back end of the front end if you will.</p><p>Furthermore, you configure an empty list of authorized networks which effectively shields the instance from the public network, this can be configured in Terraform as shown here:</p><iframe width="100%" frameborder="0" id="gist-81c57a80a7e588b98ea7d294dbaee242"></iframe><p>This configuration change can be made to a running instance as well as during the initial provisioning of the instance.</p><p>As shown below you will get a warning dialog in the console saying that you have no authorized networks - this is by design.</p><p><a target="_blank" href="/assets/files/cloud-sql-publicip-screenshot-53f21feadbfaf3be93f69de3ce771c2f.png"><img alt="Cloud SQL Public IP Enabled with No Authorized Networks" src="/assets/images/cloud-sql-publicip-screenshot-53f21feadbfaf3be93f69de3ce771c2f.png"></a></p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-2-create-a-big-query-dataset-which-will-be-used-to-execute-the-queries-to-cloud-sql">Step 2. Create a Big Query dataset which will be used to execute the queries to Cloud SQL<a aria-hidden="true" class="hash-link" href="#step-2-create-a-big-query-dataset-which-will-be-used-to-execute-the-queries-to-cloud-sql" title="Direct link to heading">â€‹</a></h3><p>Connections to Cloud SQL are defined in a Big Query dataset, this can also be use to control access to Cloud SQL using authorized views controlled by IAM roles.</p><iframe width="100%" frameborder="0" id="gist-8a4beaab134a1c72613347b5822d1724"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-3-create-a-connection-to-cloud-sql">Step 3. Create a connection to Cloud SQL<a aria-hidden="true" class="hash-link" href="#step-3-create-a-connection-to-cloud-sql" title="Direct link to heading">â€‹</a></h3><p>To create a connection to Cloud SQL from Big Query you must first enable the BigQuery Connection API, this is done at a project level.</p><p>As this is a fairly recent feature there isn&#x27;t great coverage with either the <strong><code>bq</code></strong> tool or any of the Big Query client libraries to do this so we will need to use the console for now...</p><p>Under the <em><strong>Resources</strong></em> -&gt; <strong><em>Add Data</em></strong> link in the left hand panel of the Big Query console UI, select <strong><em>Create Connection</em></strong>. You will see a side info panel with a form to enter connection details for your Cloud SQL instance.</p><p>In this example I will setup a connection to a Cloud SQL read replica instance I have created:</p><p><a target="_blank" href="/assets/files/big-query-add-connection-67a0236996204c84c7608a8e6b8f4875.png"><img src="/assets/images/big-query-add-connection-67a0236996204c84c7608a8e6b8f4875.png"></a></p><p>Creating a Big Query Connection to Cloud SQL</p><p>More information on the Big Query Connections API can be found at: <a href="https://cloud.google.com/bigquery/docs/reference/bigqueryconnection/rest" target="_blank" rel="noopener noreferrer">https://cloud.google.com/bigquery/docs/reference/bigqueryconnection/rest</a></p><p>The following permissions are associated with connections in Big Query:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.create  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.get  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.list  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.use  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.update  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.delete</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>These permissions are conveniently combined into the following predefined roles:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">roles/bigquery.connectionAdmin    (BigQuery Connection Admin)         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roles/bigquery.connectionUser     (BigQuery Connection User)          </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="step-4-query-away">Step 4. Query away!<a aria-hidden="true" class="hash-link" href="#step-4-query-away" title="Direct link to heading">â€‹</a></h3><p>Now the connection to Cloud SQL can be accessed using the <strong><code>EXTERNAL_QUERY</code></strong> function in Big Query, as shown here:</p><p><a target="_blank" href="/assets/files/cloud-sql-federated-queries-screenshot-34e49ac369753d8551095e92b7fc6264.png"><img alt="Querying Cloud SQL from Big Query" src="/assets/images/cloud-sql-federated-queries-screenshot-34e49ac369753d8551095e92b7fc6264.png"></a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/big-query">big-query</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bigquery">bigquery</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloudsql">cloudsql</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Query Cloud SQL through Big Query" href="/query-cloud-sql-through-big-query"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/google-cloud-sql-availability-for-postgresql-read-replicas">Google Cloud SQL â€“ Availability for PostgreSQL â€“ Part II (Read Replicas)</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-01-24T00:00:00.000Z" itemprop="datePublished">January 24, 2020</time> Â· <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cloudsql-featured-image.png"><div class="markdown" itemprop="articleBody"><p>In this post we will look at read replicas as an additional method to achieve multi zone availability for Cloud SQL, which gives us - in turn - the ability to offload (potentially expensive) IO operations such as user created backups or read operations without adding load to the master instance.</p><p>In the previous post in this series we looked at Regional availability for PostgreSQL HA using Cloud SQL:</p><p><a href="https://cloudywithachanceofbigdata.com/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql-part-i/" target="_blank" rel="noopener noreferrer"><strong>Google Cloud SQL â€“ Availability, Replication, Failover for PostgreSQL â€“ Part I</strong></a></p><p>Recall that this option was simple to implement and worked relatively seamlessly and transparently with respect to zonal failover.</p><p>Now let&#x27;s look at read replicas in Cloud SQL as an additional measure for availability.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="deploying-read-replicas">Deploying Read Replica(s)<a aria-hidden="true" class="hash-link" href="#deploying-read-replicas" title="Direct link to heading">â€‹</a></h2><p>Deploying read replicas is slightly more involved than simple regional (high) availability, as you will need to define each replica or replicas as a separate Cloud SQL instance which is a slave to the primary instance (the master instance).</p><p>An example using Terraform is provided here, starting by creating the master instance:</p><iframe width="100%" frameborder="0" id="gist-34371a3c7edab140e70208cd7710c25a"></iframe><p>Next you would specify one or more read replicas (typically in a zone other than the zone the master is in):</p><iframe width="100%" frameborder="0" id="gist-980f2d6461db0613b4090413041b5ec5"></iframe><p>Note that several of the options supplied are omitted when creating a read replica database instance, such as the backup and maintenance options - as these operations cannot be performed on a read replica as we will see later.</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-1-212da608bf5ba2aa73198627a0cfe3e1.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-1-212da608bf5ba2aa73198627a0cfe3e1.png" alt="Cloud SQL Instances - showing master and replica"></a><figcaption class="figure-caption">Cloud SQL Instances - showing master and replica</figcaption></figure><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-2-ec13f6b5f93493f369db3f4c11987507.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-2-ec13f6b5f93493f369db3f4c11987507.png" alt="Cloud SQL Master Instance"></a><figcaption class="figure-caption">Cloud SQL Master Instance</figcaption></figure><p>Voila! You have just set up a master instance (the primary instance your application and/or users will connect to) along with a read replica in a different zone which will be asynchronously updated as changes occur on the master instance.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="read-replicas-in-action">Read Replicas in Action<a aria-hidden="true" class="hash-link" href="#read-replicas-in-action" title="Direct link to heading">â€‹</a></h2><p>Now that we have created a read replica, lets see it in action. After connecting to the read replica (like you would any other instance), attempt to access a table that has <strong><em>not</em></strong> been created on the master as shown here:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-3-8d16fdd58297948424c733b59cb58ff5.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-3-8d16fdd58297948424c733b59cb58ff5.png" alt="SELECT operation from the replica instance"></a><figcaption class="figure-caption">SELECT operation from the replica instance</figcaption></figure><p>Now create the table and insert some data on the <strong><em>master</em></strong> instance:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-4-c207e904d4880b5f799bcfdabf7de36a.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-4-c207e904d4880b5f799bcfdabf7de36a.png" alt="Create a table and insert a record on the master instance"></a><figcaption class="figure-caption">Create a table and insert a record on the master instance</figcaption></figure><p>Now try the select operation on the <strong><em>replica</em></strong> instance:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-5-a9412ef5afba9855221998e5551cb19e.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-5-a9412ef5afba9855221998e5551cb19e.png" alt="SELECT operation from the replica instance (after changes have been made on the master)"></a><figcaption class="figure-caption">SELECT operation from the replica instance (after changes have been made on the master)</figcaption></figure><p>It works!</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="some-points-to-note-about-cloud-sql-read-replicas">Some Points to Note about Cloud SQL Read Replicas<a aria-hidden="true" class="hash-link" href="#some-points-to-note-about-cloud-sql-read-replicas" title="Direct link to heading">â€‹</a></h2><ul><li>Users connect to a read replica as a normal database connection (as shown above)</li><li>Google managed backups (using the console or <code>gcloud sql backups create ..</code> ) can <strong><em>NOT</em></strong> be performed against replica instances</li><li>Read replicas can be used to offload IO intensive operations from the the master instance - such as user managed backup operations (e.g. <code>pg_dump</code>)</li></ul><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-6-c367a62c5d3e480fa25ea4d0ea2669cf.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-6-c367a62c5d3e480fa25ea4d0ea2669cf.png" alt="pg_dump operation against a replica instance"></a><figcaption class="figure-caption">pg_dump operation against a replica instance</figcaption></figure><ul><li><strong>BE CAREFUL</strong> Despite their name, read replicas are <strong>NOT</strong> read only, updates can be made which will NOT propagate back to the master instance - you could get yourself in an awful mess if you allow users to perform <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>CREATE</code> or <code>DROP</code> operations against replica instances.</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="promoting-a-read-replica">Promoting a Read Replica<a aria-hidden="true" class="hash-link" href="#promoting-a-read-replica" title="Direct link to heading">â€‹</a></h2><p>If required a read replica can be promoted to a standalone Cloud SQL instance, which is another DR option. Keep in mind however as the read replica is updated in an asynchronous manner, promotion of a read replica may result in a loss of data (hopefully not much but a loss nonetheless). Your application RPO will dictate if this is acceptable or not.</p><p>Promotion of a read replica is reasonably straightforward as demonstrated here using the console:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-7-a4ec8a31ed6601a9e7253ce408893a90.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-7-a4ec8a31ed6601a9e7253ce408893a90.png" alt="Promoting a read replica using the console"></a><figcaption class="figure-caption">Promoting a read replica using the console</figcaption></figure><p>You can also use the following <code>gcloud</code> command:</p><p> gcloud sql instances promote-replica  &lt;replica<!-- -->_<!-- -->instance<!-- -->_<!-- -->name&gt;</p><p>Once you click on the <em>Promote Replica</em> button you will see the following warning:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-8-310006339cb5a3d3c491dfb00fc86c88.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-8-310006339cb5a3d3c491dfb00fc86c88.png" alt=""></a><figcaption class="figure-caption"></figcaption></figure><p><em>Promoting a read replica using the console</em></p><p>This simply states that once you promote the replica instance your instance will become an independent instance with no further relationship with the master instance. Once accepted and the promotion process is complete, you can see that you now have two independent Cloud SQL instances (as advertised!):</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-9-5cbdcea2c489b064bbbc1bad3617fbce.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-9-5cbdcea2c489b064bbbc1bad3617fbce.png" alt="Promoted Cloud SQL instance"></a><figcaption class="figure-caption">Promoted Cloud SQL instance</figcaption></figure><p>Some of the options you would normally configure with a master instance would need to be configured on the promoted replica instance - such as high availability, maintenance and scheduled backups - but in the event of a zonal failure you would be back up and running with virtually no data loss!</p><blockquote><p>Full source code for this article is available at: <a href="https://github.com/gamma-data/cloud-sql-postgres-availability-tutorial" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/cloud-sql-postgres-availability-tutorial</a></p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloudsql">cloudsql</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/ha">ha</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/highavailability">highavailability</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/postgresql">postgresql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Google Cloud SQL â€“ Availability for PostgreSQL â€“ Part II (Read Replicas)" href="/google-cloud-sql-availability-for-postgresql-read-replicas"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql">Google Cloud SQL â€“ Availability, Replication, Failover for PostgreSQL â€“ Part I</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-01-17T00:00:00.000Z" itemprop="datePublished">January 17, 2020</time> Â· <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cloudsql-featured-image.png"><div class="markdown" itemprop="articleBody"><p>In this multi part blog we will explore the features available in Google Cloud SQL for High Availability, Backup and Recovery, Replication and Failover and Security (at rest and in transit) for the PostgreSQL DBMS engine. Some of these features are relatively hot of the press and in Beta â€“ which still makes them available for general use.</p><p>We will start by looking at the High Availability (HA) options available to you when using the PostgreSQL engine in Google Cloud SQL.</p><p>Most of you would be familiar with the concepts of High Availability, Redundancy, Fault Tolerance, etc but letâ€™s start with a definition of HA anyway:</p><blockquote><p>High availability (HA) is a characteristic of a system, which aims to ensure an agreed level of operational performance, usually uptime, for a higher than normal period.</p><p>Wikipedia</p></blockquote><p>Higher than a normal period is quite subjective, typically this is quantified by a percentage represented by a number of â€œ9sâ€, that is 99.99% (which would be quoted as â€œfour ninesâ€), this would allot you 52.60 minutes of downtime over a one-year period.</p><p>Essentially the number of 9â€™s required will drive your bias towards the options available to you for Cloud SQL HA.</p><p>We will start with Cloud SQL HA in its simplest form, Regional Availability.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="regional-availability">Regional Availability<a aria-hidden="true" class="hash-link" href="#regional-availability" title="Direct link to heading">â€‹</a></h2><p>Knowing what we know about the Google Cloud Platform, regional availability means that our application or service (in this case Cloud SQL) should be resilient to a failure of any one zone in our region. In fact, as all GCP regions have at least 3 zones â€“ two zones could fail, and our application would still be available.</p><p>Regional availability for Cloud SQL (which Google refers to as High Availability), creates a standby instance in addition to the primary instance and uses a regional Persistent Disk resource to store the database instance data, transaction log and other state files, which is synchronously replicated to a Persistent Disk resource local to the zones that the primary and standby instances are located in.</p><p>A shared IP address (like a Virtual IP) is used to serve traffic to the healthy (normally primary) Cloud SQL instance.</p><p>An overview of Cloud SQL HA is shown here:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-9f997d42db7d02fc6391cb507e81bc6c.png"><img alt="Cloud SQL High Availability" src="/assets/images/cloud-sql-ha-9f997d42db7d02fc6391cb507e81bc6c.png"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="implementing-high-availability-for-cloud-sql">Implementing High Availability for Cloud SQL<a aria-hidden="true" class="hash-link" href="#implementing-high-availability-for-cloud-sql" title="Direct link to heading">â€‹</a></h2><p>Implementing Regional Availability for Cloud SQL is dead simple, it is one argument:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">availability_type = &quot;REGIONAL&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Using the <code>gcloud</code> command line utility, this would be:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud sql instances create postgresql-instance-1234 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --availability-type=REGIONAL \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --database-version= POSTGRES_9_6</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Using Terraform (with a complete set of options) it would look like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_sql_database_instance&quot; &quot;postgres_ha&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider = google-beta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project = var.project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;postgresql-instance-${random_id.instance_suffix.hex}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  database_version = &quot;POSTGRES_9_6&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  settings {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   tier = var.tier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_size = var.disk_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   activation_policy = &quot;ALWAYS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_autoresize = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_type = &quot;PD_SSD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   **availability_type = &quot;REGIONAL&quot;**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   backup_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     enabled = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     start_time = &quot;00:00&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ip_configuration  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ipv4_enabled = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     private_network = google_compute_network.private_network.self_link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   maintenance_window  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     day = 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     hour = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     update_track = &quot;stable&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> } </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Once deployed you will notice a few different items in the console, first from the instance overview page you can see that the High Availability option is <code>ENABLED</code> for your instance.</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-1-12d875328c3d6743bab7c41038d7e382.png"><img src="/assets/images/cloud-sql-ha-1-12d875328c3d6743bab7c41038d7e382.png"></a></p><p>Second, you will see a Failover button enabled on the detailed management view for this instance.</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-2-39a03f8c41a267780563cbb20bafd2d4.png"><img src="/assets/images/cloud-sql-ha-2-39a03f8c41a267780563cbb20bafd2d4.png"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="failover">Failover<a aria-hidden="true" class="hash-link" href="#failover" title="Direct link to heading">â€‹</a></h2><p>Failovers and failbacks can be initiated manually or automatically (should the primary be unresponsive). A manual failover can be invoked by executing the command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud sql instances failover postgresql-instance-1234</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>There is an <code>--async</code> option which will return immediately, invoking the failover operation asynchronously.</p><p>Failover can also be invoked from the Cloud Console using the Failover button shown previously. As an example I have created a connection to a regionally available Cloud SQL instance and started a command which runs a loop and prints out a counter:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-3-6710a724106c4048213b24a2082b64cb.png"><img src="/assets/images/cloud-sql-ha-3-6710a724106c4048213b24a2082b64cb.png"></a></p><p>Now using the <code>gcloud</code> command shown earlier, I have invoked a manual failover of the Cloud SQL instance.</p><p>Once the failover is initiated, the client connection is dropped (as the server is momentarily unavailable):</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-4-bb4bcf4f70179371b1b26d96a92a4dff.png"><img src="/assets/images/cloud-sql-ha-4-bb4bcf4f70179371b1b26d96a92a4dff.png"></a></p><p>The connection can be immediately re-established afterwards, the state of the running query is lost - <strong><em>importantly no data is lost</em></strong> however. If your application clients had retry logic in their code and they weren&#x27;t executing a long running query, chances are no one would notice! Once reconnecting normal database activities can be resumed:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-5-6f8c7134a54b7a38444f5ddbdbcf960e.png"><img src="/assets/images/cloud-sql-ha-5-6f8c7134a54b7a38444f5ddbdbcf960e.png"></a></p><p>A quick check of the instance logs will show that the failover event has occured:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-6-a4ab88ef121dbc8842347478cf0811d0.png"><img src="/assets/images/cloud-sql-ha-6-a4ab88ef121dbc8842347478cf0811d0.png"></a></p><p>Now when you return to the instance page in the console you will see a Failback button, which indicates that your instance is being served by the standby:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-7-25ae1613611767eea9c101c3a24f0632.png"><img src="/assets/images/cloud-sql-ha-7-25ae1613611767eea9c101c3a24f0632.png"></a></p><p>Note that there may be a slight delay in the availability of this option as the replica is still being synched.</p><p>It is worth noting that nothing comes for free! When you run in REGIONAL or High Availability mode - you are effectively paying double the costs as compared to running in ZONAL mode. However availability and cost have always been trade-offs against one another - you get what you pay for...</p><blockquote><p>More information can be found at: <a href="https://cloud.google.com/sql/docs/postgres/high-availability" target="_blank" rel="noopener noreferrer">https://cloud.google.com/sql/docs/postgres/high-availability</a></p></blockquote><p>Next up we will look at read replicas (and their ability to be promoted) as another high availability alternative in Cloud SQL.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloudsql">cloudsql</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/ha">ha</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/highavailability">highavailability</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/postgresql">postgresql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Google Cloud SQL â€“ Availability, Replication, Failover for PostgreSQL â€“ Part I" href="/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/scalable-secure-application-load-balancing-with-vpc-native-gke-and-istio">Scalable, Secure Application Load Balancing with VPC Native GKE and Istio</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2019-05-18T00:00:00.000Z" itemprop="datePublished">May 18, 2019</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/istio-blog-feature-image.png"><div class="markdown" itemprop="articleBody"><p>At the time of this writing, GCP does not have a generally available non-public facing Layer 7 load balancer. While this is sure to change in the future, this article outlines a design pattern which has been proven to provide scalable and extensible application load balancing services for multiple applications running in Kubernetes pods on GKE.</p><p>When you create a service of type LoadBalancer in GKE, Kubernetes hooks into the provider (GCP in this case) on your behalf to create a Google Load Balancer, while this may be specified as INTERNAL, there are two issues:</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="issue-1">Issue #1:<a aria-hidden="true" class="hash-link" href="#issue-1" title="Direct link to heading">â€‹</a></h3><p>The GCP load balancer created for you is a Layer 4 TCP load balancer.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="issue-2">Issue #2:<a aria-hidden="true" class="hash-link" href="#issue-2" title="Direct link to heading">â€‹</a></h3><p>The normal behaviour is for Google to enumerate all of the node pools in your GKE cluster and â€œautomagicallyâ€ create mapping GCE instance groups for each node pool for each zone the instances are deployed in. This means the entire surface area of your cluster is exposed to the external network â€“ which may not be optimal for internal applications on a multi tenanted cluster.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="the-solution">The Solution:<a aria-hidden="true" class="hash-link" href="#the-solution" title="Direct link to heading">â€‹</a></h3><p>Using <a href="https://istio.io/" target="_blank" rel="noopener noreferrer">Istio</a> deployed on GKE along with the <a href="https://istio.io/docs/concepts/traffic-management/#ingress-and-egress" target="_blank" rel="noopener noreferrer">Istio Ingress Gateway</a> along with an externally created load balancer, it is possible to get scalable HTTP load balancing along with all the normal ALB goodness (stickiness, path-based routing, host-based routing, health checks, TLS offload, etc.).</p><p>An abstract depiction of this architecture is shown here:</p><p><a target="_blank" href="/assets/files/istio-ingress-blog-7f3d087a733de5cfabac40cf44b99bba.png"><img alt="Istio Ingress Design Pattern for VPC Native GKE Clusters" src="/assets/images/istio-ingress-blog-7f3d087a733de5cfabac40cf44b99bba.png"></a></p><p>This can be deployed with a combination of <a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a> and kubectl. The steps to deploy at a high level are:</p><ol><li>Create a GKE cluster with at least two node pools: ingress-nodepool and service-nodepool. Ideally create these node pools as multi-zonal for availability. You could create additional node pools for your Egress Gateway or an operations-nodepool to host Istio, etc as well.</li><li>Deploy Istio.</li><li>Deploy the Istio Ingress Gateway service on the ingress-nodepool using Service type NodePort.</li><li>Create an associated Certificate Gateway using server certificates and private keys for TLS offload.</li><li>Create a service in the service-nodepool.</li><li>Reserve an unallocated static IP address from the node network range.</li><li><a href="https://cloud.google.com/load-balancing/docs/internal/setting-up-internal" target="_blank" rel="noopener noreferrer">Create an internal TCP load balancer</a>:<ol><li>Specify the frontend as the IP address reserved in step 6.</li><li>Specify the backend as the managed instance groups created during the node pool creation for the ingress-nodepool (ingress-nodepool-ig-a, ingress-nodepool-ig-b, ingress-nodepool-ig-c).</li><li>Specify ports 80 and 443.</li></ol></li><li>Create a GCP Firewall Rule to allow traffic from authorized sources (network tags or CIDR ranges) to a target of the ingress-nodepool network tag.</li><li>Create a Cloud DNS A Record for your managed zone as <!-- -->*<!-- -->.namespace.zone pointing to the IP Address assigned to the load balancer frontend in step 7.1.</li><li><a href="https://cloud.google.com/load-balancing/docs/health-checks#firewall_rules" target="_blank" rel="noopener noreferrer">Enable Health Checks through the GCP firewall</a> to reach the ingress-nodepool network tag at a minimum â€“ however there is no harm in allowing these to all node pools.</li></ol><p>The service should then be resolvable and routable from authorized internal networks (peered private VPCs or internal networks connected via VPN or Dedicated Interconnect) as:</p><blockquote><p>https://_service<strong>.</strong>namespace<strong>.</strong>zone<strong>/</strong>endpoint__</p></blockquote><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="the-advantages-of-this-design-pattern-are">The advantages of this design pattern are...<a aria-hidden="true" class="hash-link" href="#the-advantages-of-this-design-pattern-are" title="Direct link to heading">â€‹</a></h3><ol><li>The Ingress Gateway provides fully functional application load balancing services.</li><li>Istio provides service discovery and routing using names and namespaces.</li><li>The Ingress Gateway service and ingress gateway node pool can be scaled as required to meet demand.</li><li>The Ingress Gateway is multi zonal for greater availability</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloud">cloud</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/istio">istio</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/load-balancing">load-balancing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/vpc-native">vpc-native</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Scalable, Secure Application Load Balancing with VPC Native GKE and Istio" href="/scalable-secure-application-load-balancing-with-vpc-native-gke-and-istio"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/gcp-networking-for-aws-professionals">GCP Networking for AWS Professionals</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2019-02-21T00:00:00.000Z" itemprop="datePublished">February 21, 2019</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/gcp-aws-networking.png"><div class="markdown" itemprop="articleBody"><p>GCP and AWS share many similarities, they both provide similar services and both leverage containerization, virtualization and software defined networking.</p><p>There are some significant differences when it comes to their respective implementations, networking is a key example of this.</p><p>Before we compare and contrast the two different approaches to networking, it is worthwhile noting the genesis of the two major cloud providers.</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="google-was-born-to-be-global-amazon-became-global"><em>Google was born to be global, Amazon became global</em><a aria-hidden="true" class="hash-link" href="#google-was-born-to-be-global-amazon-became-global" title="Direct link to heading">â€‹</a></h4><p>By no means am I suggesting that Amazon didn&#x27;t have designs on going global from it&#x27;s beginnings, but AWS was driven (entirely at the beginning) by the needs of the Amazon eCommerce business. Amazon started in the US before expanding into other regions (such as Europe and Australia). In some cases the expansion took decades (Amazon only entered Australia as a retailer in 2018).</p><p>Google, by contrast, was providing application, search and marketing services worldwide from its very beginning. GCP which was used as the vector to deliver these services and applications was architected around this global model, even though their actual data centre expansion may not have been as rapid as AWSâ€™s (for example GCP opened its Australia region 5 years after AWS).</p><p>Their respective networking implementations reflect how their respective companies evolved.</p><h4 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="aws-is-a-leader-in-iaas-gcp-is-a-leader-in-paas"><em>AWS is a leader in IaaS, GCP is a leader in PaaS</em><a aria-hidden="true" class="hash-link" href="#aws-is-a-leader-in-iaas-gcp-is-a-leader-in-paas" title="Direct link to heading">â€‹</a></h4><p>This is only an opinion and may be argued, however if you look at the chronology of the two platforms, consider this:</p><ul><li>The first services released by AWS (simultaneously for all intents and purposes) were S3, SQS and EC2</li><li>The first service released by Google was AppEngine (a pure PaaS offering)</li></ul><p>Google has launched and matured their IaaS offerings since as AWS has done similarly with their PaaS offerings, but they started from much different places.</p><p>With all of that said, here are the key differences when it comes to networking between the two major cloud providers:</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="gcp-vpcs-are-global-by-default-aws-vpcs-are-regional-only">GCP VPCs are Global by default, AWS VPCs are Regional only<a aria-hidden="true" class="hash-link" href="#gcp-vpcs-are-global-by-default-aws-vpcs-are-regional-only" title="Direct link to heading">â€‹</a></h3><p>This is the first fundamental difference between the two providers. Each GCP project is allocated one VPC network with Subnets in each of the 18 GCP Regions. Whereas each AWS Account is allocated one Default VPC in each AWS Region with a Subnet in each AWS Availability Zone for that Region, that is each account has 17 VPCs in each of the 17 Regions (excluding GovCloud regions).</p><p><a target="_blank" href="/assets/files/gcp-default-network-bb8c3f62583663e872cc53948671005f.png"><img alt="Default Global VPC Network in GCP" src="/assets/images/gcp-default-network-bb8c3f62583663e872cc53948671005f.png"></a></p><p>It is entirely possible to create VPCs in GCP which are Regional, but they are Global by default.</p><p>This global tenancy can be advantageous in many cases, but can be limiting in others, for instance there is a limit of 25 peering connections to any one VPC, the limit in AWS is 125.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="gcp-subnets-are-regional-aws-subnets-are-zonal">GCP Subnets are Regional, AWS Subnets are Zonal<a aria-hidden="true" class="hash-link" href="#gcp-subnets-are-regional-aws-subnets-are-zonal" title="Direct link to heading">â€‹</a></h3><p>Subnets in GCP automatically span all Zones in a Region, whereas AWS VPC Subnets are assigned to Availability Zones in a Region. This means you are abstracted from some of the networking and zonal complexity, but you have less control over specific network placement of instances and endpoints. You can infer from this design that Zones are replicated or synchronised within a Region, making them less of a direct consideration for High Availability (or at least as much or your concern as they otherwise would be).</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="all-gcp-firewall-rules-are-stateful">All GCP Firewall Rules are Stateful<a aria-hidden="true" class="hash-link" href="#all-gcp-firewall-rules-are-stateful" title="Direct link to heading">â€‹</a></h3><p>AWS Security Groups are stateful firewall rules â€“ meaning they maintain connection state for inbound connections, AWS also has Network ACLs (NACLs) which are stateless firewall rules. GCP has no direct equivalent of NACLs, however GCP Firewall Rules are more configurable than their AWS counterparts. For instance, GCP Firewall Rules can include Deny actions which is not an option with AWS Security Group Rules.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="load-balancers-in-gcp-are-layer-4-tcpudp-unless-they-are-public-facing">Load Balancers in GCP are layer 4 (TCP/UDP) unless they are public facing<a aria-hidden="true" class="hash-link" href="#load-balancers-in-gcp-are-layer-4-tcpudp-unless-they-are-public-facing" title="Direct link to heading">â€‹</a></h3><p>AWS Application Load Balancers can be deployed in private VPCs with no external IPs attached to them. GCP has Application Load Balancers (Layer 7 load balancers) but only for public facing applications, internal facing load balancers in GCP are Network Load Balancers. This presents some challenges with application level load balancing functionality such as stickiness. There are potential workarounds however such as NGINX in GKE behind</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="firewall-rules-are-at-the-network-level-not-at-the-instance-or-service-level">Firewall rules are at the Network Level not at the Instance or Service Level<a aria-hidden="true" class="hash-link" href="#firewall-rules-are-at-the-network-level-not-at-the-instance-or-service-level" title="Direct link to heading">â€‹</a></h3><p>There are simple firewall settings available at the instance level, these are limited to allowing HTTP and HTTPS traffic to the instance only and donâ€™t allow you to specify sources. Detailed Firewall Rules are set at the GCP VPC Network level and are not attached or associated with instances as they are in AWS.</p><p><em>Hopefully this is helpful for AWS engineers and architects being exposed to GCP for the first time!</em></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/aws">aws</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloud">cloud</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/networking">networking</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GCP Networking for AWS Professionals" href="/gcp-networking-for-aws-professionals"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a href="https://infraql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>InfraQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"></div></div></footer></div>
<script src="/assets/js/runtime~main.bc775c5f.js"></script>
<script src="/assets/js/main.3e8b65bb.js"></script>
</body>
</html>