<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Full Stack Chronicles Blog Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Full Stack Chronicles Blog Feed Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Full Stack Chronicles Blog Feed JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4N6KSJ2G0P"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4N6KSJ2G0P",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Full Stack Chronicles" href="/opensearch.xml"><title data-rh="true">2 posts tagged with &quot;awscloudformation&quot; | Full Stack Chronicles</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://fullstackchronicles.io/tags/awscloudformation"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="2 posts tagged with &quot;awscloudformation&quot; | Full Stack Chronicles"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://fullstackchronicles.io/tags/awscloudformation"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/tags/awscloudformation" hreflang="en"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/tags/awscloudformation" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://MZCGVO503N-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.a53bcfee.css">
<link rel="preload" href="/assets/js/runtime~main.2d0570a6.js" as="script">
<link rel="preload" href="/assets/js/main.37dca0c1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" style="background-color:#A9BCD0;color:#1A4E82" role="banner"><div class="announcementBarContent_KsVm"><b>If you find our content useful, give it a ‚≠êÔ∏è on <a target="_blank" rel="noopener noreferrer" href="https://github.com/stackql/fullstackchronicles.io">GitHub</a>, if you want to contribute and become an author, submit a PR</b></div></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2 navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Full Stack Chronicles</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/tags">Topics</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/snowflake">Snowflake</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/simple-cli-pkce-auth-using-okta">Simple CLI Application to Login to Okta using PKCE</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/cloudy-with-a-chance-of-big-data-has-moved">Cloudy with a Chance of Big Data has Moved</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/scaling-up-prefect-with-gitstorage">Scaling up Prefect with GitStorage</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/implementing-a-serverless-sftp-gateway-using-the-aws-transfer-family">Implementing a Serverless SFTP Gateway using the AWS Transfer Family</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/simple-sso-with-an-external-idp-using-active-directory-and-okta">Simple SSO with an external IdP using Active Directory and Okta</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/converting-to-local-time-in-aws-lambda-using-nodejs">Converting to local time in AWS Lambda using Node.js</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/automating-snowflake-role-based-storage-integration-for-aws">Automating Snowflake Role Based Storage Integration for AWS</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/simplifying-large-cloudformation-templates-using-jsonnet">Simplifying Large CloudFormation Templates using Jsonnet</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/aws-deployments-with-cloudformation-and-gitlab-ci">Simplified AWS Deployments with CloudFormation and GitLab CI</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/from-wordpress-to-jamstack">From Wordpress to Jamstack</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>2 posts tagged with &quot;awscloudformation&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/simplifying-large-cloudformation-templates-using-jsonnet">Simplifying Large CloudFormation Templates using Jsonnet</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-11-21T00:00:00.000Z" itemprop="datePublished">November 21, 2021</time> ¬∑ <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/cloudformation-jsonnet-featured-image.png"><div class="markdown" itemprop="articleBody"><p>CloudFormation templates in large environments can grow beyond a manageable point.  This article provides one approach to breaking up CloudFormation templates into modules which can be imported and used to create a larger template to deploy a complex AWS stack ‚Äì using Jsonnet.  </p><p>Jsonnet is a json pre-processing and templating library which includes features including user defined and built-in functions, objects, and inheritance amongst others.  If you are not familiar with Jsonnet, here are some good resources to start with:  </p><ul><li><a href="https://jsonnet.org/" target="_blank" rel="noopener noreferrer">Jsonnet</a></li><li><a href="https://cloudywithachanceofbigdata.com/using-jsonnet-to-configure-multiple-environments" target="_blank" rel="noopener noreferrer">Blog Article: Using Jsonnet to Configure Multiple Environments</a></li><li><a href="https://docs.infraql.io/blog/using-the-jsonnet-map-function" target="_blank" rel="noopener noreferrer">Blog Article: Using the Jsonnet Map Function</a></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="advantages">Advantages<a class="hash-link" href="#advantages" title="Direct link to heading">‚Äã</a></h2><p>Using Jsonnet you can use imports to break up large stacks into smaller files scoped for each resource.  This approach makes CloudFormation template easier to read and write and allows you to apply the DRY (Do Not Repeat Yourself) coding principle (not possible with native CloudFormation templates.  </p><p>Additionally, although as the template fragments are in Jsonnet format, you can add annotations or comments to your code similar to YAML (not possible with a JSON template alone), although the rendered template is in legal CloudFormation Json format.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="process-overview">Process Overview<a class="hash-link" href="#process-overview" title="Direct link to heading">‚Äã</a></h2><p>The process is summarised here: </p><p><a target="_blank" href="/assets/files/cloudformation-jsonnet-851900d3fb0edfa2930e846dd92c0b31.png"><img loading="lazy" alt="CloudFormation and Jsonnet" src="/assets/images/cloudformation-jsonnet-851900d3fb0edfa2930e846dd92c0b31.png" width="919" height="439" class="img_E7b_"></a> </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="code">Code<a class="hash-link" href="#code" title="Direct link to heading">‚Äã</a></h2><p>This example will deploy a stack with a VPC and an S3 bucket with logging.  The project directory structure would look like this:  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">templates/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ includes/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îÇ  ‚îú‚îÄ vpc.libsonnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îÇ  ‚îú‚îÄ s3landingbucket.libsonnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îÇ  ‚îú‚îÄ s3loggingbucket.libsonnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îÇ  ‚îú‚îÄ tags.libsonnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ template.jsonnet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Lets look at all of the constituent files:  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="templatejsonnet"><code>template.jsonnet</code><a class="hash-link" href="#templatejsonnet" title="Direct link to heading">‚Äã</a></h3><p>This is the root document which will be processed by Jsonnet to render a legal CloudFormation JSON template.  It will import the other files in the includes directory.  </p><iframe width="100%" frameborder="0" id="gist-8f2cc0c464de762f73b3f81c75a13832"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="includestagslibsonnet"><code>includes/tags.libsonnet</code><a class="hash-link" href="#includestagslibsonnet" title="Direct link to heading">‚Äã</a></h3><p>This code module is used to generate re-usable tags for other resources (DRY).  </p><iframe width="100%" frameborder="0" id="gist-82e21743e845355ba0ef7240f1f7327a"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="includesvpclibsonnet"><code>includes/vpc.libsonnet</code><a class="hash-link" href="#includesvpclibsonnet" title="Direct link to heading">‚Äã</a></h3><p>This code module defines a VPC resource to be created with CloudFormation.  </p><iframe width="100%" frameborder="0" id="gist-e79189bbc1cfb8b72bd860c6381f6130"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="includess3loggingbucketlibsonnet"><code>includes/s3loggingbucket.libsonnet</code><a class="hash-link" href="#includess3loggingbucketlibsonnet" title="Direct link to heading">‚Äã</a></h3><p>This code module defines an S3 bucket resource to be created in the stack which will be used for logging for other buckets.  </p><iframe width="100%" frameborder="0" id="gist-187c97deca224617b064c4028ebbbee2"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="includess3landingbucketlibsonnet"><code>includes/s3landingbucket.libsonnet</code><a class="hash-link" href="#includess3landingbucketlibsonnet" title="Direct link to heading">‚Äã</a></h3><p>This code module defines an S3 landing bucket resource to be created in the stack.  </p><iframe width="100%" frameborder="0" id="gist-c0dc5d868809f98ef672aca738bb1e5e"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="testing">Testing<a class="hash-link" href="#testing" title="Direct link to heading">‚Äã</a></h2><p>To test the pre-processing, you will need a Jsonnet binary/executable for your environment.  You can find Docker images which include this for you, or you could build it yourself.  </p><p>Once you have a compiled binary, you can run the following to generate a rendered CloudFormation template.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">jsonnet template.jsonnet -o template.json</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>You can validate this template using the AWS CLI as shown here:  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">aws cloudformation validate-template --template-body file://template.json</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deployment">Deployment<a class="hash-link" href="#deployment" title="Direct link to heading">‚Äã</a></h2><p>In a previous article, <a href="https://cloudywithachanceofbigdata.com/aws-deployments-with-cloudformation-and-gitlab-ci" target="_blank" rel="noopener noreferrer">Simplified AWS Deployments with CloudFormation and GitLab CI</a>, I demonstrated an end-to-end deployment pipeline using GitLab CI.  Jsonnet pre-processing can be added to this pipeline as an initial ‚Äòpreprocess‚Äô stage and job.  A snippet from the <code>.gitlab-ci.yml</code> file is included here:  </p><iframe width="100%" frameborder="0" id="gist-14c4c2fdccb27884c69c31f7b3a17a99"></iframe><p>Enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aws">aws</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/awscloudformation">awscloudformation</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/jsonnet">jsonnet</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gitlab">gitlab</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gitlabci">gitlabci</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/infrastructureascode">infrastructureascode</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/iac">iac</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloudautomation">cloudautomation</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Simplifying Large CloudFormation Templates using Jsonnet" href="/simplifying-large-cloudformation-templates-using-jsonnet"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/aws-deployments-with-cloudformation-and-gitlab-ci">Simplified AWS Deployments with CloudFormation and GitLab CI</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-11-11T00:00:00.000Z" itemprop="datePublished">November 11, 2021</time> ¬∑ <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/gitlabci-cloudformation-featured-image.png"><div class="markdown" itemprop="articleBody"><p>Managing cloud deployments and IaC pipelines can be challenging.  I‚Äôve put together a simple pattern for deploying stacks in AWS using CloudFormation templates using GitLab CI.  </p><p>This deployment framework enables you to target different environments based upon refs (branches or tags) for instance deploy to a dev environment for a push or merge into develop and deploy to prod on a push or merge into main, otherwise just lint/validate (e.g., for a push to a non-protected feature branch).  Templates are uploaded to a designated S3 bucket and staged for use in the pipeline and can be retained as an additional audit trail (in addition to the GitLab project history).  </p><p>Furthermore, you can review changes (by inspecting change set contents) before deploying, saving you from fat finger deployments üòä.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="how-it-works">How it works<a class="hash-link" href="#how-it-works" title="Direct link to heading">‚Äã</a></h2><p>The logic is described here:  </p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Flow</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">PlantUML</li></ul><div class="margin-vert--md"><div role="tabpanel"><p><a target="_blank" href="/assets/files/gitlabci-cloudformation-flow-27282ec6781a04b2c32d1ac1d5fa01a5.png"><img loading="lazy" alt="GitLab CI" src="/assets/images/gitlabci-cloudformation-flow-27282ec6781a04b2c32d1ac1d5fa01a5.png" width="449" height="774" class="img_E7b_"></a> </p></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT language-plantuml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-plantuml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partition prepare {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (*) --&gt; === S1 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  === S1 === --&gt; &quot;Validate Template&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; === S2 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  === S1 === --&gt; &quot;Check Stack State&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; === S2 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partition publish {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; &quot;Publish Template to S3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partition plan {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; &quot;Stack Exists?&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; === S3 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  === S3 === --&gt; [Yes] &quot;Create Change Set&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  === S3 === --&gt; [No] === S4 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Create Change Set&quot; --&gt; === S4 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partition deploy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; &quot;MANUAL: Review Changes&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; &quot;Deploy Change Set&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt;(*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><p>The pipleline looks like this in GitLab:  </p><p><a target="_blank" href="/assets/files/gitlab-ci-0f1e6af130941985838f49a568c723d4.png"><img loading="lazy" alt="GitLab CI" src="/assets/images/gitlab-ci-0f1e6af130941985838f49a568c723d4.png" width="1264" height="859" class="img_E7b_"></a>  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">‚Äã</a></h2><p>You will need to set up GitLab CI variables for <code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code> and optionally <code>AWS_DEFAULT_REGION</code>.  You can do this via <strong>Settings -&gt; CI/CD -&gt; Variables</strong> in your GitLab project.   As <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> are secrets, they should be configured as <code>protected</code> (as they are only required for protected branches) and <code>masked</code> so they are not printed in job logs.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="gitlab-ciyml-code"><code>.gitlab-ci.yml</code> code<a class="hash-link" href="#gitlab-ciyml-code" title="Direct link to heading">‚Äã</a></h2><p>The GitLab CI code is shown here:  </p><iframe width="100%" frameborder="0" id="gist-d561e9f002048b4e4be4043cf185d1bd"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="reviewing-change-sets-plans-and-applying">Reviewing change sets (plans) and applying<a class="hash-link" href="#reviewing-change-sets-plans-and-applying" title="Direct link to heading">‚Äã</a></h2><p>Once a pipeline is triggered for an existing stack it will run hands off until a change set (plan) is created.  You can inspect the plan by clicking on the Plan GitLab CI job where you would see output like this:  </p><p><a target="_blank" href="/assets/files/gitlab-ci-cloudformation-plan-fab980e936956a28a98a13ec4f20d48d.png"><img loading="lazy" alt="Change Set" src="/assets/images/gitlab-ci-cloudformation-plan-fab980e936956a28a98a13ec4f20d48d.png" width="1264" height="879" class="img_E7b_"></a>  </p><p>If you are OK with the changes proposed, you can simply hit the play button on the last stage of the pipeline (Deploy).  Voil√†, stack deployed, enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gitlab">gitlab</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gitlabci">gitlabci</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aws">aws</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/awscloudformation">awscloudformation</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/infrastructureascode">infrastructureascode</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/iac">iac</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloudautomation">cloudautomation</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Simplified AWS Deployments with CloudFormation and GitLab CI" href="/aws-deployments-with-cloudformation-and-gitlab-ci"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a href="https://stackql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">StackQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.windrate.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">WindRate<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.2d0570a6.js"></script>
<script src="/assets/js/main.37dca0c1.js"></script>
</body>
</html>