<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Cloudy with a chance of Big Data Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Cloudy with a chance of Big Data Blog Atom Feed"><title data-react-helmet="true">Cloudy with a chance of Big Data | Cloudy with a chance of Big Data</title><meta data-react-helmet="true" property="og:title" content="Cloudy with a chance of Big Data | Cloudy with a chance of Big Data"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="Cloud and data design patterns"><meta data-react-helmet="true" property="og:description" content="Cloud and data design patterns"><meta data-react-helmet="true" property="og:url" content="https://cloudywithachanceofbigdata.github.io/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cloudywithachanceofbigdata.github.io/"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.github.io/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.github.io/" hreflang="x-default"><script data-react-helmet="true">function maybeInsertBanner(){window.__DOCUSAURUS_INSERT_BASEURL_BANNER&&insertBanner()}function insertBanner(){var n=document.getElementById("docusaurus-base-url-issue-banner-container");if(n){n.innerHTML='\n<div id="docusaurus-base-url-issue-banner" style="border: thick solid red; background-color: rgb(255, 230, 179); margin: 20px; padding: 20px; font-size: 20px;">\n   <p style="font-weight: bold; font-size: 30px;">Your Docusaurus site did not load properly.</p>\n   <p>A very common reason is a wrong site <a href="https://docusaurus.io/docs/docusaurus.config.js/#baseurl" style="font-weight: bold;">baseUrl configuration</a>.</p>\n   <p>Current configured baseUrl = <span style="font-weight: bold; color: red;">/</span>  (default value)</p>\n   <p>We suggest trying baseUrl = <span id="docusaurus-base-url-issue-banner-suggestion-container" style="font-weight: bold; color: green;"></span></p>\n</div>\n';var e=document.getElementById("docusaurus-base-url-issue-banner-suggestion-container"),s=window.location.pathname,r="/"===s.substr(-1)?s:s+"/";e.innerHTML=r}}window.__DOCUSAURUS_INSERT_BASEURL_BANNER=!0,document.addEventListener("DOMContentLoaded",maybeInsertBanner)</script><link rel="stylesheet" href="/assets/css/styles.3f66b476.css">
<link rel="preload" href="/assets/js/runtime~main.f77b1e72.js" as="script">
<link rel="preload" href="/assets/js/main.508de973.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div id="docusaurus-base-url-issue-banner-container"></div><div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title">Cloudy with a chance of Big Data</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/tags">Topics</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/using-jsonnet-to-configure-multiple-environments">Using Jsonnet to Configure Multiple Environments</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/use-bigquery-to-trigger-cloud-run">Use BigQuery to trigger Cloud Run</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/azure-static-web-app-review">Azure Static Web App Review</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/introducing-the-metadata-hub-mdh">Introducing the Metadata Hub (MDH)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/masking-private-keys-in-ci-cd-pipelines-in-gitlab">Masking Private Keys in CI/CD Pipelines in GitLab</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/simple-tasker-configuration-driven-orchestration">Simple Tasker: Configuration driven orchestration</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/okta-admin-command-line-interface">Okta Admin Command Line Interface</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/enumerating-all-roles-for-a-user-in-snowflake">Enumerating all roles for a user in Snowflake</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/eventarc-the-state-of-eventing-in-google-cloud">EventArc: The state of eventing in Google Cloud</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/microservices-concepts-orchestration-versus-choreography">Microservices Concepts: Orchestration versus Choreography</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/using-jsonnet-to-configure-multiple-environments">Using Jsonnet to Configure Multiple Environments</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-24T00:00:00.000Z" itemprop="datePublished">June 24, 2021</time> Â· 3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/mpstella" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="http://1.gravatar.com/avatar/9a7465656212285f24f64326cd38d6c9?s=80" alt="Mark Stella"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/mpstella" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Mark Stella</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Cloud Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Everytime I start a new project I try and optimise how the application can work across multiple envronments. For those who don&#x27;t have the luxury of developing everything in docker containers or isolated spaces, you will know my pain. How do I write code that can run on my local <code>dev</code> environment, migrate to the shared <code>test</code> and <code>ci</code> environment and ultimately still work in <code>production</code>.</p><p>In the past I tried exotic options like dynamically generating <code>YAML</code> or <code>JSON</code> using Jinja. I then graduated to <code>HOCON</code> which made my life so much easier. This was until I stumbled across <a href="https://jsonnet.org/" target="_blank" rel="noopener noreferrer">Jsonnet</a>. For those who have not seen this in action, think JSON meets Jinja meets HOCON (a Frankenstein creation that I have actually built in the past)</p><p>To get a feel for how it looks, below is a contrived example where I require 3 environments (dev, test and production) that have different paths, databases and vault configuration.</p><p>Essentially, when this config is run through the Jsonnet templating engine, it will expect a variable &#x27;<code>ENV</code>&#x27; to ultimately refine the <code>environment</code> entry to the one we specifically want to use.</p><p>A helpful thing I like to do with my programs is give users a bit of information as to what environments can be used. For me, running a cli that requires args should be as informative as possible - so listing out all the environments is mandatory. I achieve this with a little trickery and a lot of help from the <a href="https://click.palletsprojects.com/" target="_blank" rel="noopener noreferrer">click</a> package!</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly jsonnet"><pre tabindex="0" class="prism-code language-jsonnet codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">local exe = &quot;application.exe&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local Environment(prefix) = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  root: &quot;/usr/&quot; + prefix + &quot;/app&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  path: self.root + &quot;/bin/&quot; + exe,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  database: std.asciiUpper(prefix) + &quot;_DB&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tmp_dir: &quot;/tmp/&quot; + prefix</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local Vault = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  local uri = &quot;http://127.0.0.1:8200/v1/secret/app&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  _: {},</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  dev: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      secrets_uri: uri,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      approle: &quot;local&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tst: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      secrets_uri: uri,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      approle: &quot;local&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  prd: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      secrets_uri: &quot;https://vsrvr:8200/v1/secret/app&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      approle: &quot;sa_user&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  environments: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _: {},</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev: Environment(&quot;dev&quot;) + Vault[std.extVar(&quot;ENV&quot;)],</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    tst: Environment(&quot;tst&quot;) + Vault[std.extVar(&quot;ENV&quot;)],</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    prd: Environment(&quot;prd&quot;) + Vault[std.extVar(&quot;ENV&quot;)]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment: $[&quot;environments&quot;][std.extVar(&quot;ENV&quot;)],</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The trick I perform is to have a placeholder entry &#x27;<code>_</code>&#x27; that I use to initially render the template. I then use the generated JSON file and get all the environment keys so I can feed that directly into click.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Dict</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> click</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> json</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> _jsonnet</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pprint </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pprint</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV_JSONNET </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;environment.jsonnet&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV_PFX_PLACEHOLDER </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;_&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">parse_environment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _json_str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _jsonnet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">evaluate_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ENV_JSONNET</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ext_vars</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;ENV&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prefix</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_json_str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parse_environment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prefix</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ENV_PFX_PLACEHOLDER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">_env_prefixes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">k </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> k </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> _config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;environments&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> ENV_PFX_PLACEHOLDER</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@click</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">command</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;EnvMgr&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@click</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;-e&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;--environment&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    required</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">click</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Choice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_env_prefixes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> case_sensitive</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">help</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Which environment this is executing on&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cli</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parse_environment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">environment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pprint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;environment&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    cli</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This now allows me to execute the application with both list checking (has the user selected an allowed environment?) and the autogenerated help that click provides.</p><p>Below shows running the cli with no arguments:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> python cli.py</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Usage: cli.py </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OPTIONS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Try </span><span class="token string" style="color:#e3116c">&#x27;cli.py --help&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> help.</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Missing option </span><span class="token string" style="color:#e3116c">&#x27;-e&#x27;</span><span class="token plain"> / </span><span class="token string" style="color:#e3116c">&#x27;--environment&#x27;</span><span class="token builtin class-name">.</span><span class="token plain"> Choose from:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        dev,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        prd,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        tst</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Executing the application with a valid environment:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> python cli.py -e dev</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;approle&#x27;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;local&#x27;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;database&#x27;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;DEV_DB&#x27;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;path&#x27;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/usr/dev/app/bin/application.exe&#x27;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;root&#x27;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/usr/dev/app&#x27;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;secrets_uri&#x27;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;http://127.0.0.1:8200/v1/secret/app&#x27;</span><span class="token plain">,</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;tmp_dir&#x27;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/tmp/dev&#x27;</span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Executing the application with an invalid environment:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> python cli.py -e prd3</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Usage: cli.py </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OPTIONS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Try </span><span class="token string" style="color:#e3116c">&#x27;cli.py --help&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> help.</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Invalid value </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;-e&#x27;</span><span class="token plain"> / </span><span class="token string" style="color:#e3116c">&#x27;--environment&#x27;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;prd3&#x27;</span><span class="token plain"> is not one of </span><span class="token string" style="color:#e3116c">&#x27;dev&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;prd&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;tst&#x27;</span><span class="token builtin class-name">.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is only the tip of what Jsonnet can provide, I am continually learning more about the templating engine and the tool.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/ci-cd">ci-cd</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/configuration">configuration</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/envconfig">envconfig</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/environments">environments</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/hocon">hocon</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/json">json</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/jsonnet">jsonnet</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/use-bigquery-to-trigger-cloud-run">Use BigQuery to trigger Cloud Run</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-19T00:00:00.000Z" itemprop="datePublished">June 19, 2021</time> Â· 4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="http://2.gravatar.com/avatar/58faa98ad68138dd1997f828f00a882e?s=80" alt="Tom Klimovski"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Tom Klimovski</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Cloud Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>So you&#x27;re using BigQuery (BQ). It&#x27;s all set up and humming perfectly. Maybe now, you want to run an ELT job whenever a new table partition is created, or maybe you want to retrain your ML model whenever new rows are inserted into the BQ table.</p><p>In my previous article on <a href="https://cloudywithachanceofbigdata.com/eventarc-the-state-of-eventing-in-google-cloud/" target="_blank" rel="noopener noreferrer">EventArc</a>, we went through how Logging can help us create eventing-type functionality in your application. Let&#x27;s take it a step further and walk through how we can couple BigQuery and Cloud Run.</p><p>In this article you will learn how to</p><ul><li>Tie together BigQuery and Cloud Run</li><li>Use BigQuery&#x27;s audit log to trigger Cloud Run</li><li>With those triggers, run your required code</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="lets-go"></a>Let&#x27;s go!<a class="hash-link" href="#lets-go" title="Direct link to heading">#</a></h2><p>Let&#x27;s create a temporary dataset within BigQuery named <code>tmp_bq_to_cr</code>.</p><p>In that same dataset, let&#x27;s create a table in which we will insert some rows to test our BQ audit log. Let&#x27;s grab some rows from a BQ public dataset to create this table:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> tmp_bq_to_cr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud_run_trigger </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> country_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> new_persons_vaccinated</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> population</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain">bigquery</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">covid19_open_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">covid19_open_data</span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> country_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;Australia&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">date</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021-05-31&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Following this, let&#x27;s run an insert query that will help us build our mock database trigger:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> tmp_bq_to_cr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud_run_trigger</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;2021-06-18&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Australia&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now, in another browser tab let&#x27;s navigate to <a href="https://console.cloud.google.com/logs/query;query=bigquery.v2?_ga=2.187390252.-505923201.1592376029" target="_blank" rel="noopener noreferrer">BQ Audit Events</a> and look for our <code>INSERT INTO</code> event:</p><p><a target="_blank" href="/assets/files/bq-insert-event-69f31456522fd0a5d613b44c3a7171a9.png"><img alt="BQ-insert-event" src="/assets/images/bq-insert-event-69f31456522fd0a5d613b44c3a7171a9.png"></a></p><p>There will be several audit logs for any given BQ action. Only after a query is parsed does BQ know which table we want to interact with, so the initial log will, for e.g., not have the table name.</p><p>We don&#x27;t want any old audit log, so we need to ensure we look for a unique set of attributes that clearly identify our action, such as in the diagram above.</p><p>In the case of inserting rows, the attributes are a combination of</p><ul><li>The method is <code>google.cloud.bigquery.v2.JobService.InsertJob</code></li><li>The name of the table being inserted to is the <code>protoPayload.resourceName</code></li><li>The dataset id is available as <code>resource.labels.dataset_id</code></li><li>The number of inserted rows is <code>protoPayload.metadata.tableDataChanged.insertedRowsCount</code></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="time-for-some-code"></a>Time for some code<a class="hash-link" href="#time-for-some-code" title="Direct link to heading">#</a></h2><p>Now that we&#x27;ve identified the payload that we&#x27;re looking for, we can write the action for Cloud Run. We&#x27;ve picked Python and Flask to help us in this instance. (<a href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/blogs/cloud_run/main.py" target="_blank" rel="noopener noreferrer">full code is on GitHub</a>).</p><p>First, let&#x27;s filter out the noise and find the event we want to process</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Gets the Payload data from the Audit Log</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;resource&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;labels&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;dataset_id&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;resource&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;labels&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;project_id&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        tbl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;protoPayload&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;resourceName&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        rows </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;protoPayload&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;metadata&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;tableDataChange&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;insertedRowsCount&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ds </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;cloud_run_tmp&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           tbl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">endswith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;tables/cloud_run_trigger&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> rows </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> create_agg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table created&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># if these fields are not in the JSON, ignore</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ok&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now that we&#x27;ve found the event we want, let&#x27;s execute the action we need. In this example, we&#x27;ll aggregate and write out to a new table <code>created_by_trigger</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">create_agg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bigquery</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    CREATE OR REPLACE TABLE tmp_bq_to_cr.created_by_trigger AS</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    SELECT</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">      count_name, SUM(new_persons_vaccinated) AS n</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    FROM tmp_bq_to_cr.cloud_run_trigger</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> query</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The Dockerfile for the container is simply a basic Python container into which we install Flask and the BigQuery client library:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly docker"><pre tabindex="0" class="prism-code language-docker codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">FROM python:3.9-slim</span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install Flask==1.1.2 gunicorn==20.0.4 google-cloud-bigquery</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV APP_HOME /app</span></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR $APP_HOME</span></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY *.py ./</span></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD exec gunicorn --bind :$PORT main:app</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="now-we-cloud-run"></a>Now we Cloud Run<a class="hash-link" href="#now-we-cloud-run" title="Direct link to heading">#</a></h2><p>Build the container and deploy it using a couple of gcloud commands:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">SERVICE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bq-cloud-run</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">PROJECT</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">gcloud config get-value project</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CONTAINER</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;gcr.io/</span><span class="token string variable" style="color:#36acaa">${PROJECT}</span><span class="token string" style="color:#e3116c">/</span><span class="token string variable" style="color:#36acaa">${SERVICE}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud builds submit --tag </span><span class="token variable" style="color:#36acaa">${CONTAINER}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud run deploy </span><span class="token variable" style="color:#36acaa">${SERVICE}</span><span class="token plain"> --image </span><span class="token variable" style="color:#36acaa">$CONTAINER</span><span class="token plain"> --platform managed</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="i-always-forget-about-the-permissions"></a>I always forget about the permissions<a class="hash-link" href="#i-always-forget-about-the-permissions" title="Direct link to heading">#</a></h2><p>In order for the trigger to work, the Cloud Run service account will need the following permissions:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud projects add-iam-policy-binding </span><span class="token variable" style="color:#36acaa">$PROJECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --member</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;serviceAccount:service-</span><span class="token string variable" style="color:#36acaa">${PROJECT_NO}</span><span class="token string" style="color:#e3116c">@gcp-sa-pubsub.iam.gserviceaccount.com&quot;</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --role</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;roles/iam.serviceAccountTokenCreator&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud projects add-iam-policy-binding </span><span class="token variable" style="color:#36acaa">$PROJECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --member</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">serviceAccount:</span><span class="token variable" style="color:#36acaa">${SVC_ACCOUNT}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --role</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;roles/eventarc.admin&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="finally-the-event-trigger"></a>Finally, the event trigger<a class="hash-link" href="#finally-the-event-trigger" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud eventarc triggers create </span><span class="token variable" style="color:#36acaa">${SERVICE}</span><span class="token plain">-trigger </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --location </span><span class="token variable" style="color:#36acaa">${REGION}</span><span class="token plain"> --service-account </span><span class="token variable" style="color:#36acaa">${SVC_ACCOUNT}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --destination-run-service </span><span class="token variable" style="color:#36acaa">${SERVICE}</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --event-filters </span><span class="token assign-left variable" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">google.cloud.audit.log.v1.written </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --event-filters </span><span class="token assign-left variable" style="color:#36acaa">methodName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">google.cloud.bigquery.v2.JobService.InsertJob </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --event-filters </span><span class="token assign-left variable" style="color:#36acaa">serviceName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bigquery.googleapis.com</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Important to note here is that we&#x27;re triggering on <em>any</em> Insert log created by BQ That&#x27;s why in this action we had to filter these events based on the payload.</p><header><h1>Take it for a spin</h1></header><p>Now, try out the BigQuery -&gt; Cloud Run trigger and action. Go to the BigQuery console and insert a row or two:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> tmp_bq_to_cr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud_run_trigger</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;2021-06-18&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Australia&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25000</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Watch as a new table called <code>created_by_trigger</code> gets created! You have successfully triggered a Cloud Run action on a database event in BigQuery.</p><p>Enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/big-query">big-query</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bigquery">bigquery</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/googlecloudplatform">googlecloudplatform</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/azure-static-web-app-review">Azure Static Web App Review</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-18T00:00:00.000Z" itemprop="datePublished">June 18, 2021</time> Â· 3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.github.io/images/AzureStaticWebApp.png"><div class="markdown" itemprop="articleBody"><p>The Azure Static Web App feature is relatively new in the Azure estate which has recently become generally available, I thought I would take it for a test drive and discuss my findings.</p><p>I am a proponent of the JAMStack architecture for front end applications and a user of CD enabled CDN services like Netlify, so this Azure feature was naturally appealing to me.</p><p>Azure SWAs allow you to serve static assets (like JavaScript) without a origin server, meaning you donâ€™t need a web server, are able to streamline content distribution and web app performance, and reduce the attack surface area of your application.</p><p>The major advantage to using is simplicity, no scaffolding or infra requirements and it is seamlessly integrated into your CI/CD processes (natively if you are using GitHub).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="deploying-static-web-apps-in-azure"></a>Deploying Static Web Apps in Azure<a class="hash-link" href="#deploying-static-web-apps-in-azure" title="Direct link to heading">#</a></h2><p>Pretty simple to setup, aside from a name and a resource group, you just need to supply:</p><ul><li>a <strong>location</strong> (Azure region to be used for serverless back end APIs via Azure Function Apps) note that this is not a location where the static web is necessarily running</li><li>a GitHub or GitLab <strong>repo URL</strong></li><li>the <strong>branch</strong> you wish to use to trigger production deployments (e.g. <code>main</code>)</li><li>a <strong>path</strong> to your code within your app (e.g. where your <code>package.json</code> file is located)</li><li>an <strong>output folder</strong> (e.g. <code>dist</code>) this should not exist in your repo</li><li>a project or personal access <strong>token</strong> for your GitHub account (alternatively you can perform an interactive OAuth2.0 consent if using the portal)</li></ul><p>An example is shown here:</p><iframe width="100%" frameborder="0" id="gist-eef5a25ed01327a180711fd64370c457"></iframe><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="github-actions"></a>GitHub Actions<a class="hash-link" href="#github-actions" title="Direct link to heading">#</a></h2><p>Using the consent provided (either using the OAuth flow or by providing a token), Azure Static Web Apps will automagically create the GitHub Actions workflow to deploy your application on a push or merge event to your repo. This includes providing scoped API credentials to Azure to allow access to the Static Web App resource using secrets in GitHub (which are created automagically as well). An example workflow is shown here:</p><iframe width="100%" frameborder="0" id="gist-8e7ad2bdd9ba351368c5aedad289e972"></iframe><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="preview-or-staging-releases"></a>Preview or Staging Releases<a class="hash-link" href="#preview-or-staging-releases" title="Direct link to heading">#</a></h2><p>Similar to the functionality in analogous services like Netlify, you can configure preview releases of your application to be deployed from specified branches on pull request events.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="routes-and-authorization"></a>Routes and Authorization<a class="hash-link" href="#routes-and-authorization" title="Direct link to heading">#</a></h2><p>Routes (for SPAs) need to be provided to Azure by using a file named <code>staticwebapp.config.json</code> located in the application root of your repo (same level as you <code>package.json</code> file). You can also specify response codes and whether the rout requires authentication as shown here:</p><iframe width="100%" frameborder="0" id="gist-7dd3bcf05474da551b3d311ae0729e18"></iframe><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="pros"></a>Pros<a class="hash-link" href="#pros" title="Direct link to heading">#</a></h2><ul><li>Globally distributed CDN</li><li>Increased security posture, reduced attack surface area</li><li>Simplified architecture and deployment</li><li>No App Service Plan required â€“ cost reduction</li><li>Enables Continuous Deployment â€“ incl preview/staging environments</li><li>TLS and DNS can be easily configured for your app</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="cons"></a>Cons<a class="hash-link" href="#cons" title="Direct link to heading">#</a></h2><ul><li>Serverless API locations are limited</li><li>Integration with other VCS/CI/CD systems like GitLab would need to be custom built (GitHub and Azure DevOps is integrated)</li></ul><p>Overall, this is a good feature for deploying SPAs or PWAs in Azure.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure">azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/jamstack">jamstack</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/microsoft-azure">microsoft-azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/netlify">netlify</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/progressive-web-application">progressive-web-application</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/pwa">pwa</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/react">react</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/single-page-application">single-page-application</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/spa">spa</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/vercel">vercel</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/vue-js">vue-js</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/introducing-the-metadata-hub-mdh">Introducing the Metadata Hub (MDH)</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-15T00:00:00.000Z" itemprop="datePublished">June 15, 2021</time> Â· 10 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="http://2.gravatar.com/avatar/58faa98ad68138dd1997f828f00a882e?s=80" alt="Tom Klimovski"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Tom Klimovski</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Cloud Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Metadata Hub (MDH) is intended to be the source of truth for metadata around the Companyâ€™s platform. It has the ability to load metadata configuration from yaml, and serve that information up via API. It will also be the store of information for pipeline information while ingesting files into the platform.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="key-philosophies"></a>Key philosophies:<a class="hash-link" href="#key-philosophies" title="Direct link to heading">#</a></h2><blockquote><p><strong>Config-Driven</strong>. Anyone who has been authorized to do so, should be able to add another â€˜table-info.yamlâ€™ in to MDH without the need to update any code in the system</p></blockquote><p>Hereâ€™s how table information makes its way into MDH:  </p><figure><a href="/assets/images/mdhoverview-f1928d2566e120de80d74538c4e8a0bc.png"><img src="/assets/images/mdhoverview-f1928d2566e120de80d74538c4e8a0bc.png" alt="Metadata Hub"></a><figcaption class="figure-caption">Metadata Hub</figcaption></figure><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="paths"></a>Paths<a class="hash-link" href="#paths" title="Direct link to heading">#</a></h3><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>/tables</td><td>get:</td><td>summary: All tables in MDH</td><td>description: get the title of all tables that exist in MDH</td></tr><tr><td></td><td>post:</td><td>summary: Creates a new table in MDH</td><td>description: Creates a new table in MDH</td></tr><tr><td>/tables/{id}</td><td>get</td><td>summary: Obtain information about specific table</td><td></td></tr><tr><td>/tables/{id}/columns</td><td>get</td><td>summary: All columns for a particular table</td><td>description: Obtain information on columns for a particular table</td></tr><tr><td>/run</td><td>get</td><td>summary: All information about a particular end-to-end batch run of file ingestion</td><td></td></tr><tr><td></td><td>post</td><td>summary: Update metadata on a batch load</td><td>description: Update metadata on a batch load</td></tr><tr><td>/calendar</td><td>get</td><td>summary: Use this to save on calculation of business days.</td><td>description: This base response gives you today&#x27;s date in a string</td></tr><tr><td>/calendar/previousBusinessDay</td><td>get</td><td>summary: Will return a string of the previous business day</td><td>description: Will return a string of the previous business day, based on the date on when it&#x27;s called</td></tr><tr><td>/calendar/nextBusinessDay</td><td>get</td><td>summary: Will return a string of the next business day</td><td>description: Will return a string of the next business day, based on the date on when it&#x27;s called</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><header><h1>Yaml to Datastore - Entity/Kind design</h1></header><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="datastore-primer"></a>Datastore Primer<a class="hash-link" href="#datastore-primer" title="Direct link to heading">#</a></h3><p>Before we jump right into Entity Groups in Datastore, it is important to first go over the basics and establish a common vocabulary. Datastore holds entities, which are objects, that can contain various key/value pairs, called properties. Each entity must contain a unique identifier, known as a key. When creating an entity, a user can choose to specify a custom key or let Datastore create a key. If a user decides to specify a custom key, it will contain two fields: a kind, which represents a category such as â€˜Toyâ€™ or â€˜Marital Statusâ€™, and a name, which is the identifying value. If a user decides to only specify a kind when creating a key, and does not specify a unique identifier, Datastore automatically generates an ID behind the scenes. Below is an example of a Python3 script which illustrates this identifier concept.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> datastore</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#Custom key- specify my kind=item and a unique_id of broker</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">custom_key_entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Entity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">custom_key_entry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#Only specify kind=item, let datastore generate unique_id</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">datastore_gen_key_entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Entity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">datastore_gen_key_entry</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In your GCP Console under Datastore, you will then see your two entities of kind â€œtableâ€. One will contain your custom key and one will contain the automatically generated key.</p><p>Ancestors and Entity Groups</p><p>For highly related or hierarchical data, Datastore allows entities to be stored in a parent/child relationship. This is known as an entity group or ancestor/descendent relationship.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="entity-group"></a>Entity Group<a class="hash-link" href="#entity-group" title="Direct link to heading">#</a></h3><p><a target="_blank" href="/assets/files/erd-cce67b2304769e80a2dffce456462194.png"><img alt="erd" src="/assets/images/erd-cce67b2304769e80a2dffce456462194.png"></a></p><p><em>This is an example of an entity group with kinds of types: table, column, and classification. The â€˜Grandparentâ€™ in this relationship is the â€˜tableâ€™. In order to configure this, one must first create the table entity. Then, a user can create a column, and specify that the parent is a table key. In order to create the grandchild, a user then creates a classification and sets its parent to be a column key. To further add customizable attributes, a user can specify additional key-value pairs such as pii and data_type. These key-value pairs are stored as properties. We model this diagram in Datastore in our working example below.</em></p><p>One can create entity groups by setting the â€˜parentâ€™ parameter while creating an entity key for a child. This command adds the parent key to be part of the child entity key. The childâ€™s key is represented as a tuple (â€˜parent_keyâ€™, â€˜child_keyâ€™), such that the parentsâ€™ key is the prefix of the key, which is followed by its own unique identifier. For example, follow the diagram above:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">table_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">column_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;broker_legal_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parent</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">table_key</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Printing the variable <code>table_key</code> will display: <code>(&quot;table&quot;, &quot;broker&quot;,&quot;column&quot;, &quot;broker_legal_name&quot;)</code></p><p>Datastore also supports chaining of parents, which can lead to very large keys for descendants with a long lineage of ancestors. Additionally, parents can have multiple children (representing a one-to-many relationship). However, there is no native support for entities to have multiple parents (representing a many-to-many relationship). Once you have configured this ancestral hierarchy, it is easy to retrieve all descendants for a given parent. You can do this by querying on the parent key by using the â€˜ancestorâ€™ parameter. For example, given the entity table_key created above, I can query for all of the tables</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">columns</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my_query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ancestor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> column_key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>A Full Working Example for MDH</h1></header><p>As per our Key Philosophies - <strong><em>Config-Driven</em></strong> - anyone should be able to add a new <code>table</code> to be processed and landed in a target-table somewhere within MDH with our yaml syntax. Below is a full working python3 example of the table/column/classification hierarchical model described above.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> datastore</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">datastore_client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Entities with kinds- table, column, classification</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">my_entities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;snapshot&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;notes&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;describes mortgage brokers&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_legal_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;data_type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;string&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;nullable&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_short_code&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;data_type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;string&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;nullable&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;classif_id_REQ_01&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;restriction_level&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pii&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;if&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;greater than 90 days&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_legal_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;classif_id_REQ_03&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;restriction_level&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;restricted&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pii&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;if&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;less than 90 days&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_legal_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;classif_id_REQ_214&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;restriction_level&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pii&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_short_code&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># traverse my_entities, set parents and add those to datastore</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> entity </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> my_entities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entity</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;kind&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    parent_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> kind </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        parent_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> entity</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> kind </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        parent_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;table&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> entity</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;table_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          </span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> entity</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> entity</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kind</span><span class="token operator" style="color:#393A34">+</span><span class="token string" style="color:#e3116c">&quot;_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        parent</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">parent_key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    datastore_entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Entity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    datastore_entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Saving: {}&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">datastore_entry</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The code above assumes that youâ€™ve set yourself up with a working Service Account or authorised yourself in, and that your GCP project has been set.</p><p>Now letâ€™s do some digging around our newly minted Datastore model. Letâ€™s grab the column â€˜broker_legal_nameâ€™</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">query1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;column&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">query1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;column_id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;=&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;broker_legal_name&quot;</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now that we have the column entity, letâ€™s locate itâ€™s parent id.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">column </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;This column belongs to: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">column</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id_or_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Further to this, we can also get all data classification elements attributed to a single column using the ancestor clause query.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">query2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ancestor</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">column</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> classification </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classification</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classification</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;restriction_level&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For more complex queries, Datastore has the concept of indexes being set, usually via itâ€™s index.yaml configuration. The following is an example of an <code>index.yaml</code> file:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">indexes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cat</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ancestor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> no</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">properties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> age</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">direction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> desc</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cat</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">properties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">direction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> asc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> whiskers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">direction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> desc</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Store</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ancestor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">properties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> business</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">direction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> asc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> owner</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">direction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> asc</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Indexes are important when attempting to add filters on more than one particular attribute within a Datastore entity. For example, the following code will fail:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Adding a &#x27;&gt;&#x27; filter will cause this to fail. Sidenote; it will work</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># without an index if you add another &#x27;=&#x27; filter.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">query2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;classification&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ancestor</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">column</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">query2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pii&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> classification </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classification</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classification</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;classification_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To rectify this issue, you need to create an index.yaml that looks like the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">indexes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> classification</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ancestor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">properties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pii</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You would usually upload the yaml file using the gcloud commands:</p><p><code>gcloud datastore indexes create path/to/index.yaml.</code></p><p>However, letâ€™s do this programmatically.</p><p>The official pypi package for google-cloud-datastore can be found here: <a href="https://pypi.org/project/google-cloud-datastore/" target="_blank" rel="noopener noreferrer">https://pypi.org/project/google-cloud-datastore/</a>. At the time of writing, Firestore in Datastore-mode will be the way forward, as per the release note from January 31, 2019.</p><blockquote><p>Cloud Firestore is now Generally Available. Cloud Firestore is the new version of Cloud Datastore and includes a backwards-compatible Datastore mode.</p></blockquote><blockquote><p>If you intend to use the Cloud Datastore API in a new project, use Cloud Firestore in Datastore mode. Existing Cloud Datastore databases will be automatically upgraded to Cloud Firestore in Datastore mode.</p></blockquote><blockquote><p>Except where noted, the Cloud Datastore documentation now describes behavior for Cloud Firestore in Datastore mode.</p></blockquote><p>Weâ€™ve purposefully created MDH in Datastore to show you how it was done originally, and weâ€™ll be migrating the Datastore code to Firestore in an upcoming post.</p><p>Creating and deleting indexes within Datastore will need to be done through the REST API via googleapiclient.discovery, as this function doesnâ€™t exist via the google-cloud-datastore API. Working with the discovery api client can be a bit daunting for a first-time user, so hereâ€™s the code to add an index on Datastore:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oauth2 </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> service_account</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> googleapiclient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">discovery </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> build</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> datastore</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SCOPES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;https://www.googleapis.com/auth/cloud-platform&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_ACCOUNT_FILE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;GOOGLE_APPLICATION_CREDENTIALS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">PROJECT_ID </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;PROJECT_ID&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">credentials </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> service_account</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Credentials</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_service_account_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SERVICE_ACCOUNT_FILE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scopes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">SCOPES</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">datastore_api </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;datastore&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;v1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> credentials</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">credentials</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;ancestor&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ALL_ANCESTORS&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;kind&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;classification&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;properties&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;name&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;pii&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;direction&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;DESCENDING&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datastore_api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">projects</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">indexes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">projectId</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">PROJECT_ID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>How did we craft this API request? We can use the Google API Discovery Service to build client libraries, IDE plugins, and other tools that interact with Google APIs. The Discovery API provides a list of Google APIs and a machine-readable &quot;Discovery Document&quot; for each API. Features of the Discovery API:</p><ul><li>A directory of supported APIs schemas based on JSON Schema.</li><li>A machine-readable &quot;Discovery Document&quot; for each of the supported APIs. Each document contains:</li><li>A list of API methods and available parameters for each method.</li><li>A list of available OAuth 2.0 scopes.</li><li>Inline documentation of methods, parameters, and available parameter values.</li></ul><p>Navigating to the API reference page for Datastore and going to the â€˜Datastore Adminâ€™ API page, we can see references to the Indexes and RESTful endpoints we can hit for those Indexes. Therefore, looking at the link for the Discovery document for Datastore:</p><blockquote><p><a href="https://datastore.googleapis.com/$discovery/rest?version=v1" target="_blank" rel="noopener noreferrer">https://datastore.googleapis.com/$discovery/rest?version=v1</a></p></blockquote><p>From this, we can build out our instantiation for the google api discovery object build(&#x27;datastore&#x27;, &#x27;v1&#x27;, credentials=credentials)</p><p>With respect to building out the body aspect of the request, Iâ€™ve found crafting that part within the â€˜Try this APIâ€™ section of <code>https://cloud.google.com/datastore/docs/reference/admin/rest/v1/projects.indexes/create</code> pretty valuable.</p><p>With this code, your index should show up in your Datastore console! You can also retrieve them within gcloud with gcloud datastore indexes list if youâ€™d like to verify the indexes outside our python code. So there you have it: a working example of entity groups, ancestors, indexes and Metadata within Datastore. Have fun coding!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/metadata">metadata</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/masking-private-keys-in-ci-cd-pipelines-in-gitlab">Masking Private Keys in CI/CD Pipelines in GitLab</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-15T00:00:00.000Z" itemprop="datePublished">June 15, 2021</time> Â· 2 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Big fan of GitLab (and GitLab CI in particular). I had a recent requirement to push changes to a wiki repo associated with a GitLab project through a GitLab CI pipeline (using the SaaS version of GitLab) and ran into a conundrumâ€¦</p><p>Using the GitLab SaaS version - deploy tokens canâ€™t have write api access, so the next best solution is to use deploy keys, adding your public key as a deploy key and granting this key write access to repositories is relatively straightforward.</p><p>This issue is when you attempt to create a masked GitLab CI variable using the private key from your keypair, you get thisâ€¦</p><p><a target="_blank" href="/assets/files/masked-variable-a71bee3c260fb07842a2cf68e9f8b37e.png"><img src="/assets/images/masked-variable-a71bee3c260fb07842a2cf68e9f8b37e.png"></a></p><p>I was a bit astonished to see this to be honestâ€¦ Looks like it has been raised as an issue several times over the last few years but never resolved (the root cause of which is something to do with newline characters or base64 encoding or the overall length of the string).</p><p>I came up with a solution! Not pretty but effective, masks the variable so that it cannot be printed in CI logs as shown here:</p><p><a target="_blank" href="/assets/files/ci-ssh-key-21fa947e5812357fc909715776d842dd.png"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZIAAAC9CAIAAAAWbWz6AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAABBQSURBVHhe7Z3tddu4EkBfC2lg00AqiDtYN+BtwEXsSTdOI3YXyjmvB3fwHgafMwAoyTQFCvS9P/ZQIARClOYG4CYz//kGADAVaAsAJgNtAcBkoC0AmAy0BQCTgbYAYDLQFgBMBtoCgMlAWwAwGWgLACZjoLb++vn0nPjn5/fY+v3nP7Et8fTzr3gOAKBln9XWj7+fn//+EV9ofjw+Pz/2TtwH/76+/69w+h2bX/7EFs/pJTab9tDZ9gyNLyd39P76S85/+/b7VI57qBHSha6flRvcXeotDu86pONfaoj31399W6dRWvL4/rrlw9b0Z+U/bKLbGKb66+3d3gfpk/qHieVLV293hFN6/uoOd3AjpE/tpx0v5G9XxjXWs9KdYSD7aOv7w1NXW05nTw9pHXaH6EBVflHxn/Ex86cf1La/xMx71sFZbemwKcfVrFyrj8DOrGRwuVTonDv05r/4oUqU6uu29GelBCGN+u3qlEPerl7q2+JO/Xlx06t8ITfE3HA723PkS9u36ItGpEO+Ld37BgPYRVuyMeysqWQXecdLLUcViilIOj/fOiYNtr+Pmd8SivKqEyoZG9j5pdGHa4yB15/V++vL27vtYEIxsdhYotpct6E/K/URpEPv40QWBeH0JEOp+x/4vLbqO9b9LvK0z398uCVjtSV7QE95tlW496WWQ36pmfKTdT93hbSXEBJ/CToebHiEmHEx5oPhjLbqOElhqdvlcvG4nVUc3PX3lyjTSJ/LBHmnUa5o0fOx9GdV3FRWi5FKW7qDPuXmkIcyV+9qq7B0VwU//lvtwfzdBfJ98Bd6lY93lRNhe/bZJHaeYclSa+3DePXzsjpIlJ9st1H/vnMk9BqXBWH+lG5CqOrQ05Yf0L3F/XcpwPTVBZlh0lamdGhnlQd3p9wbmw7h5hh32MZ0xUA9H0t/Vt37H0j3ISMjpDuTO6vj8CkyXW1dZ5Y0q1Zb/e/C9zenrv4JhXkm8vS6jTKBRP1Vfm120pZ4y0hq8SH9XWECtYTZGUEEqg72ZR7H/cpPL4uh4qgCO71c0Me5Wbm3+MdDbTA0wS+kxo9qqz2bP4I7qDRRfTohzFDP0x0b1Aif05a7tPQ3N2T5u+jeOhjGfo/k9T7xM0utkehQlD8J43HvRyxhqYNNd7AvS7i6wJMn5ova8kGbIrMcr9CWhLS/VD1tc4lMatxQW2F9oTt0tOUn7O9IbK/6uJdlhE9rKxzYxQ7auksGais/2HKYZ1v+r27d/1LLIaGYKQEjUV3I7RIDmRAMtmdo1KHo37KsrRCKkdxtWVsK30HHoWg3xJ6ZZ4r8buOW2gqjdSZg3mVvSO2RPIJ/0dNW4dxdVbPyX3Ec09+ijDYg2tqXvTaJAAArQVsAMBloCwAmA20BwGSgLQCYDLQFAJOBtgBgMtAWAEwG2gKAyUBbADAZaAsAJgNtAcBkoC0AmAy0BQCTMVBb/YJjguQITKxKJl9SlOjsIjtTstwsZ3cBgI+zz2pL5zI1VXxWFhyzeaAEydOUMiJ5qZV0SzaFk0enpgrj6ORNcjb276VwMlmZdBI7z/mkVADwcfbRllaVqXyxsnhPT1vvp9Mfr5V/X09/TqHog/D79P72EutNeJr0ckJpNKnp2gvZDqIway60BbA1u2jLFhzzWU/9y9VpThubOFlIZa2TM8gv99/fsVaN4+WPaMVZKWenlMXUkrZq6VzSlh/N5L1EWwBbM1ZbOS9zXXAsnlhbcKyvrV9uneUWVrLmchvD4A63CvOKCR2kxeG3jW6ZpHTjtfWqF2UeuVAhjGC1Va/d0BbA1uyzSTTPsOQ41L/w8uqVULzEgrb82se3R20pp7i39JUUxpGewUxNn/OrLbQFcGt20pYYKqhKNoZqkaV9dj2NTZxKzL4vaCuKKdOpYpAcFO3jXhrpXNYWm0SAW7PfI/m4qrLPs8rK60Ncp63KIGlFphFbaW2pFs8FbUnnSlJoC2BrBmrLbwEjZieoT6yrlniNtt7/+1+7ffOPtE6/7RJMCyh1lmf2UT29zrIiSxTBJdAWwNbstUnclt4i6E5AWwBbg7ZuDNoC2JrjaCtwR/ISYcVJoS2ADTmGtgDgC4G2AGAy0BYATAbaAoDJQFsAMBloCwAmA20BwGSgLQCYDLQFAJOBtgBgMtAWAEzGQG1dU3BsTWpTB/8mEeALsc9qqy44lmyl2z9CmwFCcmmlLKNeaiUTlpyqEmP5jFqRME6dbyv2L34U2nxbrskkcSYDBMD27KMtVXDMZmGm4BgAXGIXbemCY05bOqNp9fJKGps4WVBwDOCgjNVWTr+snmHpjaF/yLWZtig4BnBI9tkk2q1hlplrcsdbbBKTldzax7dHbSmnuLf0lRTGkZ7BTE2f86sttAVwa3bS1tJm8K+fT2v+Z2JjE6cSs+8L2opiypjdXCA5KNrHvTTSuawtNokAt2a/R/KtnuR5/O0q91BwDOAgDNRW2QuaZ1uisMiK7WHgGm1RcAzgIOy1SdyW3iLoTkBbAFuDtm4M2gLYmuNoK3BH8hJhxUmhLYANOYa2AOALgbYAYDLQFgBMBtoCgMlAWwAwGWgLACYDbQHAZKAtAJgMtAUAk4G2AGAy0BYATMYO2grlxXSSmk/nruHfJAJ8IYZr68fj8z+Pj6UERsjDFV+J0TbJbupzaaUso15qJROWnKoSY/mMWpEwTp1vK/YvfhTafFuuySRxJgMEwPYM1lZQlK7cI8dPD8lUKxOc9rRFwTGAgzJUW6lIz1LBsZj/9OMbxcYmThYUHAM4KAO1VUq3ttqSliAsp7ay+LqWvrYoOAZwSIZpq94YKm1FYXn0qetZ0JZf+/j2qC3lFPeWvpLCONIzmKnpc361hbYAbs0obclSq0Gevoun1PJK7xmvp7GJU4nZ9wVtRTFlzG4ukBwU7eNeGulc1habRIBbM/iRfMAsqfzffoiq6hciu8x12qoMklZkGrGV1pZq8VzQlnSuJIW2ALZmf205yt/bWuMsxzXaouAYwEHYRVub01sE3QloC2Br0NaNQVsAW3McbQXuSF4irDgptAWwIcfQFgB8IdAWAEwG2gKAyUBbADAZaAsAJgNtAcBkoC0AmAy0BQCTgbYAYDLQFgBMBtoCgMnYQVttwTGHb1yRIDDAv0kE+EIM19aPpuCYz8v8+LCuZk+gzQAhubRSllEvtZIJS05VibF8Rq1IGKfOtxX7Fz8Kbb4t12SSOJMBAmB7BmvLG8oUHHPrLG+rlaXGAj1tUXAM4KAM1Vav4FhiW205WVBwDOCgDNRWv+BY4gbaouAYwCEZpi2tqlHa8msf3x61pZzi3tJXUhhHegYzNX3Or7bQFsCtGaUtsVKDLnixrbacSsy+L2griiljdnOB5KBoH/fSSOeyttgkAtyawY/kA7dfbXW1VRkkrcg0YiutLdXiuaAt6VxJCm0BbM3+2irVxiIr5HWNtig4BnAQdtHW5vQWQXcC2gLYGrR1Y9AWwNYcR1uBO5KXCCtOCm0BbMgxtAUAXwi0BQCTgbYAYDLQFgBMBtoCgMlAWwAwGWgLACYDbQHAZKAtAJgMtAUAk4G2AGAydtBWU3BM8thEJNP8Cvg3iQBfiOHaagqOfX94enoIWU6lrk86/hBtBgjJpZWyjHqplUxYcqpKjOUzakXCOHW+rdi/+FFo8225JpPEmQwQANszWFudgmOaVNrno/S0RcExgIMyVFvnCo55NtOWkwUFxwAOykBtSbb4IKsFbfk94qp08n1tUXAM4JAM05ZWVU9bvrRPdwl2BQva8msf3x61pZzi3tJXUhhHegYzNX3Or7bQFsCtGaWt8wXH/NlVD+MDjU2cSsy+L2griiljdnOB5KBoH/fSSOeyttgkAtyawY/kA3a19VlnOa7TVmWQtCLTiK20tlSL54K2pHMlKbQFsDX7ayv8NS4FBccA4By7aGtzeougOwFtAWwN2roxaAtga46jrcAdyUuEFSeFtgA25BjaAoAvBNoCgMlAWwAwGWgLACYDbQHAZKAtAJgMtAUAk4G2AGAy0BYATAbaAoDJQFsAMBk7aKsuOCa5mBMUHAOASwzXVlNwTCF5uCg4BgDnGaytywXHNtMWBccADspQbV0qOOaktmXlHgqOARySgdpaLjj2/SHVx/jEs61WWxQcAzgkw7SlVbW4SRR/5XI+H2BBW37t49ujtpRT3Fv6SgrjSM9gpqbP+dUW2gK4NaO0db7gWKasyD5EYxOnErPvC9qKYsqY3VwgOSjax7000rmsLTaJALdm8CP5wLlH8tsU0+9qqzJIWpFpxFZaW6rFc0Fb0rmSFNoC2Jr9tVUebDm2erbV0RYFxwAOwi7a2pzeIuhOQFsAW4O2bgzaAtia42grcEfyEmHFSaEtgA05hrYA4AuBtgBgMtAWAEwG2gKAyUBbADAZaAsAJgNtAcBkoC0AmAy0BQCTgbYAYDLQFgBMxg7aqguORSSbzfPKXPIA8IUYrq2FgmOSdevvx7UlMIaxmG9LF9SQY52Ey/UzmZ1b1LAm42Am/WPs8s+zhXDR0DP9G3KVDEN3zonAOo2SjKzMUGU9bLliVmkoO1U/pszNpH6Vu5QGsbexfrsjzMq2m9EqpKcePEys/QbrWXVyPcKdMVhbCwXHJBezE9bqyj3DUFLISJy/5wgp2srBX2Kmj6Qh1CkJc1ZV3ViCto4o6ekmEC+XZ2hlFLmiUc+84eKs/GTU2+2Eq7PxXsXjd11gKaP7CL070Kf01B+w9w1Kz9yhe4vgvhiqrYWCY/LSl0ecV1uvL2/voT2GmQ3+OvY0VRyml1oQXny+Ty9oQ89QSK3M0IRiotu4Vlv9WeXGQDVhMwF93VBRyU2+nt6ntVV9Zb1vMHwu/6nNB4R7ZaC2lgqOybYx1MKYQ1uFEN4hzl2Q+JddbZ0LhloTMZj1W9yY8VhCsRDiOfZ040ifEpbSLpgg7zW6K1rMfAzLs4oDlsZAbRmZXtSQ/uBSczd+FiMpP6Bp6d2BPv7Sr/WAvW8wtZ/e5D9qtnCnDNOWVpU+1qpaqy0XAAn1G1XRWH6d3Ub9U86/2sXG+s/qFH4uwNypGGZWRjraa2xPP8OkrUx+b20BIQ3u5ube2Mww3BxziaoxXjFSz8ewPKtE9TGbCcsIfnzlIzVn199evaet68ySZtVqq/4GA/6e2M63+AmZe9ifCVxilLaWCo45U7WsLIQxgN6PPse5ixPZrHW0VceeporD9DLJyNIL2tJT1iwvnRn2YzU3flBbZ2YlBxctEy6nLurfpVCTaW9d7w70iT3FMuqzd29FwN4HuGMGP5IPVM+2MnNsEusffYlzd1Yezlfa8n+6nok0GTNFZjleoy0fePJ/B+qwrEI3kBttuH5GW26s/Jw+0JuwmEhuk7o/akz3Unvq09oKB/kDoq0jgLY+hPzoCyHwdJy747Dc8AeRZQskxCCRFMDLgii0gpPjICM9geysbuOm2gqfRUa2UzVj5rskNB6Rs0VMPW0VzKkKPSt/RX+V3jcYQVvTsIu2AADWg7YAYDLQFgBMBtoCgMlAWwAwGWgLACYDbQHAZKAtAJgMtAUAU/Ht2/8B+g97HsubHCAAAAAASUVORK5CYII="></a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="setup"></a>Setup<a class="hash-link" href="#setup" title="Direct link to heading">#</a></h2><p>Add a masked and protected GitLab variable for each line in the private key, for example:</p><p><a target="_blank" href="/assets/files/masked-vars-ab75ab02f93f5937aaffe559407d3cff.png"><img src="/assets/images/masked-vars-ab75ab02f93f5937aaffe559407d3cff.png"></a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="the-code"></a>The Code<a class="hash-link" href="#the-code" title="Direct link to heading">#</a></h2><p>Add the following block to your <code>.gitlab-ci.yml</code> file:</p><iframe width="100%" frameborder="0" id="gist-b5260f14ecc0bf0d080c80297d0b475c"></iframe><p>now within Jobs in your pipeline you can simply do this to clone, push or pull from a remote GitLab repo:</p><iframe width="100%" frameborder="0" id="gist-c96e211544f7cb4ef3ca4e90dc8e36e3"></iframe><p>as mentioned not pretty, but effective and no other cleaner options as I could seeâ€¦</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/ci">ci</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gitlab">gitlab</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/gitlab-ci">gitlab-ci</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/private-keys">private-keys</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/secrets">secrets</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/2"><div class="pagination-nav__label">Older Entries Â»</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a href="https://infraql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>InfraQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"></div></div></footer></div>
<script src="/assets/js/runtime~main.f77b1e72.js"></script>
<script src="/assets/js/main.508de973.js"></script>
</body>
</html>